<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="xuanxu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/02/jit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/02/jit/" class="post-title-link" itemprop="url">JIT编译器优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-04-02 05:19:51 / 修改时间：17:42:59" itemprop="dateCreated datePublished" datetime="2023-04-02T05:19:51+08:00">2023-04-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>为了优化Java的性能 ，JVM在解释器之外引入了即时（Just In Time）编译器：当程序运行时，解释器首先发挥作用，代码可以直接执行。当程序运行时，JIT编译器再编译代码，获取更高的运行效率。</p>
<p>这篇文章来记录下JIT编译器的工作过程以及一些优化的把戏。本文章中大部分的知识都是来自这个视频中的内容，我学习之后将他们记录下来。</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV14s4y1t7mu/?vd_source=f8140c020b01234facdbeb7d2d28b261">理解 JVM 中 JIT 玩的把戏_1_哔哩哔哩_bilibili</a></p>
<h1 id="JIT分层编译"><a href="#JIT分层编译" class="headerlink" title="JIT分层编译"></a>JIT分层编译</h1><p>Java 8引入了分层编译的概念，分层编译将JVM的执行状态分为了五个层次。五个层级分别是：</p>
<ol>
<li><p>解释执行。</p>
</li>
<li><p>执行不带profiling的C1代码。</p>
</li>
<li><p>执行仅带方法调用次数以及循环回边执行次数profiling的C1代码。</p>
</li>
<li><p>执行带所有profiling的C1代码。</p>
</li>
<li><p>执行C2代码。</p>
</li>
</ol>
<p>第一阶段就是解释执行，第二阶段是C1编译，C1拥有三个模式，也就是2,3,4，最后是C2编译。</p>
<p>C1第一个模式，仅仅是编译执行，代码中没有任何埋点进行profiling的地方。</p>
<p>C1第二个模式，是编译加上一个counter计数器，当计数器达到阈值将会到达C2。</p>
<p>C1第三个模式，是编译加上所有的profiling，进行详细分析。比如某个分支，永远是true，或者某一个接口方法的调用，只使用过一种类型（比如List的add方法，实际上永远是ArrayList)，或者某个强制转换从未失败，某个调用从来没有产生过NEP异常。</p>
<p>在一般情况下，代码从解释执行到C1，会直接到C1的第三个模式，最后达到C2。</p>
<p>在C2忙的时候，也就是说C2拥有很多方法需要编译，队列中有很多待处理的任务时，代码会先达到C1的第二个模式，再达到C1的第三个模式，以此来减少C2的执行时间。在C1第三个模式下，如果profiling没有收集到有价值的数据，那么jvm会断定C2编译并没有比C1好很多。因此将会直接到C1的第一个模式。</p>
<p>在C1忙的时候也有可能直接达到C2，在解释过程中进行profiling，然后直接由C2编译。</p>
<h1 id="Uncommon-Trap"><a href="#Uncommon-Trap" class="headerlink" title="Uncommon Trap"></a>Uncommon Trap</h1><p>比如ArrayStream的forEach方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ArrayStream&lt;E&gt;.forEach(Consumer&lt;? <span class="built_in">super</span> E&gt; action) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.elementData.length(), i++) &#123;</span><br><span class="line">        action.accept(<span class="built_in">this</span>.elementData[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，jvm为了保证代码的安全性，必须在代码中添加安全检查，因此，代码变成了下面这样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ArrayStream&lt;E&gt;.forEach(Consumer&lt;? <span class="built_in">super</span> E&gt; action) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span> == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NPE</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.elementData == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NPE</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.elementData.length(), i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NPE</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.elementData == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NPE</span>();</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AIOBE</span>();</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= <span class="built_in">this</span>.elementData.length) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AIOBE</span>();</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NPE</span>();</span><br><span class="line">        action.accept(<span class="built_in">this</span>.elementData[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先可以去掉的就是对this的检查，因为在对象的方法体中，this不可能为null。</p>
<p>其次，由于i从0开始，并且this.elementData.length()不可能大于Integer.MAX，且i递增每次+1，所以，i不可能小于0。因此 i &lt; 0被去掉了。</p>
<p>接着，对于 i &gt;= this.elementData.length，编译器将它优化为了 !(i &lt; this.elementData.length) ，这样，在上面的for循环中已经判断了一次 i &lt;this.elementData.length，在这个检查中只需要将上面计算的结果进行取反。也就是公共表达式消除。</p>
<p>到这里，我们只剩下了，最开始的elementData == null的检查，循环中的elementData == null的检查，以及循环中的action == null的检查。</p>
<p>这三个null检查是无法消除的，因此对于无法消除的null检查，我们就需要将检查的开销将到最低。</p>
<p>因此，在编译时，检查elementData == null将会被直接消除，然后jvm会注册一个sig_fault handler，当出现了elementData为null的时候，jvm不会直接崩溃，而是会进入trap，通过操作系统调用段错误处理器，然后再抛出一个NPE异常。</p>
<p>这样的优化比起直接新建一个分支来判断会快很多。前提是，这个elementData并不是null。类似于jvm断言这里肯定不会产生NPE异常，但是一旦产生null，就会陷入trap，然后去优化，整体就会变慢。</p>
<h1 id="循环剥离"><a href="#循环剥离" class="headerlink" title="循环剥离"></a>循环剥离</h1><p>在上面的null判断中，除了使用trap，还有一种方法，也就是将第一次循环剥离出来。</p>
<p>这时，代码变成了下面这样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ArrayStream.forEach(Consumer&lt;? <span class="built_in">super</span> E&gt; action) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.elementData == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NPE</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &lt; <span class="built_in">this</span>.elementData.length()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.elementData == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NPE</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (action == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NPE</span>();</span><br><span class="line">        action.accept(<span class="built_in">this</span>.elementData[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="built_in">this</span>.elementData.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.elementData == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NPE</span>();</span><br><span class="line">        action.accept(<span class="built_in">this</span>.elementData[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们让action的null检查从n次变成了一次。</p>
<h1 id="方法内联"><a href="#方法内联" class="headerlink" title="方法内联"></a>方法内联</h1><p>方法内联很简单，本质就是将被调用的方法的代码复制到调用者的方法体里，这样就消除了一次调用。</p>
<p>比如遍历elementData，将每一个元素传入一个consume方法，该方法将传入的每一个数字加到sum上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    sum += x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>采用for循环的话有三种方式。</p>
<p>第一种就是简单的获取this.elementData并遍历</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.elementData.length(); i++) &#123;</span><br><span class="line">    consume(<span class="built_in">this</span>.elementData[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二种方法和第一种有一点不同，我们将this.elementData用一个局部变量保存起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">E[] elementData = <span class="built_in">this</span>.elementData;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; elementData.length(); i++) &#123;</span><br><span class="line">    consume(elementData[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三种方式是使用Java的增强for循环</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i : <span class="built_in">this</span>.elementData) &#123;</span><br><span class="line">    consume(elementData[x]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在consume方法内联的情况下，三个函数的执行效率都差不多。</p>
<p>但是，在不内联的情况下，第一种方式就比第二和第三种慢了许多。</p>
<p>原因在于，第一种在每一次循环都需要重新加载elementData，因为elementData可能被修改。</p>
<p>第二种方法使用了局部变量，因为局部变量是无法被修改的，所以不需要被重新加载。</p>
<p>第三种方法其实和第二种本质上没有什么差别，增强for循环也会创建一个局部变量。</p>
<p>但是对于虚函数，由于会有不同的实现类，那么又该如何内联呢。</p>
<h1 id="去虚拟化"><a href="#去虚拟化" class="headerlink" title="去虚拟化"></a>去虚拟化</h1><p>在Java中，除了private函数以及final修饰的函数，几乎所有的对象函数都是虚函数。虚函数是实现多态的基础。</p>
<p>每次调用虚函数，我们都要去找到对应的真实类型的函数，并进行调用。那么要怎么样才能去除虚函数的开销呢。</p>
<p>首先是静态分析。</p>
<p>假设有这样一个函数apply，接受一个Function参数，和一个int类型的参数，然后在函数内调用func.apply(x)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">double</span> <span class="title function_">apply</span><span class="params">(Function func, <span class="type">int</span> x)</span> &#123;</span><br><span class="line">    func.apply(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在main函数中调用apply</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Monomorphic</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Function</span> <span class="variable">func</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Square</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20_000</span>; ++i) &#123;</span><br><span class="line">            apply(func, i);</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们查看编译的日志</p>
<p><img src="https://i.328888.xyz/2023/04/02/iHpJ23.jpeg" alt="iHpJ23.jpeg"></p>
<p>就会发现，编译器将先将apply函数内联进了main函数，然后直接将Square的apply内联进了Monomorphic的apply函数。</p>
<p>这里JIT使用了一个封闭世界的假设，它发现现在整个jvm中只有一个Function的实例，也就是Square，其他的实现了Function接口的类可能存在，但是现在还没有被加载。</p>
<p>如果我们在这时加载了一个其他的类，比如Sqrt。这时实现了Function接口的类就不只有Square了，还存在Sqrt。这时，上面的假设就不成立了。</p>
<p>因此这时，前面的编译将会失效，因为它直接内联了Square的apply函数。jvm将会立刻去优化。</p>
<p>在这时，C2编译器将会被锁住，所有的线程将会返回到解释模式，性能将会大幅下降。</p>
<p>这时，虚拟机将会开始收集调用的信息，被称为类型采样分析，这些信息由C1或者解释器收集。</p>
<p>虚拟机将会收集每个Function的实现类被调用了几次，从哪里调用。</p>
<p>假如在20000次Function.apply调用中，有19000次都是Square.apply，只有1000次是Sqrt.apply。这时JIT就可以基于这些信息开始编译。</p>
<p>这次编译并不会像之前那样直接内联Square和Sqrt的apply函数。而是会加上类型检查。</p>
<p>这时，代码将会在变成类似下方这样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (func.getClass().equals(Square.class)) &#123;</span><br><span class="line">    <span class="comment">// 内联Square的apply函数</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (func.getClass().equals(Sqrt.class)) &#123;</span><br><span class="line">    <span class="comment">// 内联Sqrt的apply函数</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    uncommon_trap()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于为什么不在else后面直接放虚函数调用，而还是加上一个uncommon trap。这时由于如果加上虚函数调用，那么在那个虚函数中又有可能会出现修改变量的行为，导致之前编译的代码出现问题。虚函数调用可以使用反射，反射可以修改几乎任何东西。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这里只写了JIT优化的很少一部分，还有很多其他的东西都没有写，比如GC是如何实现Stop The World的，GC如何与编译后的函数交互等等。</p>
<p>从这里可以看出，Java很喜欢小方法和局部变量，很喜欢不变的东西，常量。Java也并不喜欢原生方法，因为Java虚拟机无法知晓native函数中具体做了什么，也无法优化，并且有可能导致崩溃。除非是intrinsic函数，也就是在jvm中有特殊实现的函数。</p>
<p>因此，写Java代码应该保持函数尽可能的小，当函数字节码大小超过8000字节之后，JIT就不会对该函数进行优化。JIT将会将各个小函数内联起来并进行优化。不应该一直抛出异常，因为异常可能会导致编译优化失效。变量应该尽量使用局部变量，因为局部变量的不变性使得他们更容易被优化。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/30/fileMonitor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/30/fileMonitor/" class="post-title-link" itemprop="url">另一种文件监控的方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-03-30 06:14:00 / 修改时间：15:19:28" itemprop="dateCreated datePublished" datetime="2023-03-30T06:14:00+08:00">2023-03-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="通过USN日志进行文件监控"><a href="#通过USN日志进行文件监控" class="headerlink" title="通过USN日志进行文件监控"></a>通过USN日志进行文件监控</h1><p>在以前的文章中有一篇是自己实现一个Everything，其中讲了通过readDirectChanges函数进行文件监控并同步的方法。但是这样的方法在监控整个磁盘时好像会漏掉一些文件。</p>
<p>下面介绍另一种方法，通过读取USN日志来进行文件的监控。</p>
<p>代码已经开源到GitHub，之前的ReadDirectoryChanges API的版本也有保存。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/XUANXUQAQ/File-Engine/tree/master/C%2B%2B/fileMonitor">File-Engine/C++/fileMonitor at master · XUANXUQAQ/File-Engine (github.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/XUANXUQAQ/File-Engine/tree/master/C%2B%2B/fileMonitorReadDirChanges">File-Engine/C++/fileMonitorReadDirChanges at master · XUANXUQAQ/File-Engine (github.com)</a></p>
<p>代码以及资料参考自</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/38885286/usn-nfts-change-notification-event-interrupt">windows - USN NFTS change notification event interrupt - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7421440/how-can-i-detect-only-deleted-changed-and-created-files-on-a-volume/7459109#7459109">c++ - How can I detect only deleted, changed, and created files on a volume? - Stack Overflow</a></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/fileio/obtaining-directory-change-notifications">Obtaining Directory Change Notifications - Win32 apps | Microsoft Learn</a></p>
<p>在微软官网这篇文章中，详细写了如何获取文件夹的变化通知。</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/fileio/change-journals">Change Journals - Win32 apps | Microsoft Learn</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/bb742450(v=technet.10)">Keeping an Eye on Your NTFS Drives: the Windows 2000 Change Journal Explained | Microsoft Learn</a></p>
<p>这里详细介绍了NTFS的usn日志是什么，以及usn日志的数据结构等。</p>
<p>简单来说，每当一个文件进行变动，都会写入usn日志。我们可以通过监控是否有新的usn日志记录写入来判断是否有文件更改，并进行监控。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="定义监控类"><a href="#定义监控类" class="headerlink" title="定义监控类"></a>定义监控类</h3><p>首先定义一个NTFSChangesWatcher类</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NTFSChangesWatcher</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">NTFSChangesWatcher</span>(<span class="type">char</span> drive_letter);</span><br><span class="line">    ~<span class="built_in">NTFSChangesWatcher</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Method which runs an infinite loop and waits for new update sequence number in a journal.</span></span><br><span class="line">    <span class="comment">// The thread is blocked till the new USN record created in the journal.</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">WatchChanges</span><span class="params">(<span class="type">const</span> <span class="type">bool</span>* flag, <span class="type">void</span>(*)(<span class="type">const</span> std::u16string&amp;), <span class="type">void</span>(*)(<span class="type">const</span> std::u16string&amp;))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function">HANDLE <span class="title">OpenVolume</span><span class="params">(<span class="type">char</span> drive_letter)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">CreateJournal</span><span class="params">(HANDLE volume)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">LoadJournal</span><span class="params">(HANDLE volume, USN_JOURNAL_DATA* journal_data)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">WaitForNextUsn</span><span class="params">(PREAD_USN_JOURNAL_DATA read_journal_data)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::unique_ptr&lt;READ_USN_JOURNAL_DATA&gt; <span class="title">GetWaitForNextUsnQuery</span><span class="params">(USN start_usn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">ReadJournalRecords</span><span class="params">(PREAD_USN_JOURNAL_DATA journal_query, LPVOID buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">        DWORD&amp; byte_count)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">USN <span class="title">ReadChangesAndNotify</span><span class="params">(USN low_usn, <span class="type">char</span>* buffer, <span class="type">void</span>(*)(<span class="type">const</span> std::u16string&amp;), <span class="type">void</span>(*)(<span class="type">const</span> std::u16string&amp;))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::unique_ptr&lt;READ_USN_JOURNAL_DATA&gt; <span class="title">GetReadJournalQuery</span><span class="params">(USN low_usn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">showRecord</span><span class="params">(std::u16string&amp; full_path, USN_RECORD* record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> drive_letter_;</span><br><span class="line"></span><br><span class="line">    HANDLE volume_;</span><br><span class="line"></span><br><span class="line">    std::unique_ptr&lt;USN_JOURNAL_DATA&gt; journal_;</span><br><span class="line"></span><br><span class="line">    DWORDLONG journal_id_;</span><br><span class="line"></span><br><span class="line">    USN last_usn_;</span><br><span class="line"></span><br><span class="line">    USN max_usn_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Flags, which indicate which types of changes you want to listen.</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> FILE_CHANGE_BITMASK;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> kBufferSize;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>对外的接口函数为WatchChanges</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">WatchChanges</span><span class="params">(<span class="type">const</span> <span class="type">bool</span>* flag, <span class="type">void</span>(*)(<span class="type">const</span> std::u16string&amp;), <span class="type">void</span>(*)(<span class="type">const</span> std::u16string&amp;))</span></span>;</span><br></pre></td></tr></table></figure>

<p>函数有三个参数，第一个为停止监控文件标志，当设置为false将会退出循环。第二个参数为当新增文件时的回调函数指针，第三个参数为删除文件时的回调函数指针。</p>
<h3 id="初始化USN日志"><a href="#初始化USN日志" class="headerlink" title="初始化USN日志"></a>初始化USN日志</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> NTFSChangesWatcher::kBufferSize = <span class="number">1024</span> * <span class="number">1024</span> / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> NTFSChangesWatcher::FILE_CHANGE_BITMASK = USN_REASON_RENAME_NEW_NAME | USN_REASON_RENAME_OLD_NAME;</span><br><span class="line"></span><br><span class="line">NTFSChangesWatcher::<span class="built_in">NTFSChangesWatcher</span>(<span class="type">char</span> drive_letter) :</span><br><span class="line">    <span class="built_in">drive_letter_</span>(drive_letter)</span><br><span class="line">&#123;</span><br><span class="line">    volume_ = <span class="built_in">OpenVolume</span>(drive_letter_);</span><br><span class="line"></span><br><span class="line">    journal_ = std::<span class="built_in">make_unique</span>&lt;USN_JOURNAL_DATA&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="type">const</span> <span class="type">bool</span> res = <span class="built_in">LoadJournal</span>(volume_, journal_.<span class="built_in">get</span>()); !res) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Failed to load journal&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    max_usn_ = journal_-&gt;MaxUsn;</span><br><span class="line">    journal_id_ = journal_-&gt;UsnJournalID;</span><br><span class="line">    last_usn_ = journal_-&gt;NextUsn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先通过OpenVolume打开磁盘，并返回一个HANDLE，然后分配存储日志的内存空间，接着通过LoadJournal读取usn日志。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">NTFSChangesWatcher::OpenVolume</span><span class="params">(<span class="type">const</span> <span class="type">char</span> drive_letter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">wchar_t</span> pattern[<span class="number">10</span>] = <span class="string">L&quot;\\\\?\\a:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    pattern[<span class="number">4</span>] = <span class="built_in">static_cast</span>&lt;<span class="type">wchar_t</span>&gt;(drive_letter);</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> HANDLE volume = <span class="built_in">CreateFile</span>(</span><br><span class="line">        pattern, <span class="comment">// lpFileName</span></span><br><span class="line">        <span class="comment">// also could be | FILE_READ_DATA | FILE_READ_ATTRIBUTES | SYNCHRONIZE</span></span><br><span class="line">        GENERIC_READ | GENERIC_WRITE | SYNCHRONIZE, <span class="comment">// dwDesiredAccess</span></span><br><span class="line">        FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE, <span class="comment">// share mode</span></span><br><span class="line">        <span class="literal">nullptr</span>, <span class="comment">// default security attributes</span></span><br><span class="line">        OPEN_EXISTING, <span class="comment">// disposition</span></span><br><span class="line">        <span class="comment">// It is always set, no matter whether you explicitly specify it or not. This means, that access</span></span><br><span class="line">        <span class="comment">// must be aligned with sector size so we can only read a number of bytes that is a multiple of the sector size.</span></span><br><span class="line">        FILE_FLAG_NO_BUFFERING, <span class="comment">// file attributes</span></span><br><span class="line">        <span class="literal">nullptr</span> <span class="comment">// do not copy file attributes</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (volume == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="comment">// An error occurred!</span></span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Failed to open volume&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> volume;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取HANDLE后，通过LoadJournal获取USN日志，第一次读取失败将会尝试创建后再次尝试读取。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">NTFSChangesWatcher::LoadJournal</span><span class="params">(HANDLE volume, USN_JOURNAL_DATA* journal_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    DWORD byte_count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try to open journal.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">DeviceIoControl</span>(volume,</span><br><span class="line">        FSCTL_QUERY_USN_JOURNAL,</span><br><span class="line">        <span class="literal">nullptr</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        journal_data,</span><br><span class="line">        <span class="built_in">sizeof</span>(*journal_data),</span><br><span class="line">        &amp;byte_count,</span><br><span class="line">        <span class="literal">nullptr</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// If failed (for example, in case journaling is disabled), create journal and retry.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">CreateJournal</span>(volume)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">LoadJournal</span>(volume, journal_data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">NTFSChangesWatcher::CreateJournal</span><span class="params">(HANDLE volume)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    DWORD byte_count;</span><br><span class="line">    CREATE_USN_JOURNAL_DATA create_journal_data&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> ok = <span class="built_in">DeviceIoControl</span>(volume, <span class="comment">// handle to volume</span></span><br><span class="line">        FSCTL_CREATE_USN_JOURNAL,     <span class="comment">// dwIoControlCode</span></span><br><span class="line">        &amp;create_journal_data,         <span class="comment">// input buffer</span></span><br><span class="line">        <span class="built_in">sizeof</span>(create_journal_data),  <span class="comment">// size of input buffer</span></span><br><span class="line">        <span class="literal">nullptr</span>,                         <span class="comment">// lpOutBuffer</span></span><br><span class="line">        <span class="number">0</span>,                            <span class="comment">// nOutBufferSize</span></span><br><span class="line">        &amp;byte_count,                  <span class="comment">// number of bytes returned</span></span><br><span class="line">        <span class="literal">nullptr</span>) != <span class="number">0</span>;                   <span class="comment">// OVERLAPPED structure</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">        <span class="comment">// An error occurred!</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ok;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="开始监控"><a href="#开始监控" class="headerlink" title="开始监控"></a>开始监控</h3><p>初始化完成之后就可以调用WatchChanges函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">NTFSChangesWatcher::WatchChanges</span><span class="params">(<span class="type">const</span> <span class="type">bool</span>* flag,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>(*file_added_callback_func)(<span class="type">const</span> std::u16string&amp;),</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>(*file_removed_callback_func)(<span class="type">const</span> std::u16string&amp;))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> u_buffer = std::<span class="built_in">make_unique</span>&lt;<span class="type">char</span>[]&gt;(kBufferSize);</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> read_journal_query = <span class="built_in">GetWaitForNextUsnQuery</span>(last_usn_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (*flag) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// This function does not return until new USN record created.</span></span><br><span class="line">        <span class="built_in">WaitForNextUsn</span>(read_journal_query.<span class="built_in">get</span>());</span><br><span class="line">        last_usn_ = <span class="built_in">ReadChangesAndNotify</span>(read_journal_query-&gt;StartUsn,</span><br><span class="line">            u_buffer.<span class="built_in">get</span>(),</span><br><span class="line">            file_added_callback_func,</span><br><span class="line">            file_removed_callback_func);</span><br><span class="line">        read_journal_query-&gt;StartUsn = last_usn_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心的方法就两个，一个WaitForNextUsn，一个ReadChangesAndNotify</p>
<p>首先来看WaitForNextUsn</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">NTFSChangesWatcher::WaitForNextUsn</span><span class="params">(PREAD_USN_JOURNAL_DATA read_journal_data)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    DWORD bytes_read;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function does not return until new USN record created.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> ok = <span class="built_in">DeviceIoControl</span>(volume_,</span><br><span class="line">        FSCTL_READ_USN_JOURNAL,</span><br><span class="line">        read_journal_data,</span><br><span class="line">        <span class="built_in">sizeof</span>(*read_journal_data),</span><br><span class="line">        &amp;read_journal_data-&gt;StartUsn,</span><br><span class="line">        <span class="built_in">sizeof</span>(read_journal_data-&gt;StartUsn),</span><br><span class="line">        &amp;bytes_read,</span><br><span class="line">        <span class="literal">nullptr</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> ok;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过DeviceIoControl函数，发送FSCTL_READ_USN_JOURNAL事件，由于我们之前初始化的时候设置了从最后一个usn记录开始读取，这时该方法将会阻塞直到用户进行操作，NTFS写入一个新的USN日志。</p>
<p>这里的最后一个参数lpOverlapped必须为NULL，因为我们要监控文件的变化，需要阻塞函数，如果是异步调用反而会有各种各样的不方便。</p>
<p>关于DeviceIoControl函数网上已经有很多解释，这里就放个msdn吧。</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl function (ioapiset.h) - Win32 apps | Microsoft Learn</a></p>
<p>以及FSCTL_READ_USN_JOURNAL</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_read_usn_journal">FSCTL_READ_USN_JOURNAL - Win32 apps | Microsoft Learn</a></p>
<p>当该方法返回后，代表磁盘中出现了一个新的usn记录，这时就会执行到下一个函数</p>
<p>ReadChangesAndNotify</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">USN <span class="title">NTFSChangesWatcher::ReadChangesAndNotify</span><span class="params">(USN low_usn,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>(*file_added_callback_func)(<span class="type">const</span> std::u16string&amp;),</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>(*file_removed_callback_func)(<span class="type">const</span> std::u16string&amp;))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    DWORD byte_count;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> journal_query = <span class="built_in">GetReadJournalQuery</span>(low_usn);</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, kBufferSize);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ReadJournalRecords</span>(journal_query.<span class="built_in">get</span>(), buffer, byte_count))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// An error occurred.</span></span><br><span class="line">        <span class="keyword">return</span> low_usn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> record = <span class="built_in">reinterpret_cast</span>&lt;USN_RECORD*&gt;(<span class="built_in">reinterpret_cast</span>&lt;USN*&gt;(buffer) + <span class="number">1</span>);</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> record_end = <span class="built_in">reinterpret_cast</span>&lt;USN_RECORD*&gt;(<span class="built_in">reinterpret_cast</span>&lt;BYTE*&gt;(buffer) + byte_count);</span><br><span class="line"></span><br><span class="line">    std::u16string full_path;</span><br><span class="line">    <span class="keyword">for</span> (; record &lt; record_end;</span><br><span class="line">        record = <span class="built_in">reinterpret_cast</span>&lt;USN_RECORD*&gt;(<span class="built_in">reinterpret_cast</span>&lt;BYTE*&gt;(record) + record-&gt;RecordLength)) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> reason = record-&gt;Reason;</span><br><span class="line">        full_path.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="comment">// It is really strange, but some system files creating and deleting at the same time.</span></span><br><span class="line">        <span class="keyword">if</span> ((reason &amp; USN_REASON_FILE_CREATE) &amp;&amp; (reason &amp; USN_REASON_FILE_DELETE))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((reason &amp; USN_REASON_FILE_CREATE) &amp;&amp; (reason &amp; USN_REASON_CLOSE)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">showRecord</span>(full_path, record);</span><br><span class="line">            <span class="built_in">file_added_callback_func</span>(full_path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((reason &amp; USN_REASON_FILE_DELETE) &amp;&amp; (reason &amp; USN_REASON_CLOSE)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">showRecord</span>(full_path, record);</span><br><span class="line">            <span class="built_in">file_removed_callback_func</span>(full_path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (reason &amp; FILE_CHANGE_BITMASK) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (reason &amp; USN_REASON_RENAME_OLD_NAME)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">showRecord</span>(full_path, record);</span><br><span class="line">                <span class="built_in">file_removed_callback_func</span>(full_path);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (reason &amp; USN_REASON_RENAME_NEW_NAME)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">showRecord</span>(full_path, record);</span><br><span class="line">                <span class="built_in">file_added_callback_func</span>(full_path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;USN*&gt;(buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里ReadJournalRecords将会调用DeviceIoControl函数发送FSCTL_READ_USN_JOURNAL读出新的USN日志记录。</p>
<p>读取完成后，通过获取USN_RECORD中的reason字段，得到文件是创建，还是被删除。其实还有很多其他的USN_REASON，不过这里由于只需要检测文件变化，因此只监听了</p>
<ul>
<li><p>USN_REASON_FILE_CREATE</p>
</li>
<li><p>USN_REASON_FILE_DELETE</p>
</li>
<li><p>USN_REASON_RENAME_OLD_NAME</p>
</li>
<li><p>USN_REASON_RENAME_NEW_NAME</p>
</li>
</ul>
<p>所有的原因可以参考这里</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winioctl/ns-winioctl-usn_record_v2">USN_RECORD_V2 - Win32 apps | Microsoft Learn</a></p>
<h3 id="获取文件完整路径"><a href="#获取文件完整路径" class="headerlink" title="获取文件完整路径"></a>获取文件完整路径</h3><p>由于USN日志中记录的只有文件名和文件参照号，因此我们需要通过文件参照号和父文件参照号不断向上查询，拼接出完整的路径。</p>
<p>也就是上面的showRecord函数，该函数有两个参数，full_path，USN_RECORD指针类型的record，也就是需要拼接出完整路径的文件记录。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">NTFSChangesWatcher::showRecord</span><span class="params">(std::u16string&amp; full_path, USN_RECORD* record)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function"><span class="type">static</span> std::wstring <span class="title">sep_wstr</span><span class="params">(<span class="string">L&quot;\\&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> std::u16string <span class="title">sep</span><span class="params">(sep_wstr.begin(), sep_wstr.end())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> indexer_common::FileInfo <span class="title">file_info</span><span class="params">(*record, drive_letter_)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (full_path.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        full_path += file_info.<span class="built_in">GetName</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        full_path = file_info.<span class="built_in">GetName</span>() + sep + full_path;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD byte_count = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">auto</span> buffer = std::<span class="built_in">make_unique</span>&lt;<span class="type">char</span>[]&gt;(kBufferSize);</span><br><span class="line"></span><br><span class="line">    MFT_ENUM_DATA_V0 med;</span><br><span class="line">    med.StartFileReferenceNumber = record-&gt;ParentFileReferenceNumber;</span><br><span class="line">    med.LowUsn = <span class="number">0</span>;</span><br><span class="line">    med.HighUsn = max_usn_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">DeviceIoControl</span>(volume_,</span><br><span class="line">        FSCTL_ENUM_USN_DATA,</span><br><span class="line">        &amp;med,</span><br><span class="line">        <span class="built_in">sizeof</span>(med),</span><br><span class="line">        buffer.<span class="built_in">get</span>(),</span><br><span class="line">        kBufferSize,</span><br><span class="line">        &amp;byte_count,</span><br><span class="line">        <span class="literal">nullptr</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span>* parent_record = <span class="built_in">reinterpret_cast</span>&lt;USN_RECORD*&gt;(<span class="built_in">reinterpret_cast</span>&lt;USN*&gt;(buffer.<span class="built_in">get</span>()) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parent_record-&gt;FileReferenceNumber != record-&gt;ParentFileReferenceNumber)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="type">static</span> std::wstring <span class="title">colon_wstr</span><span class="params">(<span class="string">L&quot;:&quot;</span>)</span></span>;</span><br><span class="line">        <span class="function"><span class="type">static</span> std::u16string <span class="title">colon</span><span class="params">(colon_wstr.begin(), colon_wstr.end())</span></span>;</span><br><span class="line">        std::string drive;</span><br><span class="line">        drive += drive_letter_;</span><br><span class="line">        <span class="keyword">auto</span>&amp;&amp; w_drive = <span class="built_in">string2wstring</span>(drive);</span><br><span class="line">        <span class="function"><span class="type">const</span> std::u16string <span class="title">drive_u16</span><span class="params">(w_drive.begin(), w_drive.end())</span></span>;</span><br><span class="line">        full_path = drive_u16 + colon + sep + full_path;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">showRecord</span>(full_path, parent_record);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先获得文件名和父文件参照号，然后定义一个MFT_ENUM_DATA，由于MFT_ENUM_DATA_V1会报错Error 87，也就是<strong>ERROR_INVALID_PARAMETER</strong>，所以这里改成了MFT_ENUM_DATA_V0</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/debug/system-error-codes--0-499-">System Error Codes (0-499) (WinError.h) - Win32 apps | Microsoft Learn</a></p>
<p>将开始查询地址设置为record-&gt;ParentFileReferenceNumber，并将上界设置为最开始初始化的max_usn_。</p>
<p>然后调用DeviceIoControl，发送FSCTL_ENUM_USN_DATA事件，就可以读取出record的父文件夹的USN记录。</p>
<p>这时，将查询出的父文件夹记录再作为record进行递归查询。</p>
<p>不断向上查询，将文件名拼接到full_path中，最后找到顶层退出递归即可。</p>
<p>获得文件完整路径后，即可调用两个回调函数进行处理了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/18/GPU-Memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/18/GPU-Memory/" class="post-title-link" itemprop="url">对显存占用的监控（Windows系统）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-03-18 03:41:00 / 修改时间：12:47:30" itemprop="dateCreated datePublished" datetime="2023-03-18T03:41:00+08:00">2023-03-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前面说到了使用GPU加速文件搜索，但是会占用较多的显存，如果在打游戏，或者跑深度学习的情况下，并不会进行搜索，那么显存就被白白浪费掉了。因此如何实现显存的使用率监控，并实现检测到显存占用过多自动释放搜索缓存就成为了一个问题。</p>
<h3 id="CUDA方面"><a href="#CUDA方面" class="headerlink" title="CUDA方面"></a>CUDA方面</h3><p>在NVIDIA的文档中，有一个函数cudaMemGetInfo</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__host__​<span class="function">cudaError_t <span class="title">cudaMemGetInfo</span> <span class="params">( <span class="type">size_t</span>* free, <span class="type">size_t</span>* total )</span></span></span><br></pre></td></tr></table></figure>

<p>该方法可以直接获取GPU的空闲内存以及总内存。</p>
<p>但是经过实测，返回结果并不准确。因此并没有使用该方法。</p>
<h3 id="OpenCL方面"><a href="#OpenCL方面" class="headerlink" title="OpenCL方面"></a>OpenCL方面</h3><p>在OpenCL中没有可以获取GPU占用的函数，但是由于OpenCL可以通过cl_device::getInfo获取显卡的各项参数，因此可以通过OpenCL提供的拓展参数来获取。</p>
<p>比如AMD显卡的OpenCL扩展中就有一项</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CL_DEVICE_GLOBAL_FREE_MEMORY_AMD                0x4039</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过该方法即可获取AMD显卡的显存占用</span></span><br><span class="line">cl_device::getInfo&lt;CL_DEVICE_GLOBAL_FREE_MEMORY_AMD&gt;();</span><br></pre></td></tr></table></figure>

<p>AMD所有的OpenCL扩展在这里</p>
<p><a target="_blank" rel="noopener" href="https://registry.khronos.org/OpenCL/extensions/amd/cl_amd_device_attribute_query.txt">https://registry.khronos.org/OpenCL/extensions/amd/cl_amd_device_attribute_query.txt</a></p>
<p>不过这样也有一些问题，比如适配困难。现在Intel也推出了自家的独立显卡Arc系列，不同显卡的适配就成为了一个问题。因此该方法也没有采用。</p>
<h3 id="Windows任务管理器"><a href="#Windows任务管理器" class="headerlink" title="Windows任务管理器"></a>Windows任务管理器</h3><p>其实在Windows任务管理器中就可以看到显存的占用，因此如何获取这个数值就成为了问题的关键。</p>
<p><img src="https://i.imgtg.com/2023/03/18/l27CC.jpg" alt="l27CC.jpg"></p>
<p>在Windows的powershell中有这样的API</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-counter?view=powershell-7.3">Get-Counter (Microsoft.PowerShell.Diagnostics) - PowerShell | Microsoft Learn</a></p>
<p>通过Get-Counter可以实现获取系统中的各项参数。比如我们这里需要获取GPU相关的信息</p>
<p><img src="https://i.imgtg.com/2023/03/18/l2enL.jpg" alt="l2enL.jpg"></p>
<p>在Stack Overflow也找到了相同的解决方案</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/73476947/how-to-get-the-dedicated-gpu-memory-number-for-every-running-process-in-window">c++ - How to get the “Dedicated GPU memory” number for every running process in Windows (The same numbers that are shown in the Windows Task Manager) - Stack Overflow</a></p>
<p>由于powershell调用的效率太低，因此我们需要直接使用对应的Windows API，而不是重复调用powershell脚本。</p>
<p>也就是Windows API中的PDH函数</p>
<h3 id="PDH函数"><a href="#PDH函数" class="headerlink" title="PDH函数"></a>PDH函数</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/perfctrs/using-the-pdh-functions-to-consume-counter-data">Using the PDH Functions to Consume Counter Data - Win32 apps | Microsoft Learn</a></p>
<p>通过PdhOpenQuery函数打开一个查询，然后使用PdhAddCounter设置要查询的信息，最后使用PdhCollectQueryData获取信息，再使用PdhGetRawCounterArray进行转换，即可获取我们想要的显存占用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::unordered_map&lt;std::wstring, LONGLONG&gt; <span class="title">query_pdh_val</span><span class="params">(PDH_STATUS&amp; ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PDH_HQUERY query;</span><br><span class="line">    std::unordered_map&lt;std::wstring, LONGLONG&gt; memory_usage_map;</span><br><span class="line">    ret = <span class="built_in">PdhOpenQuery</span>(<span class="literal">nullptr</span>, <span class="literal">NULL</span>, &amp;query);</span><br><span class="line">    <span class="keyword">if</span> (ret != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> memory_usage_map;</span><br><span class="line">    &#125;</span><br><span class="line">    PDH_HCOUNTER counter;</span><br><span class="line">    ret = <span class="built_in">PdhAddCounter</span>(query, <span class="string">L&quot;\\GPU Adapter Memory(*)\\Dedicated Usage&quot;</span>, <span class="literal">NULL</span>, &amp;counter);</span><br><span class="line">    <span class="keyword">if</span> (ret != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> memory_usage_map;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = <span class="built_in">PdhCollectQueryData</span>(query);</span><br><span class="line">    <span class="keyword">if</span> (ret != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> memory_usage_map;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD bufferSize = <span class="number">0</span>;</span><br><span class="line">    DWORD itemCount = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">PdhGetRawCounterArray</span>(counter, &amp;bufferSize, &amp;itemCount, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">auto</span>&amp;&amp; lpItemBuffer = <span class="built_in">reinterpret_cast</span>&lt;PPDH_RAW_COUNTER_ITEM_W&gt;(<span class="keyword">new</span> <span class="type">char</span>[bufferSize]);</span><br><span class="line">    ret = <span class="built_in">PdhGetRawCounterArray</span>(counter, &amp;bufferSize, &amp;itemCount, lpItemBuffer);</span><br><span class="line">    <span class="keyword">if</span> (ret != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span>[] lpItemBuffer;</span><br><span class="line">        <span class="keyword">return</span> memory_usage_map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; itemCount; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span>&amp; [szName, RawValue] = lpItemBuffer[i];</span><br><span class="line">        memory_usage_map.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(szName, RawValue.FirstValue));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span>[] lpItemBuffer;</span><br><span class="line">    ret = <span class="built_in">PdhCloseQuery</span>(query);</span><br><span class="line">    <span class="keyword">return</span> memory_usage_map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的query_pdh_val()方法返回的是GPU的luid和显存占用的map。</p>
<p>和powershell返回的结果是相同的</p>
<p><img src="https://i.imgtg.com/2023/03/18/l2t1q.jpg" alt="l2t1q.jpg"></p>
<p>但是这里又出现了一个大问题，这些luid开头的东西是什么，和显卡是怎么进行对应的。</p>
<p>我们平时看到的显卡名都是像NVIDIA GeForce RTX 2060，AMD Radeon RX 5700XT这样</p>
<p><img src="https://i.imgtg.com/2023/03/18/l2vpx.jpg" alt="l2vpx.jpg"></p>
<p>powershell中返回的gpu adapter memory(luid_0x00000000_0xXXXXXXXX)到底是如何和显卡一一对应的仍然不清楚。</p>
<h3 id="GPU名称和luid的对应查询方案"><a href="#GPU名称和luid的对应查询方案" class="headerlink" title="GPU名称和luid的对应查询方案"></a>GPU名称和luid的对应查询方案</h3><p>在网上找了非常多的资料，都没有找到。最后是在翻看Windows DirectX API中偶然发现了在DXGI_ADAPTER_DESC结构体中有一个字段，名字就叫AdapterLuid</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">DXGI_ADAPTER_DESC</span> &#123;</span><br><span class="line">  WCHAR  Description[<span class="number">128</span>];</span><br><span class="line">  UINT   VendorId;</span><br><span class="line">  UINT   DeviceId;</span><br><span class="line">  UINT   SubSysId;</span><br><span class="line">  UINT   Revision;</span><br><span class="line">  SIZE_T DedicatedVideoMemory;</span><br><span class="line">  SIZE_T DedicatedSystemMemory;</span><br><span class="line">  SIZE_T SharedSystemMemory;</span><br><span class="line">  LUID   AdapterLuid;</span><br><span class="line">&#125; DXGI_ADAPTER_DESC;</span><br></pre></td></tr></table></figure>

<p>因此，只需要通过DirectX API将显卡和luid对应起来，再和前面的PDH函数查询出的信息进行对应，即可实现显卡和显存占用信息的对应。</p>
<p>具体的方法为如下：</p>
<p>创建DXGIFactory，这里由于是jni调用的，所以我抛出了一个Java的异常。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">CreateDXGIFactory</span>(__uuidof(IDXGIFactory), <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;p_dxgi_factory)) != S_OK)</span><br><span class="line">&#123;</span><br><span class="line">    env-&gt;<span class="built_in">ThrowNew</span>(env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/Exception&quot;</span>), <span class="string">&quot;Create dxgi factory failed.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后使用DXGIFactory遍历所有GPU，即可获取GPU名称和luid的对应关系</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (UINT i = <span class="number">0</span>;</span><br><span class="line">    p_dxgi_factory-&gt;<span class="built_in">EnumAdapters</span>(i, &amp;p_adapter) != DXGI_ERROR_NOT_FOUND;</span><br><span class="line">    ++i)</span><br><span class="line">&#123;</span><br><span class="line">    DXGI_ADAPTER_DESC adapter_desc;</span><br><span class="line">    p_adapter-&gt;<span class="built_in">GetDesc</span>(&amp;adapter_desc);</span><br><span class="line">    gpu_name_adapter_map.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(adapter_desc.Description, adapter_desc));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将对应关系保存至gpu_name_adapter_map中。</p>
<p>Luid有两个成员，一个是LowPart，一个是HighPart</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LUID</span> &#123;</span><br><span class="line">    DWORD LowPart;</span><br><span class="line">    LONG HighPart;</span><br><span class="line">&#125; LUID, *PLUID;</span><br></pre></td></tr></table></figure>

<p>在Windows系统中是高位在前，低位在后，因此通过下面的方法即可获取luid，n2hexstr()方法是数字转16进制字符串。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> I&gt;</span><br><span class="line"><span class="function">std::string <span class="title">n2hexstr</span><span class="params">(I w, <span class="type">size_t</span> hex_len = <span class="keyword">sizeof</span>(I) &lt;&lt; <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* digits = <span class="string">&quot;0123456789ABCDEF&quot;</span>;</span><br><span class="line">    <span class="function">std::string <span class="title">rc</span><span class="params">(hex_len, <span class="string">&#x27;0&#x27;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>, j = (hex_len - <span class="number">1</span>) * <span class="number">4</span>; i &lt; hex_len; ++i, j -= <span class="number">4</span>)</span><br><span class="line">        rc[i] = digits[w &gt;&gt; j &amp; <span class="number">0x0f</span>];</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span>&amp;&amp; luid_str = <span class="string">&quot;0x&quot;</span> + <span class="built_in">n2hexstr</span>(adapter_luid.HighPart) + <span class="string">&quot;_&quot;</span> + <span class="string">&quot;0x&quot;</span> + <span class="built_in">n2hexstr</span>(adapter_luid.LowPart);</span><br></pre></td></tr></table></figure>

<p>在我这台电脑上，例如想监控NVIDIA GeForce RTX 2060的显卡的显存占用。先通过gpu_name_adapter_map找到对应的luid，为0x00000000_0x00010fcf，然后调用query_pdh_val()函数获取所有显卡的显存占用，最后通过luid找出对应的显存占用即可。</p>
<p>至此，对显卡显存占用的查询监控方案结束。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/16/GPU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/16/GPU/" class="post-title-link" itemprop="url">GPU搜索加速原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-16 08:18:38" itemprop="dateCreated datePublished" datetime="2023-01-16T08:18:38+08:00">2023-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-17 12:48:45" itemprop="dateModified" datetime="2023-03-17T12:48:45+08:00">2023-03-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在File-Engine中为了加速文件搜索的速度，加入了GPU加速的功能。通过显卡来进行并行运算，大幅提高搜索的速度。<br>由于显卡可以进行大量的并行运算，而每一个文件都是独立的，进行字符串匹配并不会相互干扰，因此GPU非常适合用来加速搜索。</p>
<p>具体的实现方法如下。</p>
<h2 id="定义GPU加速接口"><a href="#定义GPU加速接口" class="headerlink" title="定义GPU加速接口"></a>定义GPU加速接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> file.engine.dllInterface.gpu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.function.BiConsumer;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IGPUAccelerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重置搜索的标志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">resetAllResultStatus</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进行搜索，每当有一个结果匹配后调用resultCollector</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchCase：有D F Full Case四种，分别代表只搜索文件夹(Directory)，只搜索文件(File)，全字匹配(Full)，大小写敏感(Case Sensitive)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isIgnoreCase 是否忽略大小写，当searchCase中存在case时该字段为true</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchText 原始搜索关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keywords 搜索关键字，将searchText用&quot;;&quot;切割得到</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keywordsLowerCase 搜索关键字，全小写字母，内容与keywords相同，但字母为全小写</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isKeywordPath 保存keywords中的关键字是路径判断还是文件名判断</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxResultNumber 最大匹配结果数量限制</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultCollector 有一个结果匹配后的回调方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">match</span><span class="params">(String[] searchCase,</span></span><br><span class="line"><span class="params">               <span class="type">boolean</span> isIgnoreCase,</span></span><br><span class="line"><span class="params">               String searchText,</span></span><br><span class="line"><span class="params">               String[] keywords,</span></span><br><span class="line"><span class="params">               String[] keywordsLowerCase,</span></span><br><span class="line"><span class="params">               <span class="type">boolean</span>[] isKeywordPath,</span></span><br><span class="line"><span class="params">               <span class="type">int</span> maxResultNumber,</span></span><br><span class="line"><span class="params">               BiConsumer&lt;String, String&gt; resultCollector)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断GPU加速是否可用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果可以进行GPU加速</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isGPUAvailableOnSystem</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断某一个缓存是否搜索完成</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果全部完成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isMatchDone</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取某一个缓存搜索完成后匹配的结果数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 匹配的结果数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">matchedNumber</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止搜索</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">stopCollectResults</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断缓存是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果至少保存了一个缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">hasCache</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断某一个缓存是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果缓存名为key的缓存存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCacheExist</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加缓存到GPU显存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> recordSupplier 字符串supplier，由GPU加速dll通过jni进行调用，防止字符串过多导致OOM</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initCache</span><span class="params">(String key, Supplier&lt;String&gt; recordSupplier)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向某个缓存添加数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> records 待添加的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addRecordsToCache</span><span class="params">(String key, Object[] records)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除某一个缓存中的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> records 待删除的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeRecordsFromCache</span><span class="params">(String key, Object[] records)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除某一个缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">clearCache</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除所有缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">clearAllCache</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存是否有效</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果缓存仍然有效，当addRecordsToCache()失败，表示当前缓存的空位已经不足，出现了数据丢失，缓存被标记为无效。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #addRecordsToCache(String, Object[]) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCacheValid</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取系统显存占用，用于在用户使用过多显存时释放缓存。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 内存占用百分比，数值从0-100</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getGPUMemUsage</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放所有资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取GPU设备名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> GPU设备名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] getDevices();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置使用的GPU设备，deviceNum为getDevices()返回的数组的下标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> deviceNum GPU设备id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果成功使用设备并初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">setDevice</span><span class="params">(<span class="type">int</span> deviceNum)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该接口定义了GPU加速的基本方法，以后如果有新的GPU计算框架可以用于加速，只需要重新实现这个接口即可。<br>目前，该接口有两个实现，分别使用CUDA和OpenCL来进行加速。然后采用一个统一的包装类GPUAccelerator进行管理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> file.engine.dllInterface.gpu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> file.engine.configs.AllConfigs;</span><br><span class="line"><span class="keyword">import</span> file.engine.event.handler.EventManagement;</span><br><span class="line"><span class="keyword">import</span> file.engine.event.handler.impl.stop.RestartEvent;</span><br><span class="line"><span class="keyword">import</span> file.engine.utils.RegexUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.function.BiConsumer;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">GPUAccelerator</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IGPUAccelerator gpuAccelerator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">CudaAccelerator</span> <span class="variable">cudaAccelerator</span> <span class="operator">=</span> CudaAccelerator.INSTANCE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">OpenclAccelerator</span> <span class="variable">openclAccelerator</span> <span class="operator">=</span> OpenclAccelerator.INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 之所以采用双重检验锁机制，是由于要实现懒加载，并且不能在加载类的时候进行加载</span></span><br><span class="line"><span class="comment">     * 由于在事务管理器扫描<span class="doctag">@EventRegister</span>和<span class="doctag">@EventListener</span>的阶段将会尝试加载所有类，此时配置中心还不可用</span></span><br><span class="line"><span class="comment">     * 因此采用getInstance()方法来实现懒加载，在BootSystem事件发出后再进行初始化。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isEnableGpuAccelerate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">record</span> <span class="title class_">IsEnabledWrapper</span><span class="params">(<span class="type">boolean</span> isEnableGpuAccelerate)</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> IsEnabledWrapper instance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> IsEnabledWrapper <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (IsEnabledWrapper.class) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                        instance = <span class="keyword">new</span> <span class="title class_">IsEnabledWrapper</span>(AllConfigs.getInstance().getConfigEntity().isEnableGpuAccelerate());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Category</span> &#123;</span><br><span class="line">        CUDA(<span class="string">&quot;cuda&quot;</span>), OPENCL(<span class="string">&quot;opencl&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> String category;</span><br><span class="line"></span><br><span class="line">        Category(String category) &#123;</span><br><span class="line">            <span class="built_in">this</span>.category = category;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.category;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> Category <span class="title function_">categoryFromString</span><span class="params">(String c)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;cuda&quot;</span> -&gt; CUDA;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;opencl&quot;</span> -&gt; OPENCL;</span><br><span class="line">                <span class="keyword">default</span> -&gt; <span class="literal">null</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...... GPU加速方法调用</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key: 设备名</span></span><br><span class="line"><span class="comment">     * value: [设备种类(cuda, opencl)];[设备id]</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getDevices</span><span class="params">()</span> &#123;</span><br><span class="line">        LinkedHashMap&lt;String, String&gt; deviceMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        getDeviceToMap(cudaAccelerator, deviceMap, Category.CUDA);</span><br><span class="line">        getDeviceToMap(openclAccelerator, deviceMap, Category.OPENCL);</span><br><span class="line">        <span class="keyword">return</span> deviceMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getDeviceToMap</span><span class="params">(IGPUAccelerator igpuAccelerator, HashMap&lt;String, String&gt; deviceMap, Category category)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (igpuAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">devices</span> <span class="operator">=</span> igpuAccelerator.getDevices();</span><br><span class="line">            <span class="keyword">if</span> (devices == <span class="literal">null</span> || devices.length == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; devices.length; ++i) &#123;</span><br><span class="line">                <span class="type">var</span> <span class="variable">deviceName</span> <span class="operator">=</span> devices[i];</span><br><span class="line">                <span class="keyword">if</span> (deviceName.isBlank()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!deviceMap.containsKey(deviceName)) &#123;</span><br><span class="line">                        deviceMap.put(deviceName, category + <span class="string">&quot;;&quot;</span> + i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setDevice</span><span class="params">(String deviceCategoryAndId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (gpuAccelerator != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 切换GPU设备重启生效，运行中不允许切换</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!IsEnabledWrapper.getInstance().isEnableGpuAccelerate()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (deviceCategoryAndId.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cudaAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">                cudaAccelerator.initialize();</span><br><span class="line">                <span class="keyword">if</span> (cudaAccelerator.setDevice(<span class="number">0</span>)) &#123;</span><br><span class="line">                    gpuAccelerator = cudaAccelerator;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (openclAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">                openclAccelerator.initialize();</span><br><span class="line">                <span class="keyword">if</span> (openclAccelerator.setDevice(<span class="number">0</span>)) &#123;</span><br><span class="line">                    gpuAccelerator = openclAccelerator;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] info = RegexUtil.semicolon.split(deviceCategoryAndId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">deviceCategory</span> <span class="operator">=</span> info[<span class="number">0</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> Integer.parseInt(info[<span class="number">1</span>]);</span><br><span class="line">        <span class="type">var</span> <span class="variable">category</span> <span class="operator">=</span> Category.categoryFromString(deviceCategory);</span><br><span class="line">        <span class="keyword">if</span> (category != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (category) &#123;</span><br><span class="line">                <span class="keyword">case</span> CUDA:</span><br><span class="line">                    <span class="keyword">if</span> (cudaAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">                        cudaAccelerator.initialize();</span><br><span class="line">                        <span class="keyword">if</span> (cudaAccelerator.setDevice(id)) &#123;</span><br><span class="line">                            gpuAccelerator = cudaAccelerator;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> OPENCL:</span><br><span class="line">                    <span class="keyword">if</span> (openclAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">                        openclAccelerator.initialize();</span><br><span class="line">                        <span class="keyword">if</span> (openclAccelerator.setDevice(id)) &#123;</span><br><span class="line">                            gpuAccelerator = openclAccelerator;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendRestartOnError0</span><span class="params">()</span> &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;GPU缓存出错，自动重启&quot;</span>);</span><br><span class="line">        EventManagement.getInstance().putEvent(<span class="keyword">new</span> <span class="title class_">RestartEvent</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="下面介绍CUDA加速。"><a href="#下面介绍CUDA加速。" class="headerlink" title="下面介绍CUDA加速。"></a>下面介绍CUDA加速。</h3><p>CUDA加速首先会加载cudaAccelerator.dll，如果加载成功，将会设置isCudaLoaded为true。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">CudaAccelerator</span> <span class="keyword">implements</span> <span class="title class_">IGPUAccelerator</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> isCudaLoaded;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.load(Path.of(<span class="string">&quot;user/cudaAccelerator.dll&quot;</span>).toAbsolutePath().toString());</span><br><span class="line">            isCudaLoaded = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsatisfiedLinkError | Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            isCudaLoaded = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="初始化过程"><a href="#初始化过程" class="headerlink" title="初始化过程"></a>初始化过程</h4><p>加载完成后，将会调用setDevice(int deviceId)来选择GPU并进行初始化。<br>首先会调用initialize()方法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     file_engine_dllInterface_gpu_CudaAccelerator</span></span><br><span class="line"><span class="comment"> * Method:    initialize</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_file_engine_dllInterface_gpu_CudaAccelerator_initialize</span></span></span><br><span class="line"><span class="function"><span class="params">(JNIEnv* env, jobject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">init_stop_signal</span>();</span><br><span class="line">    <span class="built_in">init_cuda_search_memory</span>();</span><br><span class="line">    <span class="built_in">init_str_convert</span>();</span><br><span class="line">    <span class="comment">//默认使用第一个设备,current_using_device=0</span></span><br><span class="line">    <span class="built_in">set_using_device</span>(current_using_device);</span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">GetJavaVM</span>(&amp;jvm) != JNI_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        env-&gt;<span class="built_in">ThrowNew</span>(env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/Exception&quot;</span>), <span class="string">&quot;get JavaVM ptr failed.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">set_jvm_ptr_in_kernel</span>(jvm);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CreateDXGIFactory</span>(__uuidof(IDXGIFactory), <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;p_dxgi_factory)) != S_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        env-&gt;<span class="built_in">ThrowNew</span>(env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/Exception&quot;</span>), <span class="string">&quot;create dxgi factory failed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    IDXGIAdapter* p_adapter = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">for</span> (UINT i = <span class="number">0</span>;</span><br><span class="line">        p_dxgi_factory-&gt;<span class="built_in">EnumAdapters</span>(i, &amp;p_adapter) != DXGI_ERROR_NOT_FOUND;</span><br><span class="line">        ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        DXGI_ADAPTER_DESC adapter_desc;</span><br><span class="line">        p_adapter-&gt;<span class="built_in">GetDesc</span>(&amp;adapter_desc);</span><br><span class="line">        gpu_name_adapter_map.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(adapter_desc.Description, adapter_desc));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先初始化停止搜索信号，当结果数量达到maxResults限制，停止信号将会被设置为true，在resetAllResultStatus()方法将会把停止信号重置为false。</p>
<p>随后将会初始化cuda相关内存，如存储搜索关键字，存储搜索过滤条件等。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_cuda_search_memory</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_search_case), <span class="built_in">sizeof</span>(<span class="type">int</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_search_text), MAX_PATH_LENGTH * <span class="built_in">sizeof</span>(<span class="type">char</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_keywords_length), <span class="built_in">sizeof</span>(<span class="type">size_t</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_is_keyword_path), <span class="built_in">sizeof</span>(<span class="type">bool</span>) * MAX_KEYWORDS_NUMBER), <span class="literal">true</span>,</span><br><span class="line">        <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_is_ignore_case), <span class="built_in">sizeof</span>(<span class="type">bool</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(</span><br><span class="line">        <span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_keywords), <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(MAX_PATH_LENGTH * MAX_KEYWORDS_NUMBER)),</span><br><span class="line">        <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(</span><br><span class="line">        <span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_keywords_lower_case), <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(MAX_PATH_LENGTH *</span><br><span class="line">            MAX_KEYWORDS_NUMBER)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后初始化字符串转换器，字符串转换器可以在CPU中实现字符串从UTF-8编码转换到GB2312编码，然后实现从中文字符串转换到拼音，实现拼音搜索。   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_str_convert</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">init_gbk2_utf16_2</span>();</span><br><span class="line">    <span class="built_in">init_gbk2_utf16_3</span>();</span><br><span class="line">    <span class="comment">// init_gbk2_utf16();</span></span><br><span class="line">    <span class="built_in">init_utf162_gbk</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化完成后将会获取jvm指针，用于在match方法开启cuda核函数后，使用多个线程收集处理结果，并将结果返回到Java虚拟机中。通过std::thread开启线程后用jvm指针使线程绑定到Java虚拟机从而调用Java方法。</p>
<p>最后初始化gpu_name_adapter，这是Windows中的directX API，在该项目中主要用于实现显存的监控，因此在此暂时不讨论。</p>
<p>到此初始化完成。</p>
<h4 id="添加缓存步骤"><a href="#添加缓存步骤" class="headerlink" title="添加缓存步骤"></a>添加缓存步骤</h4><p>接下来谈一下initCache方法初始化缓存。</p>
<p>首先看一下缓存的结构</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief 存储数据结构</span></span><br><span class="line"><span class="comment"> * remain_blank_num：当前dev_cache_str有多少空闲空间</span></span><br><span class="line"><span class="comment"> * record_num：当前有多少个record</span></span><br><span class="line"><span class="comment"> * record_hash：每个record的hash，用于判断重复</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> cache_data = <span class="keyword">struct</span> cache_data</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* dev_strs = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">size_t</span>* dev_str_addr = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">size_t</span>* str_length = <span class="literal">nullptr</span>;</span><br><span class="line">    std::<span class="type">atomic_uint64_t</span> remain_blank_num;</span><br><span class="line">    std::<span class="type">atomic_uint64_t</span> record_num;</span><br><span class="line">    std::mutex lock;</span><br><span class="line">    concurrency::concurrent_unordered_set&lt;<span class="type">size_t</span>&gt; record_hash;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief 缓存struct</span></span><br><span class="line"><span class="comment"> * str_data：数据struct</span></span><br><span class="line"><span class="comment"> * dev_output：字符串匹配后输出位置，下标与cache_data中一一对应，dev_output中数据为1代表匹配成功</span></span><br><span class="line"><span class="comment"> * is_cache_valid：数据是否有效</span></span><br><span class="line"><span class="comment"> * is_match_done：是否匹配全部完成 </span></span><br><span class="line"><span class="comment"> * is_output_done：是否已经存入容器 0 代表没有开始  1 代表正在收集  2代表完成</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> list_cache = <span class="keyword">struct</span> cache_struct</span><br><span class="line">&#123;</span><br><span class="line">    cache_data str_data;</span><br><span class="line">    <span class="type">char</span>* dev_output = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">size_t</span> dev_output_bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> is_cache_valid = <span class="literal">false</span>;</span><br><span class="line">    std::atomic_bool is_match_done;</span><br><span class="line">    std::atomic_int is_output_done;</span><br><span class="line">    <span class="type">unsigned</span> matched_number = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>缓存的添加首先会调用record_supplier方法，获取每一个记录，将他们全部读入std::vector中，然后将缓存保存进入显存。</p>
<p>CUDA和OpenCL保存的实现方式略有不同，由于OpenCL中不允许使用size_t，因此无法实现在GPU核函数中对显存寻址。所以OpenCL中每一个字符串的都是定长，长度被定义在constant.h中的MAX_PATH_LENGTH宏中。</p>
<p>CUDA版本的保存方式会更加省显存空间。保存方式如下：<br>在将所有记录读出后，将会记录总共需要的字节数，然后分配三块内存（即cache_data中的dev_strs，dev_str_addr，str_length）<br>其中两块在显存中，一块为保存字符串的空间，另一块保存每一个字符串在第一块显存中的偏移量。第三块内存为主机内存，保存第一块显存中每个字符串的长度。</p>
<p>这样保存相比OpenCL的定长字符串省下了很多空间，但是由于需要在GPU核函数中进行两次寻址，因此效率相对比较低。<br>最后初始化标志位，缓存初始化完成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     file_engine_dllInterface_gpu_CudaAccelerator</span></span><br><span class="line"><span class="comment"> * Method:    initCache</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;Ljava/util/function/Supplier;)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_file_engine_dllInterface_gpu_CudaAccelerator_initCache</span></span></span><br><span class="line"><span class="function"><span class="params">(JNIEnv* env, jobject, jstring key_jstring, jobject record_supplier)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> jclass supplier_class = env-&gt;<span class="built_in">GetObjectClass</span>(record_supplier);</span><br><span class="line">    <span class="type">const</span> jmethodID get_function = env-&gt;<span class="built_in">GetMethodID</span>(supplier_class, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;()Ljava/lang/Object;&quot;</span>);</span><br><span class="line">    std::vector&lt;std::string&gt; records_vec;</span><br><span class="line">    <span class="type">unsigned</span> record_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> total_bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> jobject record_from_supplier = env-&gt;<span class="built_in">CallObjectMethod</span>(record_supplier, get_function);</span><br><span class="line">        <span class="keyword">if</span> (record_from_supplier == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> jstring_val = <span class="built_in">reinterpret_cast</span>&lt;jstring&gt;(record_from_supplier);</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> record = env-&gt;<span class="built_in">GetStringUTFChars</span>(jstring_val, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">const</span> <span class="keyword">auto</span> record_len = <span class="built_in">strlen</span>(record); record_len &lt; MAX_PATH_LENGTH)</span><br><span class="line">        &#123;</span><br><span class="line">            records_vec.<span class="built_in">emplace_back</span>(record);</span><br><span class="line">            total_bytes += record_len;</span><br><span class="line">            ++total_bytes; <span class="comment">// 每个字符串结尾 &#x27;\0&#x27;</span></span><br><span class="line">            ++record_count;</span><br><span class="line">        &#125;</span><br><span class="line">        env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(jstring_val, record);</span><br><span class="line">        env-&gt;<span class="built_in">DeleteLocalRef</span>(record_from_supplier);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> _key = env-&gt;<span class="built_in">GetStringUTFChars</span>(key_jstring, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="function">std::string <span class="title">key</span><span class="params">(_key)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> cache = <span class="keyword">new</span> list_cache;</span><br><span class="line">    cache-&gt;str_data.record_num = record_count;</span><br><span class="line">    cache-&gt;str_data.remain_blank_num = MAX_RECORD_ADD_COUNT;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> total_results_size = <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(record_count) + MAX_RECORD_ADD_COUNT;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> alloc_bytes = total_bytes + MAX_RECORD_ADD_COUNT * MAX_PATH_LENGTH;</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;cache-&gt;str_data.dev_strs), alloc_bytes), <span class="literal">true</span>,</span><br><span class="line">        <span class="built_in">get_cache_info</span>(key, cache).<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemset</span>(cache-&gt;str_data.dev_strs, <span class="number">0</span>, alloc_bytes), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;cache-&gt;str_data.dev_str_addr), total_results_size * <span class="built_in">sizeof</span>(<span class="type">size_t</span>)),</span><br><span class="line">        <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemset</span>(cache-&gt;str_data.dev_str_addr, <span class="number">0</span>, total_results_size * <span class="built_in">sizeof</span>(<span class="type">size_t</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    cache-&gt;str_data.str_length = <span class="keyword">new</span> <span class="type">size_t</span>[total_results_size];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;cache-&gt;dev_output), total_results_size), <span class="literal">true</span>,</span><br><span class="line">        <span class="built_in">get_cache_info</span>(key, cache).<span class="built_in">c_str</span>());</span><br><span class="line">    cache-&gt;dev_output_bytes = total_results_size;</span><br><span class="line">    cache-&gt;is_cache_valid = <span class="literal">true</span>;</span><br><span class="line">    cache-&gt;is_match_done = <span class="literal">false</span>;</span><br><span class="line">    cache-&gt;is_output_done = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cudaStream_t stream;</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaStreamCreate</span>(&amp;stream), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">auto</span> target_addr = cache-&gt;str_data.dev_strs;</span><br><span class="line">    <span class="keyword">auto</span> save_str_addr_ptr = cache-&gt;str_data.dev_str_addr;</span><br><span class="line">    <span class="type">unsigned</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> std::string&amp; record : records_vec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> record_length = record.<span class="built_in">length</span>();</span><br><span class="line">        <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemcpyAsync</span>(target_addr, record.<span class="built_in">c_str</span>(), record_length, cudaMemcpyHostToDevice, stream), <span class="literal">true</span>,</span><br><span class="line">            <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> str_address = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">size_t</span>&gt;(target_addr);</span><br><span class="line">        <span class="comment">//保存字符串在显存上的地址</span></span><br><span class="line">        <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemcpyAsync</span>(save_str_addr_ptr, &amp;str_address, <span class="built_in">sizeof</span>(<span class="type">size_t</span>), cudaMemcpyHostToDevice, stream),</span><br><span class="line">            <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">        cache-&gt;str_data.str_length[i] = record_length;</span><br><span class="line">        target_addr += record_length;</span><br><span class="line">        ++target_addr;</span><br><span class="line">        ++save_str_addr_ptr;</span><br><span class="line">        ++i;</span><br><span class="line">        cache-&gt;str_data.record_hash.<span class="built_in">insert</span>(<span class="built_in">hasher</span>(record));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaStreamSynchronize</span>(stream), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaStreamDestroy</span>(stream), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    cache_map.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(key, cache));</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(key_jstring, _key);</span><br><span class="line">    env-&gt;<span class="built_in">DeleteLocalRef</span>(supplier_class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="字符串匹配及收集"><a href="#字符串匹配及收集" class="headerlink" title="字符串匹配及收集"></a>字符串匹配及收集</h4><p>再来谈一下match方法，该方法实现对缓存中数据的字符串匹配，并将匹配后的结果保存进入Java容器中</p>
<p>首先等待清理缓存完成，防止在搜索时缓存被清除导致程序崩溃。然后生成搜索关键字和搜索过滤条件，随后打开多个线程收集GPU匹配结果，最后开启GPU核函数进行匹配，等待所有收集线程退出，即搜索完成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     file_engine_dllInterface_gpu_CudaAccelerator</span></span><br><span class="line"><span class="comment"> * Method:    match</span></span><br><span class="line"><span class="comment"> * Signature: ([Ljava/lang/String;ZLjava/lang/String;[Ljava/lang/String;[Ljava/lang/String;[ZILjava/util/function/BiConsumer;)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_file_engine_dllInterface_gpu_CudaAccelerator_match</span></span></span><br><span class="line"><span class="function"><span class="params">(JNIEnv* env, jobject, jobjectArray search_case, jboolean is_ignore_case, jstring search_text,</span></span></span><br><span class="line"><span class="params"><span class="function">    jobjectArray keywords, jobjectArray keywords_lower, jbooleanArray is_keyword_path, jint max_results,</span></span></span><br><span class="line"><span class="params"><span class="function">    jobject result_collector)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cache_map.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">wait_for_clear_cache</span>();</span><br><span class="line">    <span class="function">std::lock_guard <span class="title">lock_guard</span><span class="params">(modify_cache_lock)</span></span>;</span><br><span class="line">    <span class="comment">//生成搜索条件 search_case_vec</span></span><br><span class="line">    std::vector&lt;std::string&gt; search_case_vec;</span><br><span class="line">    <span class="keyword">if</span> (search_case != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">generate_search_case</span>(env, search_case_vec, search_case);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成搜索关键字 keywords_vec keywords_lower_vec is_keyword_path_ptr</span></span><br><span class="line">    std::vector&lt;std::string&gt; keywords_vec;</span><br><span class="line">    std::vector&lt;std::string&gt; keywords_lower_vec;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> keywords_length = env-&gt;<span class="built_in">GetArrayLength</span>(keywords);</span><br><span class="line">    <span class="keyword">if</span> (keywords_length &gt; MAX_KEYWORDS_NUMBER)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;too many keywords.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">bool</span> is_keyword_path_ptr[MAX_KEYWORDS_NUMBER]&#123; <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> is_keyword_path_ptr_bool_array = env-&gt;<span class="built_in">GetBooleanArrayElements</span>(is_keyword_path, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">for</span> (jsize i = <span class="number">0</span>; i &lt; keywords_length; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> tmp_keywords_str = <span class="built_in">reinterpret_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectArrayElement</span>(keywords, i));</span><br><span class="line">        <span class="keyword">auto</span> keywords_chars = env-&gt;<span class="built_in">GetStringUTFChars</span>(tmp_keywords_str, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG_OUTPUT</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;keywords: &quot;</span> &lt;&lt; keywords_chars &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        keywords_vec.<span class="built_in">emplace_back</span>(keywords_chars);</span><br><span class="line">        env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(tmp_keywords_str, keywords_chars);</span><br><span class="line">        env-&gt;<span class="built_in">DeleteLocalRef</span>(tmp_keywords_str);</span><br><span class="line"></span><br><span class="line">        tmp_keywords_str = <span class="built_in">reinterpret_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectArrayElement</span>(keywords_lower, i));</span><br><span class="line">        keywords_chars = env-&gt;<span class="built_in">GetStringUTFChars</span>(tmp_keywords_str, <span class="literal">nullptr</span>);</span><br><span class="line">        keywords_lower_vec.<span class="built_in">emplace_back</span>(keywords_chars);</span><br><span class="line">        env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(tmp_keywords_str, keywords_chars);</span><br><span class="line">        env-&gt;<span class="built_in">DeleteLocalRef</span>(tmp_keywords_str);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG_OUTPUT</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;is keyword path: &quot;</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">bool</span>&gt;(is_keyword_path_ptr_bool_array[i]) &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        is_keyword_path_ptr[i] = is_keyword_path_ptr_bool_array[i];</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseBooleanArrayElements</span>(is_keyword_path, is_keyword_path_ptr_bool_array, JNI_ABORT);</span><br><span class="line">    <span class="comment">//复制全字匹配字符串 search_text</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> search_text_chars = env-&gt;<span class="built_in">GetStringUTFChars</span>(search_text, <span class="literal">nullptr</span>);</span><br><span class="line">    std::atomic_uint result_counter = <span class="number">0</span>;</span><br><span class="line">    std::vector&lt;std::thread&gt; collect_threads_vec;</span><br><span class="line">    collect_threads_vec.<span class="built_in">reserve</span>(COLLECT_RESULTS_THREADS);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; COLLECT_RESULTS_THREADS; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        collect_threads_vec.<span class="built_in">emplace_back</span>([&amp;]</span><br><span class="line">            &#123;</span><br><span class="line">                JNIEnv* thread_env = <span class="literal">nullptr</span>;</span><br><span class="line">                JavaVMAttachArgs args&#123; JNI_VERSION_10, <span class="literal">nullptr</span>, <span class="literal">nullptr</span> &#125;;</span><br><span class="line">                <span class="keyword">if</span> (jvm-&gt;<span class="built_in">AttachCurrentThread</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;thread_env), &amp;args) != JNI_OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;get thread JNIEnv ptr failed&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">collect_results</span>(thread_env, result_collector, result_counter, max_results, search_case_vec);</span><br><span class="line">                jvm-&gt;<span class="built_in">DetachCurrentThread</span>();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//GPU并行计算</span></span><br><span class="line">    <span class="built_in">start_kernel</span>(cache_map, search_case_vec, is_ignore_case, search_text_chars,</span><br><span class="line">        keywords_vec, keywords_lower_vec, is_keyword_path_ptr);</span><br><span class="line">    <span class="built_in">collect_results</span>(env, result_collector, result_counter, max_results, search_case_vec);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; each_thread : collect_threads_vec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (each_thread.<span class="built_in">joinable</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            each_thread.<span class="built_in">join</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; [_, cache_val] : cache_map)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache_val-&gt;is_output_done.<span class="built_in">load</span>() != <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cache_val-&gt;is_output_done = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(search_text, search_text_chars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="GPU核函数"><a href="#GPU核函数" class="headerlink" title="GPU核函数"></a>GPU核函数</h4><p>首先通过核函数线程id获取对应的字符串，然后对字符串进行匹配，如果匹配完成将output设置为1（即缓存结构体中的dev_output），如果匹配失败则设置为0。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 核函数并未对参数做检查，所以如果数据库中包含不是文件路径的记录将会导致崩溃。</span></span><br><span class="line"><span class="comment"> * 如   D:    C:    这样的记录将会导致核函数失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">check</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span>* str_address_records,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">size_t</span>* total_num,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span>* search_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span>* is_ignore_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* search_text,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* keywords,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* keywords_lower_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">size_t</span>* keywords_length,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span>* is_keyword_path,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* output,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span>* is_stop_collect_var)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> thread_id = <span class="built_in">GET_TID</span>();</span><br><span class="line">    <span class="keyword">if</span> (thread_id &gt;= *total_num)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*is_stop_collect_var)</span><br><span class="line">    &#123;</span><br><span class="line">        output[thread_id] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> path = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(str_address_records[thread_id]);</span><br><span class="line">    <span class="keyword">if</span> (path == <span class="literal">nullptr</span> || !path[<span class="number">0</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        output[thread_id] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">not_matched</span>(path, *is_ignore_case, keywords, keywords_lower_case, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(*keywords_length),</span><br><span class="line">        is_keyword_path))</span><br><span class="line">    &#123;</span><br><span class="line">        output[thread_id] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*search_case == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        output[thread_id] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*search_case &amp; <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 全字匹配</span></span><br><span class="line">        <span class="built_in">strlwr_cuda</span>(search_text);</span><br><span class="line">        <span class="type">char</span> file_name[MAX_PATH_LENGTH]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">get_file_name</span>(path, file_name);</span><br><span class="line">        <span class="built_in">strlwr_cuda</span>(file_name);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp_cuda</span>(search_text, file_name) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            output[thread_id] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    output[thread_id] = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在not_matched()方法中，将会对字符串进行匹配，并尝试进行拼音匹配</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__device__ <span class="type">bool</span> <span class="title">not_matched</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span> is_ignore_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* keywords,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* keywords_lower_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span> keywords_length,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span>* is_keyword_path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; keywords_length; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">bool</span> is_keyword_path_val = is_keyword_path[i];</span><br><span class="line">        <span class="type">char</span> match_str[MAX_PATH_LENGTH]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> (is_keyword_path_val)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">get_parent_path</span>(path, match_str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">get_file_name</span>(path, match_str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span>* each_keyword;</span><br><span class="line">        <span class="keyword">if</span> (is_ignore_case)</span><br><span class="line">        &#123;</span><br><span class="line">            each_keyword = keywords_lower_case + i * <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>&gt;(MAX_PATH_LENGTH);</span><br><span class="line">            <span class="built_in">strlwr_cuda</span>(match_str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            each_keyword = keywords + i * <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>&gt;(MAX_PATH_LENGTH);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!each_keyword[<span class="number">0</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr_cuda</span>(match_str, each_keyword) == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_keyword_path_val || !<span class="built_in">is_str_contains_chinese</span>(match_str))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">char</span> gbk_buffer[MAX_PATH_LENGTH * <span class="number">2</span>]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="type">char</span>* gbk_buffer_ptr = gbk_buffer;</span><br><span class="line">            <span class="comment">// utf-8编码转换gbk</span></span><br><span class="line">            <span class="built_in">utf8_to_gbk</span>(match_str, <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span>&gt;(<span class="built_in">strlen_cuda</span>(match_str)), &amp;gbk_buffer_ptr, <span class="literal">nullptr</span>);</span><br><span class="line">            <span class="type">char</span> converted_pinyin[MAX_PATH_LENGTH * <span class="number">6</span>]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="type">char</span> converted_pinyin_initials[MAX_PATH_LENGTH]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="built_in">convert_to_pinyin</span>(gbk_buffer, converted_pinyin, converted_pinyin_initials);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr_cuda</span>(converted_pinyin, each_keyword) == <span class="literal">nullptr</span> &amp;&amp; </span><br><span class="line">                <span class="built_in">strstr_cuda</span>(converted_pinyin_initials, each_keyword) == <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="结果收集"><a href="#结果收集" class="headerlink" title="结果收集"></a>结果收集</h4><p>每个缓存中拥有一个is_output_done字段，初始为0，每个线程将会通过cas尝试将缓存的is_output_done设置为1，表示正在收集，当收集完成is_output_done会被设置为2表示收集完成。</p>
<p>当线程抢到某个缓存的收集权后将会开始进行收集。<br>GPU核函数匹配成功后将会把dev_output中对应的标志设置为1，通过dev_output可以拿到对应的字符串地址，然后取出字符串。</p>
<p>由于GPU核函数无法访问操作系统函数，因此在这里还需要过滤是否为文件夹，或是否为文件，过滤完成后将会调用_collect_func()调用match()方法的回调方法，将结果存入Java容器中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">collect_results</span><span class="params">(JNIEnv* thread_env, jobject result_collector, std::atomic_uint&amp; result_counter,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">unsigned</span> max_results, <span class="type">const</span> std::vector&lt;std::string&gt;&amp; search_case_vec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> jclass biconsumer_class = thread_env-&gt;<span class="built_in">GetObjectClass</span>(result_collector);</span><br><span class="line">    <span class="type">const</span> jmethodID collector = thread_env-&gt;<span class="built_in">GetMethodID</span>(biconsumer_class, <span class="string">&quot;accept&quot;</span>,</span><br><span class="line">        <span class="string">&quot;(Ljava/lang/Object;Ljava/lang/Object;)V&quot;</span>);</span><br><span class="line">    <span class="type">bool</span> all_complete;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> stop_func = [&amp;]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">is_stop</span>() || result_counter.<span class="built_in">load</span>() &gt;= max_results;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">auto</span> _collect_func = [&amp;](<span class="type">const</span> std::string&amp; _key, <span class="type">char</span> _matched_record_str[MAX_PATH_LENGTH],</span><br><span class="line">        <span class="type">unsigned</span>* matched_number)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (++result_counter &gt;= max_results)</span><br><span class="line">        &#123;</span><br><span class="line">            is_results_number_exceed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">auto</span> record_jstring = thread_env-&gt;<span class="built_in">NewStringUTF</span>(_matched_record_str);</span><br><span class="line">        <span class="keyword">auto</span> key_jstring = thread_env-&gt;<span class="built_in">NewStringUTF</span>(_key.<span class="built_in">c_str</span>());</span><br><span class="line">        thread_env-&gt;<span class="built_in">CallVoidMethod</span>(result_collector, collector, key_jstring, record_jstring);</span><br><span class="line">        thread_env-&gt;<span class="built_in">DeleteLocalRef</span>(record_jstring);</span><br><span class="line">        thread_env-&gt;<span class="built_in">DeleteLocalRef</span>(key_jstring);</span><br><span class="line">        ++* matched_number;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//尝试退出</span></span><br><span class="line">        all_complete = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; [key, val] : cache_map)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">stop_func</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!val-&gt;is_cache_valid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!val-&gt;is_match_done.<span class="built_in">load</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//发现仍然有结果未计算完，设置退出标志为false，跳到下一个计算结果</span></span><br><span class="line">                all_complete = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="type">int</span> expected = <span class="number">0</span>; !val-&gt;is_output_done.<span class="built_in">compare_exchange_strong</span>(expected, <span class="number">1</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">unsigned</span> matched_number = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//复制结果数组到host，dev_output下标对应dev_cache中的下标，若dev_output[i]中的值为1，则对应dev_cache[i]字符串匹配成功</span></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> output_ptr = <span class="keyword">new</span> <span class="type">char</span>[val-&gt;dev_output_bytes];</span><br><span class="line">            <span class="comment">//将dev_output拷贝到output_ptr</span></span><br><span class="line">            <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemcpy</span>(output_ptr, val-&gt;dev_output, val-&gt;str_data.record_num, cudaMemcpyDeviceToHost), <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;collect results failed&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; val-&gt;str_data.record_num.<span class="built_in">load</span>(); ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">stop_func</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//dev_cache[i]字符串匹配成功</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">static_cast</span>&lt;<span class="type">bool</span>&gt;(output_ptr[i]))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">char</span> matched_record_str[MAX_PATH_LENGTH]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">                    <span class="type">char</span>* str_address;</span><br><span class="line">                    <span class="built_in">gpuErrchk</span>(</span><br><span class="line">                        <span class="built_in">cudaMemcpy</span>(&amp;str_address, val-&gt;str_data.dev_str_addr + i, <span class="built_in">sizeof</span>(<span class="type">size_t</span>), cudaMemcpyDeviceToHost</span><br><span class="line">                        ), <span class="literal">false</span>, <span class="literal">nullptr</span>);</span><br><span class="line">                    <span class="comment">//拷贝GPU中的字符串到host</span></span><br><span class="line">                    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemcpy</span>(matched_record_str, str_address, val-&gt;str_data.str_length[i],</span><br><span class="line">                        cudaMemcpyDeviceToHost), <span class="literal">false</span>, <span class="string">&quot;collect results failed&quot;</span>);</span><br><span class="line">                    <span class="comment">// 判断文件和文件夹</span></span><br><span class="line">                    <span class="keyword">if</span> (search_case_vec.<span class="built_in">empty</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">is_file_exist</span>(matched_record_str))</span><br><span class="line">                        &#123;</span><br><span class="line">                            _collect_func(key, matched_record_str, &amp;matched_number);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (std::<span class="built_in">find</span>(search_case_vec.<span class="built_in">begin</span>(), search_case_vec.<span class="built_in">end</span>(), <span class="string">&quot;f&quot;</span>) != search_case_vec.<span class="built_in">end</span>())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">is_dir_or_file</span>(matched_record_str) == <span class="number">1</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                _collect_func(key, matched_record_str, &amp;matched_number);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (std::<span class="built_in">find</span>(search_case_vec.<span class="built_in">begin</span>(), search_case_vec.<span class="built_in">end</span>(), <span class="string">&quot;d&quot;</span>) != search_case_vec.</span><br><span class="line">                            <span class="built_in">end</span>())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">is_dir_or_file</span>(matched_record_str) == <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                _collect_func(key, matched_record_str, &amp;matched_number);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">is_file_exist</span>(matched_record_str))</span><br><span class="line">                            &#123;</span><br><span class="line">                                _collect_func(key, matched_record_str, &amp;matched_number);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            val-&gt;matched_number = matched_number;</span><br><span class="line">            val-&gt;is_output_done = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">delete</span>[] output_ptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!all_complete &amp;&amp; !<span class="built_in">stop_func</span>());</span><br><span class="line">    thread_env-&gt;<span class="built_in">DeleteLocalRef</span>(biconsumer_class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，GPU加速的核心方法基本介绍完成。OpenCL的版本除了字符串存储方式不同，其他方法几乎相同，只是使用了不同的框架进行实现，因此不再赘述。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/16/Everything/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/16/Everything/" class="post-title-link" itemprop="url">Everything高速搜索文件原理及实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-16 04:57:10" itemprop="dateCreated datePublished" datetime="2022-08-16T04:57:10+08:00">2022-08-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-20 12:52:23" itemprop="dateModified" datetime="2024-05-20T12:52:23+08:00">2024-05-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>        网上找了很多的资料，还是没有很清楚的了解Everything这款软件。所以自己研究了一下，并记录下来。</p>
<p>        Everything是一个搜索文件速度超快的软件，相比Windows自带的搜索功能，Everything可以做到在数十万文件中做到秒搜。</p>
<p>    本文来分析一下Everything背后的原理以及自己实现一个Everything。</p>
<h2 id="Everything的工作原理"><a href="#Everything的工作原理" class="headerlink" title="Everything的工作原理"></a>Everything的工作原理</h2><p>    Everything在第一次打开程序时会扫描整个磁盘，并建立一个索引库。需要注意的是，Everything并不是像Windows文件夹遍历那样一个文件一个文件的搜索并记录。而是通过NTFS文件系统的特性，MFT和USN journal。这也是Everything仅支持NTFS文件系统的原因。</p>
<p>    <strong>Master File Table (MFT)</strong></p>
<p>    在NTFS文件系统中，有一个特殊的表，称为MFT表。所有文件夹和文件的名称都被存储在该表中，Everything通过遍历这个表的所有内容，实现在不遍历文件系统就能获取当前磁盘中的所有文件的名称和路径。</p>
<p>    <strong>USN journal</strong></p>
<p>    NTFS的日志功能。所有对文件系统的修改操作都被记录在了一个journal日志文件中。Everything通过监控这个日志文件实现对文件修改的监控。</p>
<p>    <strong>文件查找</strong></p>
<p>    通过字符串匹配算法从之前建立的索引中对字符串进行匹配，并显示文件名称和路径。</p>
<p>关于usn日志的相关信息，个人认为这篇文章写的比较清楚</p>
<p><a target="_blank" rel="noopener" href="http://atr.pub/2016/04/16/NTFS-USN/">NTFS USN日志记录读取历险记 - Irix的博客 | Irix’s Blog (atr.pub)</a></p>
<p>以及官方文档</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/fileio/change-journals">Change Journals - Win32 apps | Microsoft Learn</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/bb742450(v=technet.10)">Keeping an Eye on Your NTFS Drives: the Windows 2000 Change Journal Explained | Microsoft Learn</a></p>
<h2 id="自己实现一个Everything"><a href="#自己实现一个Everything" class="headerlink" title="自己实现一个Everything"></a>自己实现一个Everything</h2><p>    <strong>我自己已经实现了一个完整的类似于Everything的软件，代码已经在GitHub上开源，欢迎各位去点个star呀。</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/XUANXUQAQ/File-Engine">XUANXUQAQ/File-Engine: An app launcher &amp;&amp; efficiency tool (github.com)</a></p>
<h3 id="一、建立数据库索引"><a href="#一、建立数据库索引" class="headerlink" title="一、建立数据库索引"></a>一、建立数据库索引</h3><p>    首先，我们需要做的就是对文件的路径进行索引。我这里选用SQLite。不知道Everything是使用了什么数据库才使他们的索引文件做到这么小，至于为什么这么快，推测可能是先将索引放入内存，索引可用后，程序在后台慢慢同步到硬盘的吧。</p>
<p>    搜索的核心方法是通过创建USN日志并进行读取，然后将数据还原成文件路径并写入数据库。</p>
<p>    <strong>1. 首先是获取驱动盘的句柄</strong></p>
<p>    通过CreateFile方法打开磁盘，并返回磁盘句柄。</p>
<p>    关于CreateFile的用法详见MSDN<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilew">CreateFileW function (fileapi.h) - Win32 apps | Microsoft Docs</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">volume::get_handle</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 为\\.\C:的形式</span></span><br><span class="line">    CString <span class="title function_">lp_file_name</span><span class="params">(_T(<span class="string">&quot;\\\\.\\c:&quot;</span>))</span>;</span><br><span class="line">    lp_file_name.SetAt(<span class="number">4</span>, vol);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    hVol = CreateFile(lp_file_name,</span><br><span class="line">                      GENERIC_READ | GENERIC_WRITE, <span class="comment">// 可以为0</span></span><br><span class="line">                      FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="comment">// 必须包含有FILE_SHARE_WRITE</span></span><br><span class="line">                      nullptr,</span><br><span class="line">                      OPEN_EXISTING, <span class="comment">// 必须包含OPEN_EXISTING, CREATE_ALWAYS可能会导致错误</span></span><br><span class="line">                      FILE_ATTRIBUTE_READONLY, <span class="comment">// FILE_ATTRIBUTE_NORMAL可能会导致错误</span></span><br><span class="line">                      nullptr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (INVALID_HANDLE_VALUE != hVol)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span>&amp;&amp; info = <span class="built_in">std</span>::<span class="built_in">wstring</span>(<span class="string">L&quot;create file handle failed. &quot;</span>) + lp_file_name.GetString() +</span><br><span class="line">        <span class="string">L&quot;error code: &quot;</span> + <span class="built_in">std</span>::to_wstring(GetLastError());</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fileSearcherUSN: %ls&quot;</span>, info.c_str());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>    <strong>2. 之后开始创建USN日志</strong></p>
<p>    通过DeviceIoControl方法向磁盘发送FSCTL_CREATE_USN_JOURNAL命令，创建USN日志。</p>
<p>    关于DeviceIoControl的用法，详见MSDN<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">DeviceIoControl function (ioapiset.h) - Win32 apps | Microsoft Docs</a></p>
<p>DeviceIoControl的各个命令操作，详见MSDN<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/fileio/volume-management-control-codes">Volume Management Control Codes - Win32 apps | Microsoft Docs</a></p>
<p>这里创建USN日志使用的是FSCTL_CREATE_USN命令<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_create_usn_journal">FSCTL_CREATE_USN_JOURNAL - Win32 apps | Microsoft Docs</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">volume::create_usn</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    cujd.MaximumSize = <span class="number">0</span>; <span class="comment">// 0表示使用默认值  </span></span><br><span class="line">    cujd.AllocationDelta = <span class="number">0</span>; <span class="comment">// 0表示使用默认值</span></span><br><span class="line"></span><br><span class="line">    DWORD br;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        DeviceIoControl(hVol, <span class="comment">// handle to volume</span></span><br><span class="line">                        FSCTL_CREATE_USN_JOURNAL, <span class="comment">// dwIoControlCode</span></span><br><span class="line">                        &amp;cujd, <span class="comment">// input buffer</span></span><br><span class="line">                        <span class="keyword">sizeof</span>(cujd), <span class="comment">// size of input buffer</span></span><br><span class="line">                        nullptr, <span class="comment">// lpOutBuffer</span></span><br><span class="line">                        <span class="number">0</span>, <span class="comment">// nOutBufferSize</span></span><br><span class="line">                        &amp;br, <span class="comment">// number of bytes returned</span></span><br><span class="line">                        nullptr) <span class="comment">// OVERLAPPED structure    </span></span><br><span class="line">    )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span>&amp;&amp; info = <span class="string">&quot;create usn error. Error code: &quot;</span> + <span class="built_in">std</span>::to_string(GetLastError());</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fileSearcherUSN: %s\n&quot;</span>, info.c_str());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>    <strong>3. 获取USN日志信息</strong></p>
<p>    还是通过DeviceIoControl方法发送FSCTL_QUERY_USN_JOURNAL命令，获取当前卷USN日志的各项信息，检查USN日志是否获取成功。</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_query_usn_journal">FSCTL_QUERY_USN_JOURNAL - Win32 apps | Microsoft Docs</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">volume::get_usn_info</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD br;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        DeviceIoControl(hVol, <span class="comment">// handle to volume</span></span><br><span class="line">                        FSCTL_QUERY_USN_JOURNAL, <span class="comment">// dwIoControlCode</span></span><br><span class="line">                        nullptr, <span class="comment">// lpInBuffer</span></span><br><span class="line">                        <span class="number">0</span>, <span class="comment">// nInBufferSize</span></span><br><span class="line">                        &amp;ujd, <span class="comment">// output buffer</span></span><br><span class="line">                        <span class="keyword">sizeof</span>(ujd), <span class="comment">// size of output buffer</span></span><br><span class="line">                        &amp;br, <span class="comment">// number of bytes returned</span></span><br><span class="line">                        nullptr) <span class="comment">// OVERLAPPED structure</span></span><br><span class="line">    )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span>&amp;&amp; info = <span class="string">&quot;query usn error. Error code: &quot;</span> + <span class="built_in">std</span>::to_string(GetLastError());</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fileSearcherUSN: %s\n&quot;</span>, info.c_str());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>    <strong>4. 获取 USN Journal 文件的基本信息</strong></p>
<p>    仍然通过DeviceIoControl发送FSCTL_ENUM_USN_DATA遍历USN日志。</p>
<p>    <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_enum_usn_data">FSCTL_ENUM_USN_DATA - Win32 apps | Microsoft Docs</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">volume::get_usn_journal</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    MFT_ENUM_DATA med;</span><br><span class="line">    med.StartFileReferenceNumber = <span class="number">0</span>;</span><br><span class="line">    med.LowUsn = ujd.FirstUsn;</span><br><span class="line">    med.HighUsn = ujd.NextUsn;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根目录</span></span><br><span class="line">    CString <span class="title function_">tmp</span><span class="params">(_T(<span class="string">&quot;C:&quot;</span>))</span>;</span><br><span class="line">    tmp.SetAt(<span class="number">0</span>, vol);</span><br><span class="line"></span><br><span class="line">    constexpr <span class="keyword">auto</span> BUF_LEN = <span class="keyword">sizeof</span>(USN) + <span class="number">0x100000</span>; <span class="comment">// 尽可能地大，提高效率;</span></span><br><span class="line"></span><br><span class="line">    CHAR* buffer = new CHAR[BUF_LEN];</span><br><span class="line">    DWORD usn_data_size;</span><br><span class="line">    pfrn_name pfrn_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">0</span> != DeviceIoControl(hVol,</span><br><span class="line">                                FSCTL_ENUM_USN_DATA,</span><br><span class="line">                                &amp;med,</span><br><span class="line">                                <span class="keyword">sizeof</span> med,</span><br><span class="line">                                buffer,</span><br><span class="line">                                BUF_LEN,</span><br><span class="line">                                &amp;usn_data_size,</span><br><span class="line">                                nullptr))</span><br><span class="line">    &#123;</span><br><span class="line">        DWORD dw_ret_bytes = usn_data_size - <span class="keyword">sizeof</span>(USN);</span><br><span class="line">        <span class="comment">// 找到第一个 USN 记录  </span></span><br><span class="line">        <span class="keyword">auto</span> usn_record = reinterpret_cast&lt;PUSN_RECORD&gt;(buffer + <span class="keyword">sizeof</span>(USN));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (dw_ret_bytes &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取到的信息      </span></span><br><span class="line">            <span class="type">const</span> CString <span class="title function_">cfile_name</span><span class="params">(usn_record-&gt;FileName, usn_record-&gt;FileNameLength / <span class="number">2</span>)</span>;</span><br><span class="line">            pfrn_name.filename = cfile_name;</span><br><span class="line">            pfrn_name.pfrn = usn_record-&gt;ParentFileReferenceNumber;</span><br><span class="line">            <span class="comment">// frnPfrnNameMap[UsnRecord-&gt;FileReferenceNumber] = pfrnName;</span></span><br><span class="line">            frnPfrnNameMap.insert(<span class="built_in">std</span>::<span class="built_in">make_pair</span>(usn_record-&gt;FileReferenceNumber, pfrn_name));</span><br><span class="line">            <span class="comment">// 获取下一个记录  </span></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> record_len = usn_record-&gt;RecordLength;</span><br><span class="line">            dw_ret_bytes -= record_len;</span><br><span class="line">            usn_record = reinterpret_cast&lt;PUSN_RECORD&gt;(reinterpret_cast&lt;PCHAR&gt;(usn_record) + record_len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取下一页数据 </span></span><br><span class="line">        med.StartFileReferenceNumber = *reinterpret_cast&lt;DWORDLONG*&gt;(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    delete[] buffer;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>    这里我将获取到的信息放入了frnPfrnNameMap中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">pfrn_name</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    DWORDLONG pfrn = <span class="number">0</span>;</span><br><span class="line">    CString filename;</span><br><span class="line">&#125; pfrn_name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">unordered_map</span>&lt;DWORDLONG, pfrn_name&gt; Frn_Pfrn_Name_Map;</span><br></pre></td></tr></table></figure>

<p>    这里不得不说USN日志文件的数据结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    DWORD RecordLength;</span><br><span class="line">    WORD   MajorVersion;</span><br><span class="line">    WORD   MinorVersion;</span><br><span class="line">    DWORDLONG FileReferenceNumber;</span><br><span class="line">    DWORDLONG ParentFileReferenceNumber;</span><br><span class="line">    USN Usn;</span><br><span class="line">    LARGE_INTEGER TimeStamp;</span><br><span class="line">    DWORD Reason;</span><br><span class="line">    DWORD SourceInfo;</span><br><span class="line">    DWORD SecurityId;</span><br><span class="line">    DWORD FileAttributes;</span><br><span class="line">    WORD   FileNameLength;</span><br><span class="line">    WORD   FileNameOffset;</span><br><span class="line">    WCHAR FileName[<span class="number">1</span>];</span><br><span class="line">&#125; USN_RECORD_V2, *PUSN_RECORD_V2;</span><br></pre></td></tr></table></figure>

<p>    这里我们需要用到FileReferenceNumber、ParentFileReferenceNumber、FileName。</p>
<p>    USN日志在Windows中也有对应的命令，使用fsutil就可以创建日志</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fsutil usn createJournal C:</span><br><span class="line">fsutil usn enumData <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> C:</span><br></pre></td></tr></table></figure>

<p>    此时，可以看到USN日志的数据。</p>
<p><img src="https://i.328888.xyz/2023/03/30/i0KMjz.jpeg" alt="i0KMjz.jpeg"></p>
<p>    包含文件参照号，父文件参照号，以及文件名。</p>
<p>    也就是上文提到的FileReferenceNumber、ParentFileReferenceNumber、FileName</p>
<p>    USN日志是一个树状结构，通过文件号和父文件号不断向上找，最终可以拼接出一个完整的路径。获得路径后即可存入数据库。</p>
<p>    最后删除USN日志。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fsutil usn deleteJournal /D C:</span><br></pre></td></tr></table></figure>

<p>    <strong>5. 删除USN日志文件</strong></p>
<p>    因为USN日志默认并不存在，所以在程序创建之后可以将它删除。</p>
<p>    仍然是通过DeviceIoControl方法发送命令。</p>
<p>    <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winioctl/ni-winioctl-fsctl_delete_usn_journal">FSCTL_DELETE_USN_JOURNAL - Win32 apps | Microsoft Docs</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">volume::delete_usn</span><span class="params">()</span> <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">    DELETE_USN_JOURNAL_DATA dujd;</span><br><span class="line">    dujd.UsnJournalID = ujd.UsnJournalID;</span><br><span class="line">    dujd.DeleteFlags = USN_DELETE_FLAG_DELETE;</span><br><span class="line">    DWORD br;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DeviceIoControl(hVol,</span><br><span class="line">                        FSCTL_DELETE_USN_JOURNAL,</span><br><span class="line">                        &amp;dujd,</span><br><span class="line">                        <span class="keyword">sizeof</span>(dujd),</span><br><span class="line">                        nullptr,</span><br><span class="line">                        <span class="number">0</span>,</span><br><span class="line">                        &amp;br,</span><br><span class="line">                        nullptr)</span><br><span class="line">    )</span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hVol);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(hVol);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>    <strong>6. 此时就可以通过遍历frnPfrnNameMap还原出每个文件的路径，并存入数据库</strong></p>
<p>    通过不断向上遍历查找，最后拼接出文件的路径。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">volume::get_path</span><span class="params">(DWORDLONG frn, CString&amp; output_path)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> end = frnPfrnNameMap.end();</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> it = frnPfrnNameMap.find(frn);</span><br><span class="line">        <span class="keyword">if</span> (it == end)</span><br><span class="line">        &#123;</span><br><span class="line">            output_path = <span class="string">L&quot;:&quot;</span> + output_path;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        output_path = _T(<span class="string">&quot;\\&quot;</span>) + it-&gt;second.filename + output_path;</span><br><span class="line">        frn = it-&gt;second.pfrn;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="此时，我们已经实现了实现Everything的第一步，建立数据库索引。"><a href="#此时，我们已经实现了实现Everything的第一步，建立数据库索引。" class="headerlink" title="此时，我们已经实现了实现Everything的第一步，建立数据库索引。"></a>此时，我们已经实现了实现Everything的第一步，建立数据库索引。</h2><h3 id="二、监控文件的变化"><a href="#二、监控文件的变化" class="headerlink" title="二、监控文件的变化"></a>二、监控文件的变化</h3><p>监控文件的变化在这里我采用的是ReadDirectoryChangesW方法进行监控。<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-readdirectorychangesw">ReadDirectoryChangesW function (winbase.h) - Win32 apps | Microsoft Docs</a></p>
<p>文件操作类型有四种，分别为 创建、更改、删除、重命名</p>
<p>对应到Windows API里是FILE_ACTION_ADDED、FILE_ACTION_MODIFIED、FILE_ACTION_REMOVED、FILE_ACTION_RENAMED_OLD_NAME。</p>
<p>通过监控这四个操作，我们可以实现监控文件的变化，并更新数据库索引。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开始监控文件夹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">monitor_path</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> wPath = string2wstring(path);</span><br><span class="line">    DirectoryChangesReader <span class="title function_">dcr</span><span class="params">(wPath)</span>;</span><br><span class="line">    <span class="keyword">auto</span>&amp;&amp; flag = stop_flag.at(path);</span><br><span class="line">    <span class="keyword">while</span> (flag.load())</span><br><span class="line">    &#123;</span><br><span class="line">        dcr.EnqueueReadDirectoryChanges();</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">const</span> DWORD rv = dcr.WaitForHandles(); rv == WAIT_OBJECT_0)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; res = dcr.GetDirectoryChangesResultW(); <span class="type">const</span> <span class="keyword">auto</span>&amp; [action, data] : res)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (action)</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="keyword">case</span> FILE_ACTION_ADDED:</span><br><span class="line">                <span class="keyword">case</span> FILE_ACTION_RENAMED_NEW_NAME:</span><br><span class="line">                    <span class="keyword">if</span> (data.find(<span class="string">L&quot;$RECYCLE.BIN&quot;</span>) == <span class="built_in">std</span>::<span class="built_in">wstring</span>::npos)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">std</span>::<span class="built_in">wstring</span> data_with_disk;</span><br><span class="line">                        data_with_disk.append(wPath).append(data);</span><br><span class="line">                        add_record(data_with_disk);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> FILE_ACTION_REMOVED:</span><br><span class="line">                <span class="keyword">case</span> FILE_ACTION_RENAMED_OLD_NAME:</span><br><span class="line">                    <span class="keyword">if</span> (data.find(<span class="string">L&quot;$RECYCLE.BIN&quot;</span>) == <span class="built_in">std</span>::<span class="built_in">wstring</span>::npos)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">std</span>::<span class="built_in">wstring</span> data_with_disk;</span><br><span class="line">                        data_with_disk.append(wPath).append(data);</span><br><span class="line">                        delete_record(data_with_disk);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> FILE_ACTION_MODIFIED:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Sleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DirectoryChangesReader"><a href="#DirectoryChangesReader" class="headerlink" title="DirectoryChangesReader"></a>DirectoryChangesReader</h3><p>将ReadDirectoryChanges()方法的调用封装进DirectoryChangesReader对象中，当调用EnqueueReadDirectoryChanges()方法后，文件更改记录将会被写入缓存中。</p>
<p>然后执行GetDirectoryChangesResultW()方法，调用GetOverlappedResult()方法读取出文件更改信息，然后将所有信息保存进一个vector中，再返回。</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-getoverlappedresult">GetOverlappedResult function (ioapiset.h) - Win32 apps | Microsoft Learn</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// A base class for handles with different invalid values.</span></span><br><span class="line"><span class="keyword">template</span> &lt;std::<span class="type">uintptr_t</span> hInvalid&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Handle</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Handle</span>(<span class="type">const</span> Handle&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Handle</span>(Handle&amp;&amp; rhs) <span class="keyword">noexcept</span> :</span><br><span class="line">        <span class="built_in">hHandle</span>(std::<span class="built_in">exchange</span>(rhs.hHandle, hInvalid))</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Handle&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Handle&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    Handle&amp; <span class="keyword">operator</span>=(Handle&amp;&amp; rhs) <span class="keyword">noexcept</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::<span class="built_in">swap</span>(hHandle, rhs.hHandle);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// converting to a normal HANDLE</span></span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">HANDLE</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> hHandle; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">Handle</span>(HANDLE v) : <span class="built_in">hHandle</span>(v)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// throw if we got an invalid handle</span></span><br><span class="line">        <span class="keyword">if</span> (hHandle == <span class="built_in">reinterpret_cast</span>&lt;HANDLE&gt;(hInvalid) || hHandle == INVALID_HANDLE_VALUE)</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;invalid handle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Handle</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (hHandle != <span class="built_in">reinterpret_cast</span>&lt;HANDLE&gt;(hInvalid)) <span class="built_in">CloseHandle</span>(hHandle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    HANDLE hHandle;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> InvalidNullptrHandle = Handle&lt;(std::<span class="type">uintptr_t</span>)<span class="literal">nullptr</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A class for directory handles</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DirectoryHandleW</span> : <span class="keyword">public</span> InvalidNullptrHandle</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DirectoryHandleW</span>(<span class="type">const</span> std::wstring&amp; dir) :</span><br><span class="line">        <span class="built_in">Handle</span>(</span><br><span class="line">            <span class="built_in">CreateFileW</span>(</span><br><span class="line">                dir.<span class="built_in">c_str</span>(), FILE_LIST_DIRECTORY,</span><br><span class="line">                FILE_SHARE_READ | FILE_SHARE_DELETE | FILE_SHARE_WRITE,</span><br><span class="line">                <span class="literal">nullptr</span>, OPEN_EXISTING, FILE_FLAG_BACKUP_SEMANTICS |</span><br><span class="line">                FILE_FLAG_OVERLAPPED, <span class="literal">nullptr</span>)</span><br><span class="line">        )</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A class for event handles</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventHandle</span> : <span class="keyword">public</span> InvalidNullptrHandle</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">EventHandle</span>() : <span class="built_in">Handle</span>(<span class="built_in">CreateEvent</span>(<span class="literal">nullptr</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">nullptr</span>))</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A stepping function for FILE_NOTIFY_INFORMATION*</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">StepToNextNotifyInformation</span><span class="params">(FILE_NOTIFY_INFORMATION*&amp; cur)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cur-&gt;NextEntryOffset == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    cur = <span class="built_in">reinterpret_cast</span>&lt;FILE_NOTIFY_INFORMATION*&gt;(</span><br><span class="line">        <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(cur) + cur-&gt;NextEntryOffset</span><br><span class="line">        );</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A ReadDirectoryChanges support class</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="type">size_t</span> Handles = <span class="number">1</span>, <span class="type">size_t</span> BufByteSize = <span class="number">4096</span>&gt;</span><br><span class="line"><span class="keyword">class</span> DirectoryChangesReader</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">static_assert</span>(Handles &gt; <span class="number">0</span>, <span class="string">&quot;There must be room for at least 1 HANDLE&quot;</span>);</span><br><span class="line">    <span class="built_in">static_assert</span>(BufByteSize &gt;= <span class="built_in">sizeof</span>(FILE_NOTIFY_INFORMATION) + MAX_PATH, <span class="string">&quot;BufByteSize too small&quot;</span>);</span><br><span class="line">    <span class="built_in">static_assert</span>(BufByteSize % <span class="built_in">sizeof</span>(DWORD) == <span class="number">0</span>, <span class="string">&quot;BufByteSize must be a multiple of sizeof(DWORD)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DirectoryChangesReader</span>(<span class="type">const</span> std::wstring&amp; dirname) :</span><br><span class="line">        <span class="built_in">hDir</span>(dirname),</span><br><span class="line">        ovl&#123;&#125;,</span><br><span class="line">        hEv&#123;&#125;,</span><br><span class="line">        handles&#123; hEv &#125;,</span><br><span class="line">        buffer&#123; std::<span class="built_in">make_unique</span>&lt;DWORD[]&gt;(BufByteSize / <span class="built_in">sizeof</span>(DWORD)) &#125;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A function to fill in data to use with ReadDirectoryChangesW</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">EnqueueReadDirectoryChanges</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ovl = OVERLAPPED&#123;&#125;;</span><br><span class="line">        ovl.hEvent = hEv;</span><br><span class="line">        <span class="type">const</span> BOOL rdc = <span class="built_in">ReadDirectoryChangesW</span>(</span><br><span class="line">            hDir,</span><br><span class="line">            buffer.<span class="built_in">get</span>(),</span><br><span class="line">            BufByteSize,</span><br><span class="line">            TRUE,</span><br><span class="line">            FILE_NOTIFY_CHANGE_FILE_NAME | FILE_NOTIFY_CHANGE_DIR_NAME |</span><br><span class="line">            FILE_NOTIFY_CHANGE_ATTRIBUTES | FILE_NOTIFY_CHANGE_SIZE |</span><br><span class="line">            FILE_NOTIFY_CHANGE_LAST_WRITE | FILE_NOTIFY_CHANGE_LAST_ACCESS |</span><br><span class="line">            FILE_NOTIFY_CHANGE_CREATION | FILE_NOTIFY_CHANGE_SECURITY,</span><br><span class="line">            <span class="literal">nullptr</span>,</span><br><span class="line">            &amp;ovl,</span><br><span class="line">            <span class="literal">nullptr</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (rdc == <span class="number">0</span>) <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;EnqueueReadDirectoryChanges failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A function to get a vector of &lt;Action&gt;, &lt;Filename&gt; pairs</span></span><br><span class="line">    std::vector&lt;std::pair&lt;DWORD, std::wstring&gt;&gt;</span><br><span class="line">        <span class="built_in">GetDirectoryChangesResultW</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        std::vector&lt;std::pair&lt;DWORD, std::wstring&gt;&gt; retval;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span>* fni = <span class="built_in">reinterpret_cast</span>&lt;FILE_NOTIFY_INFORMATION*&gt;(buffer.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">        DWORD ovlBytesReturned;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">GetOverlappedResult</span>(hDir, &amp;ovl, &amp;ovlBytesReturned, TRUE))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                retval.<span class="built_in">emplace_back</span>(</span><br><span class="line">                    fni-&gt;Action,</span><br><span class="line">                    std::wstring&#123;</span><br><span class="line">                        fni-&gt;FileName,</span><br><span class="line">                        fni-&gt;FileName + fni-&gt;FileNameLength / <span class="built_in">sizeof</span>(<span class="type">wchar_t</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="built_in">StepToNextNotifyInformation</span>(fni));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for the handles in the handles array</span></span><br><span class="line">    <span class="function">DWORD <span class="title">WaitForHandles</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">constexpr</span> DWORD wait_threshold = <span class="number">5000</span>;</span><br><span class="line">        <span class="keyword">return</span> ::<span class="built_in">WaitForMultipleObjects</span>(Handles, handles, <span class="literal">false</span>, wait_threshold);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// access to the handles array</span></span><br><span class="line">    HANDLE&amp; <span class="keyword">operator</span>[](<span class="type">size_t</span> idx) &#123; <span class="keyword">return</span> handles[idx]; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="type">size_t</span> <span class="title">handles_count</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> Handles; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    DirectoryHandleW hDir;</span><br><span class="line">    OVERLAPPED ovl;</span><br><span class="line">    EventHandle hEv;</span><br><span class="line">    HANDLE handles[Handles];</span><br><span class="line">    std::unique_ptr&lt;DWORD[]&gt; buffer; <span class="comment">// DWORD-aligned</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="至此，实现Everything第二步，监控文件变化完成。"><a href="#至此，实现Everything第二步，监控文件变化完成。" class="headerlink" title="至此，实现Everything第二步，监控文件变化完成。"></a>至此，实现Everything第二步，监控文件变化完成。</h2><h3 id="三、实现UI界面"><a href="#三、实现UI界面" class="headerlink" title="三、实现UI界面"></a>三、实现UI界面</h3><p>    由于项目是我几年前写的，所以当时用了Java的Swing框架。上文写到的创建数据库索引的工具编译成了exe，由Java调用。而监控文件变化的工具编译成了dll，通过jni进行调用。</p>
<p>    <strong>1. 首先，制作一个搜索框</strong></p>
<p>    使用JFrame创建窗口，JTextField放上面作为搜索框，下面放JLabel作为结果的显示就好，这里就不再贴代码。</p>
<p>    <strong>2. 监听用户输入，并查询数据库</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addTextFieldDocumentListener</span><span class="params">()</span> &#123;</span><br><span class="line">        textField.getDocument().addDocumentListener(<span class="keyword">new</span> <span class="title class_">DocumentListener</span>() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="type">boolean</span> isSendSignal;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUpdate</span><span class="params">(DocumentEvent e)</span> &#123;</span><br><span class="line">                changeFontOnDisplayFailed();</span><br><span class="line">                clearAllAndResetAll();</span><br><span class="line">                isSendSignal = setRunningMode();</span><br><span class="line">                <span class="keyword">if</span> (isSendSignal) &#123;</span><br><span class="line">                    startTime = System.currentTimeMillis();</span><br><span class="line">                    startSignal.set(<span class="literal">true</span>);</span><br><span class="line">                    isSqlNotInitialized.set(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (runningMode == Constants.Enums.RunningMode.PLUGIN_MODE &amp;&amp; currentUsingPlugin != <span class="literal">null</span>) &#123;</span><br><span class="line">                    currentUsingPlugin.textChanged(getSearchBarText());</span><br><span class="line">                    currentUsingPlugin.clearResultQueue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeUpdate</span><span class="params">(DocumentEvent e)</span> &#123;</span><br><span class="line">                changeFontOnDisplayFailed();</span><br><span class="line">                clearAllAndResetAll();</span><br><span class="line">                isSendSignal = setRunningMode();</span><br><span class="line">                <span class="keyword">if</span> (getSearchBarText().isEmpty()) &#123;</span><br><span class="line">                    lastMousePositionX = <span class="number">0</span>;</span><br><span class="line">                    lastMousePositionY = <span class="number">0</span>;</span><br><span class="line">                    listResultsNum.set(<span class="number">0</span>);</span><br><span class="line">                    currentResultCount.set(<span class="number">0</span>);</span><br><span class="line">                    startTime = System.currentTimeMillis();</span><br><span class="line">                    startSignal.set(<span class="literal">false</span>);</span><br><span class="line">                    isSqlNotInitialized.set(<span class="literal">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (isSendSignal) &#123;</span><br><span class="line">                        startTime = System.currentTimeMillis();</span><br><span class="line">                        startSignal.set(<span class="literal">true</span>);</span><br><span class="line">                        isSqlNotInitialized.set(<span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (runningMode == Constants.Enums.RunningMode.PLUGIN_MODE &amp;&amp; currentUsingPlugin != <span class="literal">null</span>) &#123;</span><br><span class="line">                        currentUsingPlugin.textChanged(getSearchBarText());</span><br><span class="line">                        currentUsingPlugin.clearResultQueue();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changedUpdate</span><span class="params">(DocumentEvent e)</span> &#123;</span><br><span class="line">                startTime = System.currentTimeMillis();</span><br><span class="line">                startSignal.set(<span class="literal">false</span>);</span><br><span class="line">                isSqlNotInitialized.set(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>    这里采用记录startTime和startSignal的方式，通过线程池来检测搜索信号，并进行数据库的搜索。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 生成未格式化的sql</span></span><br><span class="line"><span class="comment">    * 第一个map中key保存未格式化的sql，value保存表名称，第二个map为搜索结果的暂时存储容器</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> map</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> LinkedHashMap&lt;LinkedHashMap&lt;String, String&gt;, ConcurrentSkipListSet&lt;String&gt;&gt; <span class="title function_">getNonFormattedSqlFromTableQueue</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (isDatabaseUpdated.get()) &#123;</span><br><span class="line">           isDatabaseUpdated.set(<span class="literal">false</span>);</span><br><span class="line">           initPriority();</span><br><span class="line">       &#125;</span><br><span class="line">       LinkedHashMap&lt;LinkedHashMap&lt;String, String&gt;, ConcurrentSkipListSet&lt;String&gt;&gt; sqlColumnMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">       <span class="keyword">if</span> (priorityMap.isEmpty()) &#123;</span><br><span class="line">           <span class="keyword">return</span> sqlColumnMap;</span><br><span class="line">       &#125;</span><br><span class="line">       initTableQueueByPriority();</span><br><span class="line">       <span class="type">int</span> <span class="variable">asciiSum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span> (keywords.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (String keyword : keywords.get()) &#123;</span><br><span class="line">               <span class="type">int</span> <span class="variable">ascII</span> <span class="operator">=</span> GetAscII.INSTANCE.getAscII(keyword);</span><br><span class="line">               asciiSum += Math.max(ascII, <span class="number">0</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">int</span> <span class="variable">asciiGroup</span> <span class="operator">=</span> asciiSum / <span class="number">100</span>;</span><br><span class="line">       <span class="type">String</span> <span class="variable">firstTableName</span> <span class="operator">=</span> <span class="string">&quot;list&quot;</span> + asciiGroup;</span><br><span class="line">       <span class="keyword">if</span> (searchCase.get() != <span class="literal">null</span> &amp;&amp; Arrays.asList(searchCase.get()).contains(<span class="string">&quot;d&quot;</span>)) &#123;</span><br><span class="line">           LinkedHashMap&lt;String, String&gt; _priorityMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">           <span class="type">String</span> <span class="variable">_sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT %s FROM &quot;</span> + firstTableName + <span class="string">&quot; WHERE PRIORITY=&quot;</span> + <span class="number">0</span>;</span><br><span class="line">           _priorityMap.put(_sql, firstTableName);</span><br><span class="line">           tableQueue.stream().filter(each -&gt; !each.equals(firstTableName)).forEach(each -&gt; &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT %s FROM &quot;</span> + each + <span class="string">&quot; WHERE PRIORITY=&quot;</span> + <span class="number">0</span>;</span><br><span class="line">               _priorityMap.put(sql, each);</span><br><span class="line">           &#125;);</span><br><span class="line">           ConcurrentSkipListSet&lt;String&gt; container;</span><br><span class="line">           container = <span class="keyword">new</span> <span class="title class_">ConcurrentSkipListSet</span>&lt;&gt;();</span><br><span class="line">           sqlColumnMap.put(_priorityMap, container);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">for</span> (Pair i : priorityMap) &#123;</span><br><span class="line">               LinkedHashMap&lt;String, String&gt; eachPriorityMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">               <span class="type">String</span> <span class="variable">_sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT %s FROM &quot;</span> + firstTableName + <span class="string">&quot; WHERE PRIORITY=&quot;</span> + i.priority;</span><br><span class="line">               eachPriorityMap.put(_sql, firstTableName);</span><br><span class="line">               tableQueue.stream().filter(each -&gt; !each.equals(firstTableName)).forEach(each -&gt; &#123;</span><br><span class="line">                   <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT %s FROM &quot;</span> + each + <span class="string">&quot; WHERE PRIORITY=&quot;</span> + i.priority;</span><br><span class="line">                   eachPriorityMap.put(sql, each);</span><br><span class="line">               &#125;);</span><br><span class="line">               ConcurrentSkipListSet&lt;String&gt; container;</span><br><span class="line">               container = <span class="keyword">new</span> <span class="title class_">ConcurrentSkipListSet</span>&lt;&gt;();</span><br><span class="line">               sqlColumnMap.put(eachPriorityMap, container);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       tableQueue.clear();</span><br><span class="line">       <span class="keyword">return</span> sqlColumnMap;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>    这一步生成所有的查询SQL，简单来说就是生成<strong>SELECT * FROM [数据表]</strong> 命令并执行，这里因为后面是异步多线程查询，所以为每一个SQL语句都分配了一个用来装数据的容器，后续再进行合并，提高效率，%s字符串格式化主要是为后来可能增加的字段留出升级空间。</p>
<p>    <strong>3. 字符串匹配</strong></p>
<p>    运行SQL后，文件路径将被查出来，通过文件名匹配。</p>
<p>    这里我添加了路径搜索，以及是否忽略大小写和拼音搜索的功能。如果只是单纯的匹配字符串，直接用string.contains()或者string.indexof()即可。</p>
<p>    关于为什么不使用KMP算法而只是暴力匹配。因为文件路径中并不存在大量重复字符串，并且路径字符串一般都不会很长。此时使用KMP算法由于大量运算反而会起反效果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断文件路径是否满足当前匹配结果（该方法由check方法使用），检查文件路径使用check方法。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path         文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isIgnoreCase 是否忽略大小谢</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果匹配成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #check(String, String[], String, String[])  ;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">notMatched</span><span class="params">(String path, <span class="type">boolean</span> isIgnoreCase, String[] keywords)</span> &#123;</span><br><span class="line">        String matcherStrFromFilePath;</span><br><span class="line">        <span class="type">boolean</span> isPath;</span><br><span class="line">        <span class="keyword">for</span> (String eachKeyword : keywords) &#123;</span><br><span class="line">            <span class="keyword">if</span> (eachKeyword == <span class="literal">null</span> || eachKeyword.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">char</span> <span class="variable">firstChar</span> <span class="operator">=</span> eachKeyword.charAt(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (firstChar == <span class="string">&#x27;/&#x27;</span> || firstChar == File.separatorChar) &#123;</span><br><span class="line">                <span class="comment">//匹配路径</span></span><br><span class="line">                isPath = <span class="literal">true</span>;</span><br><span class="line">                <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> RegexUtil.slash.matcher(eachKeyword);</span><br><span class="line">                eachKeyword = matcher.replaceAll(Matcher.quoteReplacement(<span class="string">&quot;&quot;</span>));</span><br><span class="line">                <span class="comment">//获取父路径</span></span><br><span class="line">                matcherStrFromFilePath = FileUtil.getParentPath(path);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//获取名字</span></span><br><span class="line">                isPath = <span class="literal">false</span>;</span><br><span class="line">                matcherStrFromFilePath = FileUtil.getFileName(path);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//转换大小写</span></span><br><span class="line">            <span class="keyword">if</span> (isIgnoreCase) &#123;</span><br><span class="line">                matcherStrFromFilePath = matcherStrFromFilePath.toLowerCase();</span><br><span class="line">                eachKeyword = eachKeyword.toLowerCase();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//开始匹配</span></span><br><span class="line">            <span class="keyword">if</span> (matcherStrFromFilePath.indexOf(eachKeyword) == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isPath) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (PinyinUtil.isStringContainChinese(matcherStrFromFilePath)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (PinyinUtil.toPinyin(matcherStrFromFilePath, <span class="string">&quot;&quot;</span>).indexOf(eachKeyword) == -<span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>    <strong>4. 显示结果</strong></p>
<p>    最后直接将搜索出来的结果显示在JLabel上就好了，这里就不再粘贴代码。</p>
<h2 id="至此，一个最基本的Everything制作完成"><a href="#至此，一个最基本的Everything制作完成" class="headerlink" title="至此，一个最基本的Everything制作完成"></a>至此，一个最基本的Everything制作完成</h2><p>项目源代码在Github开源。<a target="_blank" rel="noopener" href="https://github.com/XUANXUQAQ/File-Engine">XUANXUQAQ/File-Engine: An app launcher &amp;&amp; efficiency tool (github.com)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/22/jvm-volatile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/22/jvm-volatile/" class="post-title-link" itemprop="url">Java volatile关键字以及线程安全</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-22 07:22:22" itemprop="dateCreated datePublished" datetime="2022-07-22T07:22:22+08:00">2022-07-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-30 19:20:04" itemprop="dateModified" datetime="2023-03-30T19:20:04+08:00">2023-03-30</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="同步与线程安全"><a href="#同步与线程安全" class="headerlink" title="同步与线程安全"></a>同步与线程安全</h1><p>线程安全可以说是Java里老生常谈的问题了，包括Java的synchronize，Lock，以及他们的一些基本原理，monitor enter，monitor exit，和Java的AQS框架。</p>
<p>volatile被称为轻量级的线程同步工具。下面就来看一下volatile关键字的用法以及到底有什么作用。</p>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>最常见的volatile的用法当然是单例模式的双重检验锁了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton singleton;  </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span> <span class="params">()</span>&#123;&#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getSingleton</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (singleton == <span class="literal">null</span>) &#123;  </span><br><span class="line">                    singleton = <span class="keyword">new</span> <span class="title class_">Singleton</span>();  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> singleton;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>双重检验锁，顾名思义，需要判断两次null。</p>
<p>第一次判断是null了之后，进入synchronize代码块，随后再次判断，如果仍然是null，那么创建对象，然后赋值给singleton，最后返回。这是一个线程安全的单例模式。</p>
<p>那么为什么要判断两次呢。</p>
<p>因为如果只判断一次就进入同步代码块，线程一进入同步代码块之后就被切换到线程二，线程二此时判断仍然是null，因此会开始等待线程一退出同步代码块。当线程一创建对象退出后之后，线程二进入，仍然会创建一个新的对象，此时就出现了两个对象。</p>
<p>但是为什么需要加上volatile才真正的线程安全呢。</p>
<p>这就是volatile的第一个功能，禁止代码重排序。</p>
<h2 id="禁止代码重排序"><a href="#禁止代码重排序" class="headerlink" title="禁止代码重排序"></a>禁止代码重排序</h2><p>代码重排序出现有很多原因，编译器优化可能导致指令被重排，现代CPU的流水线设计，乱序执行也已经是非常普遍的功能。</p>
<p>new操作本质是分为三步的，首先分配内存空间，然后再将对象初始化，最后让变量指向那个内存空间。</p>
<p>在Java字节码中也有所体现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">testObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一段简单的代码，字节码为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// class version 61.0 (61)</span><br><span class="line">// access flags 0x21</span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">  // compiled from: Test.java</span><br><span class="line"></span><br><span class="line">  // access flags 0x1</span><br><span class="line">  public &lt;init&gt;()V</span><br><span class="line">   L0</span><br><span class="line">    LINENUMBER 1 L0</span><br><span class="line">    ALOAD 0</span><br><span class="line">    INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V</span><br><span class="line">    RETURN</span><br><span class="line">   L1</span><br><span class="line">    LOCALVARIABLE this LTest; L0 L1 0</span><br><span class="line">    MAXSTACK = 1</span><br><span class="line">    MAXLOCALS = 1</span><br><span class="line"></span><br><span class="line">  // access flags 0x1</span><br><span class="line">  public <span class="built_in">test</span>()V</span><br><span class="line">   L0</span><br><span class="line">    LINENUMBER 3 L0</span><br><span class="line">    NEW Test</span><br><span class="line">    DUP</span><br><span class="line">    INVOKESPECIAL Test.&lt;init&gt; ()V</span><br><span class="line">    ASTORE 1</span><br><span class="line">   L1</span><br><span class="line">    LINENUMBER 4 L1</span><br><span class="line">    RETURN</span><br><span class="line">   L2</span><br><span class="line">    LOCALVARIABLE this LTest; L0 L2 0</span><br><span class="line">    LOCALVARIABLE testObj LTest; L1 L2 1</span><br><span class="line">    MAXSTACK = 2</span><br><span class="line">    MAXLOCALS = 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里首先调用了NEW字节码，获得了对象的一个引用，然后调用DUP字节码，将操作数栈顶复制并入栈，这时操作数栈有两个该对象的引用。然后弹出一个引用，并调用<init>方法初始化实例，也就是构造函数以及代码块进行初始化，最后再调用ASTORE将引用赋值到局部变量testObj。</p>
<p>因此，在这里如果不使用volatile关键字，可能会导致赋值引用和初始化实例被重排序，如果第一个线程创建对象之后没有初始化就发生了线程切换，第二个线程在第一个判断中已经不为null，使用该对象时就可能出现问题。</p>
<p>关于volatile如何实现禁止指令重排，这里就不得不提到Java的happens-before原则。网上已经有了很多的资料，这里贴上一篇自认为讲的很不错的文章。</p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2014/09/23/java-memory-reordering.html">Java内存访问重排序的研究 - 美团技术团队 (meituan.com)</a></p>
<p>简单来说，禁止指令重排是通过内存屏障来实现。</p>
<p>在Java中定义了4中内存屏障，分别是</p>
<ul>
<li><p>LoadLoad屏障：对于这样的语句Load1; LoadLoad; Load2，在Load2及后续读取操作要读取的数据被访问前，保证Load1要读取的数据被读取完毕。</p>
</li>
<li><p>StoreStore屏障：对于这样的语句Store1; StoreStore; Store2，在Store2及后续写入操作执行前，保证Store1的写入操作对其它处理器可见。</p>
</li>
<li><p>LoadStore屏障：对于这样的语句Load1; LoadStore; Store2，在Store2及后续写入操作被刷出前，保证Load1要读取的数据被读取完毕。</p>
</li>
<li><p>StoreLoad屏障：对于这样的语句Store1; StoreLoad; Load2，在Load2及后续所有读取操作执行前，保证Store1的写入对所有处理器可见。它的开销是四种屏障中最大的。在大多数处理器的实现中，这个屏障是个万能屏障，兼具其它三种内存屏障的功能。</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk/blob/master/src/hotspot/os_cpu/linux_x86/orderAccess_linux_x86.hpp#L40">jdk/orderAccess_linux_x86.hpp at master · openjdk/jdk (github.com)</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::loadload</span><span class="params">()</span>   </span>&#123; <span class="built_in">compiler_barrier</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::storestore</span><span class="params">()</span> </span>&#123; <span class="built_in">compiler_barrier</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::loadstore</span><span class="params">()</span>  </span>&#123; <span class="built_in">compiler_barrier</span>(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">OrderAccess::storeload</span><span class="params">()</span>  </span>&#123; <span class="built_in">fence</span>();            &#125;</span><br></pre></td></tr></table></figure>

<p>至于为什么storeload是fence()而其他的是compiler_barrier()，就和x86平台的invalidate queue和store buffer有关了，又会牵扯到MESI缓存一致性协议，这里就不展开了。</p>
<p>当上面单例模式加上volatile之后，变量的初始化和引用赋值将会被禁止重排序，这时就不会再发生上文所说的使用到未初始化完成的对象的问题了。</p>
<p>上面的文章中提到了通过Unsafe. putOrderedObject来对volatile进行优化。</p>
<p>重点的就是下面的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SomeThing</span> <span class="variable">temp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SomeThing</span>();</span><br><span class="line">    unsafe.putOrderedObject(<span class="built_in">this</span>, valueOffset, <span class="literal">null</span>);    <span class="comment">//将value赋null值只是一项无用操作，实际利用的是这条语句的内存屏障</span></span><br><span class="line">    object = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当调用unsafe.putOrderedObject之后，上面的new操作和下面的object = temp之间就隔了一个StoreStore内存屏障，这时就不会出现new未初始化完成就赋值的问题了。</p>
<p>还有一种利用局部变量来减轻volatile影响的优化方案，在Spring中的单例模式中有很好地体现。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/blob/main/spring-beans/src/main/java/org/springframework/beans/factory/support/DefaultSingletonBeanRegistry.java">spring-framework/DefaultSingletonBeanRegistry.java at main · spring-projects/spring-framework (github.com)</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName, <span class="type">boolean</span> allowEarlyReference)</span> &#123;</span><br><span class="line">    <span class="comment">// Quick check for existing instance without full singleton lock</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">singletonObject</span> <span class="operator">=</span> <span class="built_in">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        singletonObject = <span class="built_in">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>.singletonObjects) &#123;</span><br><span class="line">                <span class="comment">// Consistent creation of early reference within full singleton lock</span></span><br><span class="line">                singletonObject = <span class="built_in">this</span>.singletonObjects.get(beanName);</span><br><span class="line">                <span class="keyword">if</span> (singletonObject == <span class="literal">null</span>) &#123;</span><br><span class="line">                    singletonObject = <span class="built_in">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">                    <span class="keyword">if</span> (singletonObject == <span class="literal">null</span>) &#123;</span><br><span class="line">                        ObjectFactory&lt;?&gt; singletonFactory = <span class="built_in">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                        <span class="keyword">if</span> (singletonFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">                            singletonObject = singletonFactory.getObject();</span><br><span class="line">                            <span class="built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                            <span class="built_in">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里利用了一个singletonObject来当做局部变量，这时在代码中进行创建的时候就不会因为外部变量的volatile而导致代码中频繁出现内存屏障，提高了性能。</p>
<h2 id="内存可见性"><a href="#内存可见性" class="headerlink" title="内存可见性"></a>内存可见性</h2><p>接下来看另外一个例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;进入循环&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (flag) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;退出循环&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            flag = <span class="literal">false</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;已经将flag设置为false&quot;</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，理论上应该当第二个线程睡眠1秒后，将flag设置为false，第一个线程就应该退出循环。</p>
<p>但是第一个线程却没有退出。</p>
<p><img src="https://i.328888.xyz/2023/03/30/iCEOtZ.jpeg" alt="iCEOtZ.jpeg"></p>
<p>这里就需要提到Java的内存模型，也就是JMM（Java Memory Model）。</p>
<p>关于JMM，这里也有一篇文章讲的比较好。</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/29881777">Java内存模型（JMM）总结 - 知乎 (zhihu.com)</a></p>
<p>JMM规定，所有的变量都存储在主内存中，每一个线程都有一个私有的本地内存，线程对变量的操作必须在本地内存中进行。</p>
<p>因此上面的代码中，由于线程一将flag进行了缓存，被JIT优化之后，就只会读取寄存器中的值，因此不会退出循环。</p>
<p>加上volatile之后，每次读取都会从主存中刷新，就不会再出现这样的问题了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/28/java-generic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/28/java-generic/" class="post-title-link" itemprop="url">Java泛型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-28 02:32:48" itemprop="dateCreated datePublished" datetime="2022-05-28T02:32:48+08:00">2022-05-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-04-02 15:13:48" itemprop="dateModified" datetime="2023-04-02T15:13:48+08:00">2023-04-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="泛型概述"><a href="#泛型概述" class="headerlink" title="泛型概述"></a>泛型概述</h1><p>泛型是现代编程语言中的重要特性，简单来说就是不必指定类型，可以写出非特定类型，模板化的代码，提高代码重用率。</p>
<p>泛型应用最广的地方应该就是容器类了。在Java的容器类中大量的使用了泛型。</p>
<p>例如ArrayList</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayList</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractList</span>&lt;E&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">List</span>&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable</span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@java</span>.io.Serial</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8683452581122892189L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default initial capacity.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CAPACITY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Shared empty array instance used for empty instances.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Shared empty array instance used for default sized empty instances. We</span></span><br><span class="line"><span class="comment">     * distinguish this from EMPTY_ELEMENTDATA to know how much to inflate when</span></span><br><span class="line"><span class="comment">     * first element is added.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The array buffer into which the elements of the ArrayList are stored.</span></span><br><span class="line"><span class="comment">     * The capacity of the ArrayList is the length of this array buffer. Any</span></span><br><span class="line"><span class="comment">     * empty ArrayList with elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span></span><br><span class="line"><span class="comment">     * will be expanded to DEFAULT_CAPACITY when the first element is added.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> Object[] elementData; <span class="comment">// non-private to simplify nested class access</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The size of the ArrayList (the number of elements it contains).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> size;</span><br></pre></td></tr></table></figure>

<p>可以看到ArrayList存放数据本质就是一个Object数组elementData，因此，如果不使用泛型，直接存储Object。比如将String类型放入容器，那么在get函数取出元素时类型为Object，这时候就需要强制转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ArrayList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">list.add(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> (String) list.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>如何这个容器中还存在其他类型的元素，那么取出元素时就很容易出现ClassCastException异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list.add(<span class="number">123</span>);</span><br><span class="line">str = (String) list.get(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>当然，如果只写一个专门存储String或者Integer的ArrayList也可以，但是这样就需要给每一个类型都写单独编写，更别提还有自己写的类。</p>
<p>因此，泛型就出现了，泛型类可以在编译阶段就检查类型，这样就不会导致类型转换的异常。</p>
<p>下面是一个最简单的泛型类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Generic</span>&lt;T&gt;&#123; </span><br><span class="line">    <span class="keyword">private</span> T val;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Generic</span><span class="params">(T val)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getVal</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="泛型擦除"><a href="#泛型擦除" class="headerlink" title="泛型擦除"></a>泛型擦除</h1><p><strong>泛型擦除</strong>是指Java中的泛型只在编译期有效，在运行期间会被删除。</p>
<p>如下面这段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Foo</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(List&lt;String&gt; stringList)</span>&#123;  </span><br><span class="line"></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(List&lt;Integer&gt; integerList)</span> &#123;  </span><br><span class="line"></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>这段代码会报错，方法不能重载，原因就是上面两个方法，在编译后被泛型擦除，最后都是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(List)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>因此不能区分两个函数。</p>
<h2 id="泛型类的继承"><a href="#泛型类的继承" class="headerlink" title="泛型类的继承"></a>泛型类的继承</h2><p>泛型类的继承关系不是由泛型类型决定的，如List&lt;Integer&gt;和List&lt;Number&gt;，虽然Integer继承自Number，但是List&lt;Integer&gt;和List&lt;Number&gt;并没有继承关系。</p>
<p>要想使两个泛型类具有继承关系，只能使两个泛型类本身之间继承，或实现接口。</p>
<p>如上面的ArrayList就继承了AbstractList&lt;E&lt;以及List&lt;E&lt;接口。</p>
<h1 id="泛型的逆变和协变"><a href="#泛型的逆变和协变" class="headerlink" title="泛型的逆变和协变"></a>泛型的逆变和协变</h1><p>先从一个数组说起，Java的数组是协变的。</p>
<p>看下面这段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Number[] arr = <span class="keyword">new</span> <span class="title class_">Integer</span>[<span class="number">2</span>];</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        arr[<span class="number">1</span>] = <span class="number">0.5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码在编译器并不会出错，但是一旦运行，将会抛出一个异常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.ArrayStoreException: java.lang.Double</span><br><span class="line">    at Test.main(Test.java:5)</span><br></pre></td></tr></table></figure>

<p>这是因为Integer是Number的子类型，因此Integer[]也是Number[]的子类型，这样的性质被称为协变，在编译器并没有检查出错误。</p>
<p>但是在运行时，jvm虚拟机发现这个arr其实是一个Integer类型的数组，不是Number类型，所以不能存放进入double类型的数字，因此抛出了一个异常。</p>
<h2 id="泛型的不变性"><a href="#泛型的不变性" class="headerlink" title="泛型的不变性"></a>泛型的不变性</h2><p>因此，在吸取了上面的教训之后，泛型被设计为不变，也就是说，List&lt;Integer&gt;并不是List&lt;Number&gt;的子类型。</p>
<p>这样在编译器就可以检查出错误，防止运行期再报错。</p>
<p>但是这样就引入一个新的问题，如何才能实现协变呢。</p>
<p>协变在Java中还是很常用的，比如我只想要一个Fruit集合，里面存放着水果，但我不想管里面到底存放的是哪种水果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">(List&lt;Fruit&gt; list)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时，泛型的不变性就带来了麻烦，加入我现在有一个List&lt;Apple&gt;，因为List&lt;Fruit&gt;并不是List&lt;Apple&gt;的父类型，参数就传递不进去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Apple&gt; appleList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Apple&gt;;</span><br><span class="line">consume(appleList); <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>

<p>因此，在泛型中如何实现协变就成为了一个问题。</p>
<p>还有一种情况，如果我们希望往List&lt;Object&gt;中放水果，使用一个produce函数将所有List&lt;Apple&gt;或者List&lt;Banana&gt;的元素全部添加到List&lt;Object&gt;，但又希望在produce函数中向容器添加非Fruit的其他元素时进行检查并报错，这时候就需要逆变。</p>
<h3 id="泛型通配符"><a href="#泛型通配符" class="headerlink" title="泛型通配符"></a>泛型通配符</h3><p>要实现泛型协变和逆变，这时通配符 ? 就派上用场了。</p>
<ul>
<li><code>&lt;? extends&gt;</code>实现了泛型的协变</li>
<li><code>&lt;? super&gt;</code>实现了泛型的逆变</li>
</ul>
<p>在上面的代码中，假如在consume函数中我们想传入参数，就需要把List&lt;Fruit&gt;改为List&lt;? extends Fruit&gt;。这样就不会产生报错了。</p>
<p>List&lt;? extends Fruit&gt;，其中&lt;? extends Fruit&gt;代表的类型为：Fruit及其子类型，此时传入List&lt;Apple&gt;就没有问题了。</p>
<p>但是当List&lt;Apple&gt;协变为List&lt;? extends Fruit&gt;之后，就不能往容器中再放入元素了。</p>
<p>原因在于，当容器协变后，List&lt;? extends Fruit&gt;中的类型不能再被确定为Apple，&lt;? extends Fruit&gt;虽然包含Apple，但是并不特指为Apple。因此，如果放入一个其他的类型，比如Banana，那么在使用上一个List&lt;Apple&gt;进行读取的时候就会出现类型转换错误。</p>
<p>同样的，如果希望往Fruit中放水果，就可以使用&lt;? super Fruit&gt;让List&lt;Object&gt;逆变为List&lt;? super Fruit&gt;，这样在函数中就可以调用add方法。</p>
<p>从上面的例子可以看出，<code>extends</code>确定了泛型的上界，而<code>super</code>确定了泛型的下界。</p>
<h1 id="PECS"><a href="#PECS" class="headerlink" title="PECS"></a>PECS</h1><p>究竟什么时候使用extends，什么时候使用super。也就是PECS</p>
<blockquote>
<p>PECS: producer-extends, consumer-super.</p>
</blockquote>
<p>生产者使用extends，因为协变只可读取，不可写入。消费者使用super，因为super写入可以保证类型检查。</p>
<p>在Collections中的copy函数就很好地诠释了PECS</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(List&lt;? <span class="built_in">super</span> T&gt; dest, List&lt;? extends T&gt; src)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">srcSize</span> <span class="operator">=</span> src.size();</span><br><span class="line">    <span class="keyword">if</span> (srcSize &gt; dest.size())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;Source does not fit in dest&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (srcSize &lt; COPY_THRESHOLD ||</span><br><span class="line">        (src <span class="keyword">instanceof</span> RandomAccess &amp;&amp; dest <span class="keyword">instanceof</span> RandomAccess)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;srcSize; i++)</span><br><span class="line">            dest.set(i, src.get(i));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ListIterator&lt;? <span class="built_in">super</span> T&gt; di=dest.listIterator();</span><br><span class="line">        ListIterator&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; si=src.listIterator();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;srcSize; i++) &#123;</span><br><span class="line">            di.next();</span><br><span class="line">            di.set(si.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，src使用extends进行协变，只可读取，dest使用super进行逆变，保证写入的类型检查。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/22/java-aqs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/22/java-aqs/" class="post-title-link" itemprop="url">Java AQS原理以及应用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-22 06:37:19" itemprop="dateCreated datePublished" datetime="2022-03-22T06:37:19+08:00">2022-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-28 13:48:52" itemprop="dateModified" datetime="2023-03-28T13:48:52+08:00">2023-03-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Java中最常用的锁ReentrantLock就是基于AQS来实现的。网上已经有很多的资料来讲解AQS的原理。因此这里只是写一下个人比较难以理解的点，用以学习。</p>
<p>这里贴一篇非常好的AQS的文章，讲的非常详细，看完了还是可以学到很多东西。</p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2019/12/05/aqs-theory-and-apply.html">从ReentrantLock的实现看AQS的原理及应用 - 美团技术团队 (meituan.com)</a></p>
<p>这里就记录下ReentrantLock的非公平锁。</p>
<p>首先是acquire(int)函数，当tryAcquire函数获取锁失败后，将会把线程加入等待队列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键就在于这个acquireQueued函数，addWaiter()函数就是新建一个节点，然后将节点放入等待队列的末尾，上面放的那篇文章已经非常详细，这里就不写了。</p>
<p>接下来看看acquireQueued()函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Acquires in exclusive uninterruptible mode for thread already in</span></span><br><span class="line"><span class="comment"> * queue. Used by condition wait methods as well as acquire.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node the node</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arg the acquire argument</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if interrupted while waiting</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以看到进入函数之后，会进入自旋，首先找到前驱节点，如果前驱节点已经是head虚节点了，即当前线程可以获得锁，则调用tryAcquire()函数尝试获取锁。获取成功则将当前节点设置为虚节点，然后退出自旋，返回线程是否被中断。</p>
<p>如果前驱节点不是head，那么将会进入shouldParkAfterFailedAcquire()函数，该函数用于判断线程是否应该被阻塞。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks and updates status for a node that failed to acquire.</span></span><br><span class="line"><span class="comment"> * Returns true if thread should block. This is the main signal</span></span><br><span class="line"><span class="comment"> * control in all acquire loops.  Requires that pred == node.prev.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pred node&#x27;s predecessor holding status</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node the node</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if thread should block</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This node has already set status asking a release</span></span><br><span class="line"><span class="comment">         * to signal it, so it can safely park.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Predecessor was cancelled. Skip over predecessors and</span></span><br><span class="line"><span class="comment">         * indicate retry.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * waitStatus must be 0 or PROPAGATE.  Indicate that we</span></span><br><span class="line"><span class="comment">         * need a signal, but don&#x27;t park yet.  Caller will need to</span></span><br><span class="line"><span class="comment">         * retry to make sure it cannot acquire before parking.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入后先检测前驱节点的状态ws。</p>
<p>下面是waitStatus的常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Marker to indicate a node is waiting in exclusive mode */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** waitStatus value to indicate thread has cancelled */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span>  <span class="number">1</span>;</span><br><span class="line"><span class="comment">/** waitStatus value to indicate successor&#x27;s thread needs unparking */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span>    <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="comment">/** waitStatus value to indicate thread is waiting on condition */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * waitStatus value to indicate the next acquireShared should</span></span><br><span class="line"><span class="comment"> * unconditionally propagate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>当前驱节点已经是唤醒状态，也就是Node.SIGNAL的情况下，当前线程就可以直接阻塞，返回true。</p>
</li>
<li><p>如果ws大于0，即前驱节点为取消状态，那么就进入do-while循环，不断寻找前驱节点，直到找到一个不是取消状态的节点。然后将不是取消状态的节点的next直接指向当前节点（也就是直接跳过中间被取消的节点）。</p>
</li>
<li><p>否则代表其他状态，则通过cas尝试将状态设置为SIGNAL。</p>
</li>
</ol>
<p>当返回true以后，将会调用parkAndCheckInterrupt()函数，这里进入后会调用unsafe的park方法，将线程阻塞。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LockSupport.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">park</span><span class="params">(Object blocker)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    setBlocker(t, blocker);</span><br><span class="line">    UNSAFE.park(<span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">    setBlocker(t, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里将会设置阻塞对象parkBlocker，这是一个Thread类的私有成员。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setBlocker</span><span class="params">(Thread t, Object arg)</span> &#123;</span><br><span class="line">    <span class="comment">// Even though volatile, hotspot doesn&#x27;t need a write barrier here.</span></span><br><span class="line">    UNSAFE.putObject(t, parkBlockerOffset, arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置完成后就调用UNSAFE.park()阻塞线程。</p>
<p>这里的parkBlocker是用来记录线程是被哪个对象阻塞的，用于线程监控和分析，通过LockSupport.getBlocker()函数就可以获取parkBlocker。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/20/pest-identification/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/20/pest-identification/" class="post-title-link" itemprop="url">第十届中国“软件杯” A4林业有害生物智能识别国家二等奖总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-20 07:11:26" itemprop="dateCreated datePublished" datetime="2021-10-20T07:11:26+08:00">2021-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-04-03 11:04:32" itemprop="dateModified" datetime="2023-04-03T11:04:32+08:00">2023-04-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>软件杯经过了几个月的竞赛和答辩过后，总算是获得了一个相对比较满意的成绩。</p>
<p>我们组的名字叫P5天下第一，回过头看这个名字实在是有种说不出的感觉（索尼罪大恶极），我的P5都还在PS4里吃灰，结果后面直接上了XGP，还是P5R，只能说《Only On PlayStation For A While》。</p>
<p>回到正题。首先还是来讲讲数据库和后端的方案吧。</p>
<p>下面是整体的架构图设计</p>
<p><img src="https://i.imgtg.com/2023/03/20/911cG.png" alt="911cG.png"></p>
<h2 id="Pest-Identification-Provider"><a href="#Pest-Identification-Provider" class="headerlink" title="Pest-Identification-Provider"></a>Pest-Identification-Provider</h2><p>数据库其实很简单，就是一个用户表，还有害虫的目科属种的信息表，以及关联表。</p>
<p><img src="https://i.imgtg.com/2023/03/20/91NO1.png" alt="91NO1.png"></p>
<p>后端采用spring cloud + nacos的方案。分为provider和consumer，然后通过spring gateway网关进行负载均衡。</p>
<p><img src="https://i.imgtg.com/2023/03/20/9iZGD.jpg" alt="9iZGD.jpg"></p>
<p>YoloV4图像识别模块也通过gunicorn实现了负载均衡。</p>
<p>用户登录后台采用的是jwtToken + Spring security实现权限校验。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.configs;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-09 18:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomUserDetainsService userDetainsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CsrfProperties csrfProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomCorsFilter customCorsFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtils jwtTokenUtils;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;userServiceImpl&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.cors().and()</span><br><span class="line">                <span class="comment">//添加cors响应头</span></span><br><span class="line">                .addFilterAfter(customCorsFilter, HeaderWriterFilter.class)</span><br><span class="line">                <span class="comment">//添加token登录过滤器</span></span><br><span class="line">                .addFilterBefore(<span class="keyword">new</span> <span class="title class_">TokenLoginFilter</span>(authenticationManager(), jwtTokenUtils), UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                <span class="comment">//添加token认证过滤器</span></span><br><span class="line">                .addFilterBefore(<span class="keyword">new</span> <span class="title class_">TokenAuthenticationFilter</span>(authenticationManager(), jwtTokenUtils, userService), BasicAuthenticationFilter.class).httpBasic()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">//关闭session</span></span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(HttpMethod.OPTIONS).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(HttpMethod.GET, <span class="string">&quot;/species/*&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/imgFake&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().hasRole(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (csrfProperties.getCsrfDisabled()) &#123;</span><br><span class="line">            http.csrf().disable();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetainsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        web.ignoring()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/v2/api-docs&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/swagger-resources/configuration/ui&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/swagger-resources&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/swagger-resources/configuration/security&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/swagger-ui.html&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/webjars/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BCryptPasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在spring security中添加了两个过滤器，一个Token登录过滤器，一个Token认证过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.filters;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-15 19:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenLoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenUtils jwtTokenUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenLoginFilter</span><span class="params">(AuthenticationManager authenticationManager, JwtTokenUtils jwtTokenUtils)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">        <span class="built_in">this</span>.jwtTokenUtils = jwtTokenUtils;</span><br><span class="line">        <span class="built_in">this</span>.setPostOnly(<span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.setRequiresAuthenticationRequestMatcher(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;POST&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        Map&lt;String, String[]&gt; map = req.getParameterMap();</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> map.get(<span class="string">&quot;username&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> map.get(<span class="string">&quot;password&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(username, password, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        <span class="keyword">return</span> authenticationManager.authenticate(<span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user.getUsername(), user.getPassword(), <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication auth)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) auth.getPrincipal();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> jwtTokenUtils.generateToken(user.getUsername());</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">        map.put(<span class="string">&quot;username&quot;</span>, user.getUsername());</span><br><span class="line">        ResponseUtils.out(response, ResBody.success(map));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">unsuccessfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException failed)</span> &#123;</span><br><span class="line">        ResponseUtils.out(response, ResBody.error(<span class="keyword">new</span> <span class="title class_">BizException</span>(ExceptionsEnum.LOGIN_FAILED)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TokenLoginFilter中有一个JwtTokenUtils，当尝试登录时，将会先调用attemptAuthentication函数，对比账号和密码后将会调用successfulAuthentication函数根据用户名生成一个token，然后返回到前端。</p>
<p>密码采用默认的BCryptPasswordEncoder进行加密。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> BCryptPasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据库采用的是MySQL + mybatis plus。</p>
<p>整体就是采用MVC架构，在controller中定义接口，然后在service中进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.controller;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-08 13:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/family&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FamilyController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Qualifier(&quot;familyServiceImpl&quot;)</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FamilyService familyService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;familyGenusVoServiceImpl&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> FamilyGenusVoService familyGenusVoService;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过id查询科</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据id查询科&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectFamiliesById</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResBody.success(familyVoService.selectFamiliesById(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有科</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageNum  当前查询起始页</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageSize 需要的页数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;all&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;查询所有科&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectAllFamilies</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> pageNum, <span class="meta">@RequestParam</span> <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResBody.success(familyVoService.selectAllFamilies(pageNum, pageSize));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;name&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据名称查询&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectFamiliesByName</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> pageNum, <span class="meta">@RequestParam</span> <span class="type">int</span> pageSize, <span class="meta">@RequestParam</span> String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResBody.success(familyVoService.selectFamiliesByName(pageNum, pageSize, name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p>在这里定义了一个统一的返回值ResBody，这样在前端处理会更方便，并且不需要处理null值的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.exceptions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-09 10:42</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResBody</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Object&gt; RESULT_HOLDER = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        RESULT_HOLDER.put(<span class="string">&quot;pages&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        RESULT_HOLDER.put(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> resBody</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResBody&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> resBody</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResBody&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        ResBody&lt;T&gt; rb = <span class="keyword">new</span> <span class="title class_">ResBody</span>&lt;&gt;();</span><br><span class="line">        rb.setCode(ExceptionsEnum.SUCCESS.getResCode());</span><br><span class="line">        rb.setMessage(ExceptionsEnum.SUCCESS.getResMsg());</span><br><span class="line">        rb.setResult(data);</span><br><span class="line">        <span class="keyword">return</span> rb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResBody&lt;T&gt; <span class="title function_">error</span><span class="params">(BizException errorInfo)</span> &#123;</span><br><span class="line">        ResBody&lt;T&gt; rb = <span class="keyword">new</span> <span class="title class_">ResBody</span>&lt;&gt;();</span><br><span class="line">        rb.setCode(errorInfo.getExp().getResCode());</span><br><span class="line">        rb.setMessage(errorInfo.getExp().getResMsg());</span><br><span class="line">        rb.setResult(RESULT_HOLDER);</span><br><span class="line">        <span class="keyword">return</span> rb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResBody&lt;T&gt; <span class="title function_">error</span><span class="params">(<span class="type">int</span> errorCode, String errorInfo)</span> &#123;</span><br><span class="line">        ResBody&lt;T&gt; rb = <span class="keyword">new</span> <span class="title class_">ResBody</span>&lt;&gt;();</span><br><span class="line">        rb.setCode(errorCode);</span><br><span class="line">        rb.setMessage(errorInfo);</span><br><span class="line">        rb.setResult(RESULT_HOLDER);</span><br><span class="line">        <span class="keyword">return</span> rb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ResBody&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;code=&quot;</span> + code +</span><br><span class="line">                <span class="string">&quot;, message=&#x27;&quot;</span> + message + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, result=&quot;</span> + result +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目中还使用了全局异常处理中心来对不同的异常进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.exceptions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DuplicateKeyException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-09 10:38</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 全局异常处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = BizException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;BizException&gt; <span class="title function_">bizExceptionHandler</span><span class="params">(HttpServletRequest req, BizException e)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Message: &quot;</span> + e.getMessage());</span><br><span class="line">        log.debug(<span class="string">&quot;Cause: &quot;</span> + e.getCause());</span><br><span class="line">        <span class="keyword">return</span> ResBody.error(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = NullPointerException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;NullPointerException&gt; <span class="title function_">nullPointerExceptionHandler</span><span class="params">(HttpServletRequest req, NullPointerException e)</span> &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.debug(<span class="string">&quot;Message: &quot;</span> + e.getMessage());</span><br><span class="line">        log.debug(<span class="string">&quot;Cause: &quot;</span> + e.getCause());</span><br><span class="line">        <span class="keyword">return</span> ResBody.error(<span class="number">50001</span>, <span class="string">&quot;空指针异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = DuplicateKeyException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;DuplicateKeyException&gt; <span class="title function_">duplicateKeyExceptionHandler</span><span class="params">(HttpServletRequest req, DuplicateKeyException e)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Message: &quot;</span> + e.getMessage());</span><br><span class="line">        log.debug(<span class="string">&quot;Cause: &quot;</span> + e.getCause());</span><br><span class="line">        <span class="keyword">return</span> ResBody.error(<span class="keyword">new</span> <span class="title class_">BizException</span>(ExceptionsEnum.INVALID_ID));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;Exception&gt; <span class="title function_">exceptionHandler</span><span class="params">(HttpServletRequest req, Exception e)</span> &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;Message: &quot;</span> + e.getMessage());</span><br><span class="line">        log.error(<span class="string">&quot;Cause: &quot;</span> + e.getCause());</span><br><span class="line">        <span class="keyword">return</span> ResBody.error(<span class="keyword">new</span> <span class="title class_">BizException</span>(ExceptionsEnum.DATABASE_FAILED));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上基本上是provider的设计方案。</p>
<h2 id="Pest-Identification-Consumer"><a href="#Pest-Identification-Consumer" class="headerlink" title="Pest-Identification-Consumer"></a>Pest-Identification-Consumer</h2><p>接下来在consumer端，其实就是对provider的进一步封装。通过OpenFegin来进行远程调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;pest-identification-provider&quot;, configuration = FeignConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FamilyClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/family&quot;)</span></span><br><span class="line">    ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectFamiliesById</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/family/all&quot;)</span></span><br><span class="line">    ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectAllFamilies</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> pageNum, <span class="meta">@RequestParam</span> <span class="type">int</span> pageSize)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/family/name&quot;)</span></span><br><span class="line">    ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectFamiliesByName</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> pageNum, <span class="meta">@RequestParam</span> <span class="type">int</span> pageSize, <span class="meta">@RequestParam</span> String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/family/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    ResBody&lt;Integer&gt; <span class="title function_">insertFamily</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> orderId, <span class="meta">@RequestBody</span> Family family)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/family&quot;)</span></span><br><span class="line">    ResBody&lt;Integer&gt; <span class="title function_">updateFamily</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> orderId, <span class="meta">@RequestBody</span> Family newFamily)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/family&quot;)</span></span><br><span class="line">    ResBody&lt;Integer&gt; <span class="title function_">deleteFamilyById</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Pest-Identification-Gateway"><a href="#Pest-Identification-Gateway" class="headerlink" title="Pest-Identification-Gateway"></a>Pest-Identification-Gateway</h2><p>网关这里其实Spring已经给出了很方便的解决方案。只需要在配置文件中配好负载均衡，在nacos就可以实现。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pest-identification-gateway</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">consumer</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pest-identification-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/**</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">connect-timeout:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">response-timeout:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>

<h2 id="YoloV4网络"><a href="#YoloV4网络" class="headerlink" title="YoloV4网络"></a>YoloV4网络</h2><p>这次竞赛有一个很大的难题，也就是图像识别的问题。这里我采用的是YoloV4框架来进行目标检测。由于这次竞赛还需要实现离线识别，因此在安卓客户端使用了YoloV5框架来实现断网情况下的识别。</p>
<p>首先说说YoloV4框架，在这次竞赛中，我使用了flask框架来对外提供识别api。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/startPredict&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_predict</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    开始对img/$&#123;ip&#125;中的图片进行预测，返回预测结果</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ret = &#123;&#125;</span><br><span class="line">    each_statistics: <span class="built_in">dict</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> pictures:</span><br><span class="line">        <span class="keyword">return</span> resp_utils.error(<span class="string">&#x27;还未上传文件&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> pictures:</span><br><span class="line">        info = load_index(each)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> info:</span><br><span class="line">            each_statistics, base64_str = predict.predict_img(each)</span><br><span class="line">            ret[os.path.basename(each)] = &#123;<span class="string">&#x27;statistics&#x27;</span>: each_statistics, <span class="string">&#x27;img&#x27;</span>: base64_str&#125;</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;error&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> each_statistics:</span><br><span class="line">                save_index(each, base64_str, each_statistics)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            each_statistics = info[<span class="string">&#x27;statistics&#x27;</span>]</span><br><span class="line">            base64_str = info[<span class="string">&#x27;img&#x27;</span>]</span><br><span class="line">            ret[os.path.basename(each)] = &#123;<span class="string">&#x27;statistics&#x27;</span>: each_statistics, <span class="string">&#x27;img&#x27;</span>: base64_str&#125;</span><br><span class="line">    pictures.clear()</span><br><span class="line">    <span class="keyword">return</span> resp_utils.success(ret)</span><br></pre></td></tr></table></figure>

<p>YoloV4框架采用pytorch实现。这里先贴一张YoloV4的架构图。图片来自 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44791964/article/details/106533581">睿智的目标检测32——TF2搭建YoloV4目标检测平台（tensorflow2）_Bubbliiiing的博客-CSDN博客</a></p>
<p>这位Bubbliiiing真的让我学到了很多，他在B站也有关于YoloV4的教程，看了他的视频，我觉得受益匪浅。<a target="_blank" rel="noopener" href="https://space.bilibili.com/472467171">Bubbliiiing的个人空间_哔哩哔哩_bilibili</a></p>
<p><img src="https://i.imgtg.com/2023/03/20/9nwxC.png" alt="9nwxC.png"></p>
<p>具体的介绍可以参考这里</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/372402239">YOLOV4 pytorch实现流程 - 知乎 (zhihu.com)</a></p>
<p>首先是实现CSPdarknet，定义MISH激活函数，以及实现基本的卷积操作，最后再实现一个完整的CSPdarknet。</p>
<p><strong>这里不得不说pytorch实在是太方便了，只要继承nn.Module，然后写forward就可以了。之前TensorFlow折腾了好久，不同的backend，不同的版本居然都不兼容，坑太多了。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># MISH激活函数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mish</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Mish, self).__init__()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> x * torch.tanh(F.softplus(x))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conv2d + BatchNormalization + Mish</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BasicConv</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels, kernel_size, stride=<span class="number">1</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(BasicConv, self).__init__()</span><br><span class="line"></span><br><span class="line">        self.conv = nn.Conv2d(in_channels, out_channels, kernel_size, stride, kernel_size // <span class="number">2</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn = nn.BatchNorm2d(out_channels)</span><br><span class="line">        self.activation = Mish()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv(x)</span><br><span class="line">        x = self.bn(x)</span><br><span class="line">        x = self.activation(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># CSPdarknet</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Resblock</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, channels, hidden_channels=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Resblock, self).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hidden_channels <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            hidden_channels = channels</span><br><span class="line"></span><br><span class="line">        self.block = nn.Sequential(</span><br><span class="line">            BasicConv(channels, hidden_channels, <span class="number">1</span>),</span><br><span class="line">            BasicConv(hidden_channels, channels, <span class="number">3</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> x + self.block(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># CSPdarknet的结构块</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Resblock_body</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels, num_blocks, first</span>):</span><br><span class="line">        <span class="built_in">super</span>(Resblock_body, self).__init__()</span><br><span class="line">        <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   利用一个步长为2x2的卷积块进行高和宽的压缩</span></span><br><span class="line">        <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">        self.downsample_conv = BasicConv(in_channels, out_channels, <span class="number">3</span>, stride=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> first:</span><br><span class="line">            <span class="comment"># --------------------------------------------------------------------------#</span></span><br><span class="line">            <span class="comment">#   然后建立一个大的残差边self.split_conv0、这个大残差边绕过了很多的残差结构</span></span><br><span class="line">            <span class="comment"># --------------------------------------------------------------------------#</span></span><br><span class="line">            self.split_conv0 = BasicConv(out_channels, out_channels, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">            <span class="comment">#   主干部分会对num_blocks进行循环，循环内部是残差结构。</span></span><br><span class="line">            <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">            self.split_conv1 = BasicConv(out_channels, out_channels, <span class="number">1</span>)</span><br><span class="line">            self.blocks_conv = nn.Sequential(</span><br><span class="line">                Resblock(channels=out_channels, hidden_channels=out_channels // <span class="number">2</span>),</span><br><span class="line">                BasicConv(out_channels, out_channels, <span class="number">1</span>)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            self.concat_conv = BasicConv(out_channels * <span class="number">2</span>, out_channels, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># --------------------------------------------------------------------------#</span></span><br><span class="line">            <span class="comment">#   然后建立一个大的残差边self.split_conv0、这个大残差边绕过了很多的残差结构</span></span><br><span class="line">            <span class="comment"># --------------------------------------------------------------------------#</span></span><br><span class="line">            self.split_conv0 = BasicConv(out_channels, out_channels // <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">            <span class="comment">#   主干部分会对num_blocks进行循环，循环内部是残差结构。</span></span><br><span class="line">            <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">            self.split_conv1 = BasicConv(out_channels, out_channels // <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">            self.blocks_conv = nn.Sequential(</span><br><span class="line">                *[Resblock(out_channels // <span class="number">2</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_blocks)],</span><br><span class="line">                BasicConv(out_channels // <span class="number">2</span>, out_channels // <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            self.concat_conv = BasicConv(out_channels, out_channels, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.downsample_conv(x)</span><br><span class="line"></span><br><span class="line">        x0 = self.split_conv0(x)</span><br><span class="line"></span><br><span class="line">        x1 = self.split_conv1(x)</span><br><span class="line">        x1 = self.blocks_conv(x1)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ------------------------------------#</span></span><br><span class="line">        <span class="comment">#   将大残差边再堆叠回来</span></span><br><span class="line">        <span class="comment"># ------------------------------------#</span></span><br><span class="line">        x = torch.cat([x1, x0], dim=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># ------------------------------------#</span></span><br><span class="line">        <span class="comment">#   最后对通道数进行整合</span></span><br><span class="line">        <span class="comment"># ------------------------------------#</span></span><br><span class="line">        x = self.concat_conv(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># CSPdarknet53</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CSPDarkNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, layers</span>):</span><br><span class="line">        <span class="built_in">super</span>(CSPDarkNet, self).__init__()</span><br><span class="line">        self.inplanes = <span class="number">32</span></span><br><span class="line">        <span class="comment"># 416,416,3 -&gt; 416,416,32</span></span><br><span class="line">        self.conv1 = BasicConv(<span class="number">3</span>, self.inplanes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>)</span><br><span class="line">        self.feature_channels = [<span class="number">64</span>, <span class="number">128</span>, <span class="number">256</span>, <span class="number">512</span>, <span class="number">1024</span>]</span><br><span class="line"></span><br><span class="line">        self.stages = nn.ModuleList([</span><br><span class="line">            <span class="comment"># 416,416,32 -&gt; 208,208,64</span></span><br><span class="line">            Resblock_body(self.inplanes, self.feature_channels[<span class="number">0</span>], layers[<span class="number">0</span>], first=<span class="literal">True</span>),</span><br><span class="line">            <span class="comment"># 208,208,64 -&gt; 104,104,128</span></span><br><span class="line">            Resblock_body(self.feature_channels[<span class="number">0</span>], self.feature_channels[<span class="number">1</span>], layers[<span class="number">1</span>], first=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># 104,104,128 -&gt; 52,52,256</span></span><br><span class="line">            Resblock_body(self.feature_channels[<span class="number">1</span>], self.feature_channels[<span class="number">2</span>], layers[<span class="number">2</span>], first=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># 52,52,256 -&gt; 26,26,512</span></span><br><span class="line">            Resblock_body(self.feature_channels[<span class="number">2</span>], self.feature_channels[<span class="number">3</span>], layers[<span class="number">3</span>], first=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># 26,26,512 -&gt; 13,13,1024</span></span><br><span class="line">            Resblock_body(self.feature_channels[<span class="number">3</span>], self.feature_channels[<span class="number">4</span>], layers[<span class="number">4</span>], first=<span class="literal">False</span>)</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        self.num_features = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                n = m.kernel_size[<span class="number">0</span>] * m.kernel_size[<span class="number">1</span>] * m.out_channels</span><br><span class="line">                m.weight.data.normal_(<span class="number">0</span>, math.sqrt(<span class="number">2.</span> / n))</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.BatchNorm2d):</span><br><span class="line">                m.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv1(x)</span><br><span class="line"></span><br><span class="line">        x = self.stages[<span class="number">0</span>](x)</span><br><span class="line">        x = self.stages[<span class="number">1</span>](x)</span><br><span class="line">        out3 = self.stages[<span class="number">2</span>](x)</span><br><span class="line">        out4 = self.stages[<span class="number">3</span>](out3)</span><br><span class="line">        out5 = self.stages[<span class="number">4</span>](out4)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out3, out4, out5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">darknet53</span>(<span class="params">pretrained</span>):</span><br><span class="line">    model = CSPDarkNet([<span class="number">1</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">4</span>])</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(pretrained, <span class="built_in">str</span>):</span><br><span class="line">            model.load_state_dict(torch.load(pretrained))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;darknet request a pretrained path. got [&#123;&#125;]&quot;</span>.<span class="built_in">format</span>(pretrained))</span><br><span class="line">    <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>

<p>然后再实现yolov4的框架，包括上图中的SPP和PANet，最后输出三个特征层Yolo head。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> nets.CSPdarknet <span class="keyword">import</span> darknet53</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv2d</span>(<span class="params">filter_in, filter_out, kernel_size, stride=<span class="number">1</span></span>):</span><br><span class="line">    pad = (kernel_size - <span class="number">1</span>) // <span class="number">2</span> <span class="keyword">if</span> kernel_size <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(OrderedDict([</span><br><span class="line">        (<span class="string">&quot;conv&quot;</span>, nn.Conv2d(filter_in, filter_out, kernel_size=kernel_size, stride=stride, padding=pad, bias=<span class="literal">False</span>)),</span><br><span class="line">        (<span class="string">&quot;bn&quot;</span>, nn.BatchNorm2d(filter_out)),</span><br><span class="line">        (<span class="string">&quot;relu&quot;</span>, nn.LeakyReLU(<span class="number">0.1</span>)),</span><br><span class="line">    ]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPP结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpatialPyramidPooling</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, pool_sizes=[<span class="number">5</span>, <span class="number">9</span>, <span class="number">13</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>(SpatialPyramidPooling, self).__init__()</span><br><span class="line"></span><br><span class="line">        self.maxpools = nn.ModuleList([nn.MaxPool2d(pool_size, <span class="number">1</span>, pool_size // <span class="number">2</span>) <span class="keyword">for</span> pool_size <span class="keyword">in</span> pool_sizes])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        features = [maxpool(x) <span class="keyword">for</span> maxpool <span class="keyword">in</span> self.maxpools[::-<span class="number">1</span>]]</span><br><span class="line">        features = torch.cat(features + [x], dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卷积 + 上采样</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Upsample</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels</span>):</span><br><span class="line">        <span class="built_in">super</span>(Upsample, self).__init__()</span><br><span class="line"></span><br><span class="line">        self.upsample = nn.Sequential(</span><br><span class="line">            conv2d(in_channels, out_channels, <span class="number">1</span>),</span><br><span class="line">            nn.Upsample(scale_factor=<span class="number">2</span>, mode=<span class="string">&#x27;nearest&#x27;</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, </span>):</span><br><span class="line">        x = self.upsample(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 三次卷积块</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_three_conv</span>(<span class="params">filters_list, in_filters</span>):</span><br><span class="line">    m = nn.Sequential(</span><br><span class="line">        conv2d(in_filters, filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">0</span>], filters_list[<span class="number">1</span>], <span class="number">3</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">1</span>], filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 五次卷积块</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_five_conv</span>(<span class="params">filters_list, in_filters</span>):</span><br><span class="line">    m = nn.Sequential(</span><br><span class="line">        conv2d(in_filters, filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">0</span>], filters_list[<span class="number">1</span>], <span class="number">3</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">1</span>], filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">0</span>], filters_list[<span class="number">1</span>], <span class="number">3</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">1</span>], filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># yolov4的输出</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">yolo_head</span>(<span class="params">filters_list, in_filters</span>):</span><br><span class="line">    m = nn.Sequential(</span><br><span class="line">        conv2d(in_filters, filters_list[<span class="number">0</span>], <span class="number">3</span>),</span><br><span class="line">        nn.Conv2d(filters_list[<span class="number">0</span>], filters_list[<span class="number">1</span>], <span class="number">1</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># yolo_body</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">YoloBody</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_anchors, num_classes</span>):</span><br><span class="line">        <span class="built_in">super</span>(YoloBody, self).__init__()</span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   生成CSPdarknet53的主干模型</span></span><br><span class="line">        <span class="comment">#   获得三个有效特征层，他们的shape分别是：</span></span><br><span class="line">        <span class="comment">#   52,52,256</span></span><br><span class="line">        <span class="comment">#   26,26,512</span></span><br><span class="line">        <span class="comment">#   13,13,1024</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        self.backbone = darknet53(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        self.conv1 = make_three_conv([<span class="number">512</span>, <span class="number">1024</span>], <span class="number">1024</span>)</span><br><span class="line">        self.SPP = SpatialPyramidPooling()</span><br><span class="line">        self.conv2 = make_three_conv([<span class="number">512</span>, <span class="number">1024</span>], <span class="number">2048</span>)</span><br><span class="line"></span><br><span class="line">        self.upsample1 = Upsample(<span class="number">512</span>, <span class="number">256</span>)</span><br><span class="line">        self.conv_for_P4 = conv2d(<span class="number">512</span>, <span class="number">256</span>, <span class="number">1</span>)</span><br><span class="line">        self.make_five_conv1 = make_five_conv([<span class="number">256</span>, <span class="number">512</span>], <span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">        self.upsample2 = Upsample(<span class="number">256</span>, <span class="number">128</span>)</span><br><span class="line">        self.conv_for_P3 = conv2d(<span class="number">256</span>, <span class="number">128</span>, <span class="number">1</span>)</span><br><span class="line">        self.make_five_conv2 = make_five_conv([<span class="number">128</span>, <span class="number">256</span>], <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3*(5+num_classes) = 3*(5+20) = 3*(4+1+20)=75</span></span><br><span class="line">        final_out_filter2 = num_anchors * (<span class="number">5</span> + num_classes)</span><br><span class="line">        self.yolo_head3 = yolo_head([<span class="number">256</span>, final_out_filter2], <span class="number">128</span>)</span><br><span class="line"></span><br><span class="line">        self.down_sample1 = conv2d(<span class="number">128</span>, <span class="number">256</span>, <span class="number">3</span>, stride=<span class="number">2</span>)</span><br><span class="line">        self.make_five_conv3 = make_five_conv([<span class="number">256</span>, <span class="number">512</span>], <span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3*(5+num_classes) = 3*(5+20) = 3*(4+1+20)=75</span></span><br><span class="line">        final_out_filter1 = num_anchors * (<span class="number">5</span> + num_classes)</span><br><span class="line">        self.yolo_head2 = yolo_head([<span class="number">512</span>, final_out_filter1], <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">        self.down_sample2 = conv2d(<span class="number">256</span>, <span class="number">512</span>, <span class="number">3</span>, stride=<span class="number">2</span>)</span><br><span class="line">        self.make_five_conv4 = make_five_conv([<span class="number">512</span>, <span class="number">1024</span>], <span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3*(5+num_classes)=3*(5+20)=3*(4+1+20)=75</span></span><br><span class="line">        final_out_filter0 = num_anchors * (<span class="number">5</span> + num_classes)</span><br><span class="line">        self.yolo_head1 = yolo_head([<span class="number">1024</span>, final_out_filter0], <span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment">#  backbone</span></span><br><span class="line">        x2, x1, x0 = self.backbone(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 13,13,1024 -&gt; 13,13,512 -&gt; 13,13,1024 -&gt; 13,13,512 -&gt; 13,13,2048 </span></span><br><span class="line">        P5 = self.conv1(x0)</span><br><span class="line">        P5 = self.SPP(P5)</span><br><span class="line">        <span class="comment"># 13,13,2048 -&gt; 13,13,512 -&gt; 13,13,1024 -&gt; 13,13,512</span></span><br><span class="line">        P5 = self.conv2(P5)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 13,13,512 -&gt; 13,13,256 -&gt; 26,26,256</span></span><br><span class="line">        P5_upsample = self.upsample1(P5)</span><br><span class="line">        <span class="comment"># 26,26,512 -&gt; 26,26,256</span></span><br><span class="line">        P4 = self.conv_for_P4(x1)</span><br><span class="line">        <span class="comment"># 26,26,256 + 26,26,256 -&gt; 26,26,512</span></span><br><span class="line">        P4 = torch.cat([P4, P5_upsample], axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 26,26,512 -&gt; 26,26,256 -&gt; 26,26,512 -&gt; 26,26,256 -&gt; 26,26,512 -&gt; 26,26,256</span></span><br><span class="line">        P4 = self.make_five_conv1(P4)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 26,26,256 -&gt; 26,26,128 -&gt; 52,52,128</span></span><br><span class="line">        P4_upsample = self.upsample2(P4)</span><br><span class="line">        <span class="comment"># 52,52,256 -&gt; 52,52,128</span></span><br><span class="line">        P3 = self.conv_for_P3(x2)</span><br><span class="line">        <span class="comment"># 52,52,128 + 52,52,128 -&gt; 52,52,256</span></span><br><span class="line">        P3 = torch.cat([P3, P4_upsample], axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 52,52,256 -&gt; 52,52,128 -&gt; 52,52,256 -&gt; 52,52,128 -&gt; 52,52,256 -&gt; 52,52,128</span></span><br><span class="line">        P3 = self.make_five_conv2(P3)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 52,52,128 -&gt; 26,26,256</span></span><br><span class="line">        P3_downsample = self.down_sample1(P3)</span><br><span class="line">        <span class="comment"># 26,26,256 + 26,26,256 -&gt; 26,26,512</span></span><br><span class="line">        P4 = torch.cat([P3_downsample, P4], axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 26,26,512 -&gt; 26,26,256 -&gt; 26,26,512 -&gt; 26,26,256 -&gt; 26,26,512 -&gt; 26,26,256</span></span><br><span class="line">        P4 = self.make_five_conv3(P4)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 26,26,256 -&gt; 13,13,512</span></span><br><span class="line">        P4_downsample = self.down_sample2(P4)</span><br><span class="line">        <span class="comment"># 13,13,512 + 13,13,512 -&gt; 13,13,1024</span></span><br><span class="line">        P5 = torch.cat([P4_downsample, P5], axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 13,13,1024 -&gt; 13,13,512 -&gt; 13,13,1024 -&gt; 13,13,512 -&gt; 13,13,1024 -&gt; 13,13,512</span></span><br><span class="line">        P5 = self.make_five_conv4(P5)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   第三个特征层</span></span><br><span class="line">        <span class="comment">#   y3=(batch_size,75,52,52)</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        out2 = self.yolo_head3(P3)</span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   第二个特征层</span></span><br><span class="line">        <span class="comment">#   y2=(batch_size,75,26,26)</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        out1 = self.yolo_head2(P4)</span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   第一个特征层</span></span><br><span class="line">        <span class="comment">#   y1=(batch_size,75,13,13)</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        out0 = self.yolo_head1(P5)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out0, out1, out2</span><br></pre></td></tr></table></figure>

<p>搭建完成之后就是训练了。</p>
<p>训练采用的是实验室的TITAN RTX，这里我们小组总共找了将近1900张图片，然后手动打标签，不得不说那一周看虫子都快看吐了。</p>
<p><img src="https://i.imgtg.com/2023/03/20/91pvg.jpg" alt="91pvg.jpg"></p>
<p><img src="https://i.imgtg.com/2023/03/20/91e7I.jpg" alt="91e7I.jpg"></p>
<p>最后通过脚本扫描所有的图片，将对应的xml标记文件对应。</p>
<p><img src="https://i.imgtg.com/2023/03/20/91rLD.jpg" alt="91rLD.jpg"></p>
<p>然后开始训练</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">start_train</span>(<span class="params">queue=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">global</span> model, __iterationCount</span><br><span class="line">    __iterationCount = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># classes和anchor的路径</span></span><br><span class="line">    anchors_path = <span class="string">&#x27;model_data/yolo_anchors.txt&#x27;</span></span><br><span class="line">    classes_path = <span class="string">&#x27;model_data/all_classes.txt&#x27;</span></span><br><span class="line">    <span class="comment"># 获取classes和anchor</span></span><br><span class="line">    class_names = get_classes(classes_path)</span><br><span class="line">    anchors = get_anchors(anchors_path)</span><br><span class="line">    num_classes = <span class="built_in">len</span>(class_names)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建yolo模型</span></span><br><span class="line">    model = YoloBody(<span class="built_in">len</span>(anchors[<span class="number">0</span>]), num_classes)</span><br><span class="line"></span><br><span class="line">    model_path = <span class="string">&quot;model_data/yolo4_weights.pth&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Loading weights into state dict...&#x27;</span>)</span><br><span class="line">    device = torch.device(<span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(model_path):</span><br><span class="line">        model_dict = model.state_dict()</span><br><span class="line">        pretrained_dict = torch.load(model_path, map_location=device)</span><br><span class="line">        pretrained_dict = &#123;k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> pretrained_dict.items() <span class="keyword">if</span> np.shape(model_dict[k]) == np.shape(v)&#125;</span><br><span class="line">        model_dict.update(pretrained_dict)</span><br><span class="line">        model.load_state_dict(model_dict)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Finished!&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;error no pretrained model&quot;</span>)</span><br><span class="line"></span><br><span class="line">    net = model.train()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Cuda:</span><br><span class="line">        net = torch.nn.DataParallel(model)</span><br><span class="line">        cudnn.benchmark = <span class="literal">True</span></span><br><span class="line">        net = net.cuda()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 建立loss函数</span></span><br><span class="line">    yolo_losses = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        yolo_losses.append(YOLOLoss(np.reshape(anchors, [-<span class="number">1</span>, <span class="number">2</span>]), num_classes,</span><br><span class="line">                                    (input_shape[<span class="number">1</span>], input_shape[<span class="number">0</span>]), smooth_label, Cuda, normalize))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获得图片路径和标签</span></span><br><span class="line">    annotation_path = <span class="string">&#x27;2007_train.txt&#x27;</span></span><br><span class="line">    val_split = <span class="number">0.1</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(annotation_path, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">    np.random.seed(<span class="number">10101</span>)</span><br><span class="line">    np.random.shuffle(lines)</span><br><span class="line">    np.random.seed(<span class="literal">None</span>)</span><br><span class="line">    num_val = <span class="built_in">int</span>(<span class="built_in">len</span>(lines) * val_split)</span><br><span class="line">    num_train = <span class="built_in">len</span>(lines) - num_val</span><br><span class="line"></span><br><span class="line">    Init_Epoch = <span class="number">0</span></span><br><span class="line">    Freeze_Epoch = <span class="number">200</span></span><br><span class="line">    Unfreeze_Epoch = <span class="number">300</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 冻结训练部分</span></span><br><span class="line">    lr = <span class="number">1e-3</span></span><br><span class="line">    Batch_size = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> optimizer</span><br><span class="line">    optimizer = optim.Adam(net.parameters(), lr)</span><br><span class="line">    <span class="keyword">if</span> Cosine_lr:</span><br><span class="line">        lr_scheduler = optim.lr_scheduler.CosineAnnealingLR(optimizer, T_max=<span class="number">5</span>, eta_min=<span class="number">1e-5</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lr_scheduler = optim.lr_scheduler.StepLR(optimizer, step_size=<span class="number">1</span>, gamma=<span class="number">0.92</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Use_Data_Loader:</span><br><span class="line">        train_dataset = YoloDataset(lines[:num_train], (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>]), mosaic=mosaic,</span><br><span class="line">                                    is_train=<span class="literal">True</span>)</span><br><span class="line">        val_dataset = YoloDataset(lines[num_train:], (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>]), mosaic=<span class="literal">False</span>, is_train=<span class="literal">False</span>)</span><br><span class="line">        gen = DataLoader(train_dataset, shuffle=<span class="literal">True</span>, batch_size=Batch_size, num_workers=<span class="number">4</span>, pin_memory=<span class="literal">True</span>,</span><br><span class="line">                         drop_last=<span class="literal">True</span>, collate_fn=yolo_dataset_collate)</span><br><span class="line">        gen_val = DataLoader(val_dataset, shuffle=<span class="literal">True</span>, batch_size=Batch_size, num_workers=<span class="number">4</span>, pin_memory=<span class="literal">True</span>,</span><br><span class="line">                             drop_last=<span class="literal">True</span>, collate_fn=yolo_dataset_collate)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gen = Generator(Batch_size, lines[:num_train],</span><br><span class="line">                        (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>])).generate(train=<span class="literal">True</span>, mosaic=mosaic)</span><br><span class="line">        gen_val = Generator(Batch_size, lines[num_train:],</span><br><span class="line">                            (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>])).generate(train=<span class="literal">False</span>, mosaic=mosaic)</span><br><span class="line"></span><br><span class="line">    epoch_size = <span class="built_in">max</span>(<span class="number">1</span>, num_train // Batch_size)</span><br><span class="line">    epoch_size_val = num_val // Batch_size</span><br><span class="line">    <span class="comment"># 冻结训练</span></span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> model.backbone.parameters():</span><br><span class="line">        param.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(Init_Epoch, Freeze_Epoch):</span><br><span class="line">        fit_one_epoch(net, yolo_losses, epoch, epoch_size, epoch_size_val, gen, gen_val, Freeze_Epoch, Cuda,</span><br><span class="line">                      queue=queue)</span><br><span class="line">        lr_scheduler.step()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解冻训练</span></span><br><span class="line">    lr = <span class="number">1e-4</span></span><br><span class="line">    Batch_size = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    optimizer = optim.Adam(net.parameters(), lr)</span><br><span class="line">    <span class="keyword">if</span> Cosine_lr:</span><br><span class="line">        lr_scheduler = optim.lr_scheduler.CosineAnnealingLR(optimizer, T_max=<span class="number">5</span>, eta_min=<span class="number">1e-5</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lr_scheduler = optim.lr_scheduler.StepLR(optimizer, step_size=<span class="number">1</span>, gamma=<span class="number">0.92</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Use_Data_Loader:</span><br><span class="line">        train_dataset = YoloDataset(lines[:num_train], (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>]), mosaic=mosaic,</span><br><span class="line">                                    is_train=<span class="literal">True</span>)</span><br><span class="line">        val_dataset = YoloDataset(lines[num_train:], (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>]), mosaic=<span class="literal">False</span>, is_train=<span class="literal">False</span>)</span><br><span class="line">        gen = DataLoader(train_dataset, shuffle=<span class="literal">True</span>, batch_size=Batch_size, num_workers=<span class="number">4</span>, pin_memory=<span class="literal">True</span>,</span><br><span class="line">                         drop_last=<span class="literal">True</span>, collate_fn=yolo_dataset_collate)</span><br><span class="line">        gen_val = DataLoader(val_dataset, shuffle=<span class="literal">True</span>, batch_size=Batch_size, num_workers=<span class="number">4</span>, pin_memory=<span class="literal">True</span>,</span><br><span class="line">                             drop_last=<span class="literal">True</span>, collate_fn=yolo_dataset_collate)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gen = Generator(Batch_size, lines[:num_train],</span><br><span class="line">                        (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>])).generate(train=<span class="literal">True</span>, mosaic=mosaic)</span><br><span class="line">        gen_val = Generator(Batch_size, lines[num_train:],</span><br><span class="line">                            (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>])).generate(train=<span class="literal">False</span>, mosaic=mosaic)</span><br><span class="line"></span><br><span class="line">    epoch_size = <span class="built_in">max</span>(<span class="number">1</span>, num_train // Batch_size)</span><br><span class="line">    epoch_size_val = num_val // Batch_size</span><br><span class="line">    <span class="comment"># 解冻后训练</span></span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> model.backbone.parameters():</span><br><span class="line">        param.requires_grad = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(Freeze_Epoch, Unfreeze_Epoch):</span><br><span class="line">        fit_one_epoch(net, yolo_losses, epoch, epoch_size, epoch_size_val, gen, gen_val, Unfreeze_Epoch, Cuda,</span><br><span class="line">                      queue=queue)</span><br><span class="line">        lr_scheduler.step()</span><br></pre></td></tr></table></figure>

<p>最后训练出来的效果还是很不错的。</p>
<p><img src="https://i.imgtg.com/2023/03/20/91y9b.png" alt="91y9b.png"></p>
<p><img src="https://i.imgtg.com/2023/03/20/91vPP.png" alt="91vPP.png"></p>
<h2 id="YoloV5网络"><a href="#YoloV5网络" class="headerlink" title="YoloV5网络"></a>YoloV5网络</h2><p> 前面说到了由于YoloV4过于庞大，无法放到安卓app中，于是我们小组还开发了YoloV5的版本。</p>
<p><img src="https://i.328888.xyz/2023/04/03/iOyPCc.png" alt="iOyPCc.png"></p>
<p>模型也是使用pytorch实现。这里就不再赘述。</p>
<p>训练过程基本和上面差不多，使用相同的训练集，训练完成后获取模型即可。</p>
<p>比较值得记录的是如何放到安卓app上。</p>
<h2 id="Android-APP"><a href="#Android-APP" class="headerlink" title="Android APP"></a>Android APP</h2><p>安卓客户端基础功能采用vue-cli开发，制作为h5小程序，由于pytorch在安卓端必须采用Android studio引入，所以不能直接使用vue打包成apk。</p>
<p>因此我们小组采用capacitorJS将vue app项目转换成原生代码项目，再使用pytorch原生库加载离线识别模型文件，使用NanoHTTPD实现在本地模拟在线api，采用sqlite和okhttpClient定期同步远程数据库。</p>
<p>在安卓客户端拍图片之后，将会先被编码为base64，然后再上传至YoloV4网络，获取结果之后再显示。</p>
<p>在build.gradle中引入pytorch</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dependencies <span class="punctuation">&#123;</span></span><br><span class="line">    implementation fileTree(include<span class="punctuation">:</span> <span class="punctuation">[</span>&#x27;*.jar&#x27;<span class="punctuation">]</span><span class="punctuation">,</span> dir<span class="punctuation">:</span> &#x27;libs&#x27;)</span><br><span class="line">    implementation <span class="string">&quot;androidx.appcompat:appcompat:$androidxAppCompatVersion&quot;</span></span><br><span class="line">    implementation project(&#x27;<span class="punctuation">:</span>capacitor-android&#x27;)</span><br><span class="line">    testImplementation <span class="string">&quot;junit:junit:$junitVersion&quot;</span></span><br><span class="line">    androidTestImplementation <span class="string">&quot;androidx.test.ext:junit:$androidxJunitVersion&quot;</span></span><br><span class="line">    androidTestImplementation <span class="string">&quot;androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion&quot;</span></span><br><span class="line">    implementation project(&#x27;<span class="punctuation">:</span>capacitor-cordova-android-plugins&#x27;)</span><br><span class="line">    implementation&#x27;org.nanohttpd<span class="punctuation">:</span>nanohttpd<span class="punctuation">:</span><span class="number">2.3</span><span class="number">.1</span>&#x27;</span><br><span class="line">    implementation&#x27;com.alibaba<span class="punctuation">:</span>fastjson<span class="punctuation">:</span><span class="number">1.1</span><span class="number">.72</span>.android&#x27;</span><br><span class="line">    implementation&#x27;com.squareup.okhttp3<span class="punctuation">:</span>okhttp<span class="punctuation">:</span><span class="number">3.10</span><span class="number">.0</span>&#x27;</span><br><span class="line">    implementation &#x27;org.pytorch<span class="punctuation">:</span>pytorch_android<span class="punctuation">:</span><span class="number">1.8</span><span class="number">.0</span>&#x27;</span><br><span class="line">    implementation &#x27;org.pytorch<span class="punctuation">:</span>pytorch_android_torchvision<span class="punctuation">:</span><span class="number">1.8</span><span class="number">.0</span>&#x27;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后把训练好的YoloV5模型放入assets文件夹中，在app打开后进行加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载网络模型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> assetManager assets读取工具</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> moduleName Torchscript文件名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(AssetManager assetManager, String moduleName)</span> &#123;</span><br><span class="line">    <span class="keyword">module</span> = PyTorchAndroid.loadModuleFromAsset(assetManager, moduleName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后实现predict函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输入图片，输出预测信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bitmap 输入图片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> processedImg 处理后的图片,Object[1] 需要放到数组中，否则局部变量无法获取</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 预测信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Integer&gt; <span class="title function_">predict</span><span class="params">(Bitmap bitmap, Object[] processedImg)</span> &#123;</span><br><span class="line">    HashMap&lt;String, Integer&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// preparing input tensor</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Tensor</span> <span class="variable">inputTensor</span> <span class="operator">=</span> TensorImageUtils.bitmapToFloat32Tensor(bitmap,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">float</span>[]&#123;<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>&#125;, <span class="keyword">new</span> <span class="title class_">float</span>[]&#123;<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// running the model</span></span><br><span class="line">    <span class="type">IValue</span> <span class="variable">value</span> <span class="operator">=</span> IValue.from(inputTensor);</span><br><span class="line">    <span class="keyword">final</span> IValue[] output = <span class="keyword">module</span>.forward(value).toTuple();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Tensor</span> <span class="variable">outputTensor</span> <span class="operator">=</span> output[<span class="number">0</span>].toTensor();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">float</span>[] outputs = outputTensor.getDataAsFloatArray();</span><br><span class="line">    <span class="type">float</span> <span class="variable">mImgScaleX</span> <span class="operator">=</span> bitmap.getWidth() / imageSize;</span><br><span class="line">    <span class="type">float</span> <span class="variable">mImgScaleY</span> <span class="operator">=</span> bitmap.getHeight() / imageSize;</span><br><span class="line">    <span class="type">float</span> <span class="variable">mIvScaleX</span> <span class="operator">=</span> (bitmap.getWidth() &gt; bitmap.getHeight() ? imageSize / bitmap.getWidth() : imageSize / bitmap.getHeight());</span><br><span class="line">    <span class="type">float</span> <span class="variable">mIvScaleY</span> <span class="operator">=</span> (bitmap.getHeight() &gt; bitmap.getWidth() ? imageSize / bitmap.getHeight() : imageSize / bitmap.getWidth());</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;Result&gt; results = outputsToNMSPredictions(outputs, mImgScaleX, mImgScaleY, mIvScaleX, mIvScaleY);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasRect</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (Result each : results) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Classes.classes[each.classIndex];</span><br><span class="line">        <span class="keyword">if</span> (resultMap.containsKey(code)) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> resultMap.get(code);</span><br><span class="line">            num += <span class="number">1</span>;</span><br><span class="line">            resultMap.put(code, num);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resultMap.put(code, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (each.rect.top != each.rect.bottom &amp;&amp; each.rect.left != each.rect.right) &#123;</span><br><span class="line">            bitmap = drawRectangles(bitmap, each.rect);</span><br><span class="line">            processedImg[<span class="number">0</span>] = bitmap;</span><br><span class="line">            hasRect = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!hasRect) &#123;</span><br><span class="line">            processedImg[<span class="number">0</span>] = bitmap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resultMap.isEmpty()) &#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;error&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(resultMap);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及在识别后的图片上画框的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在bitmap上画框</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> imageBitmap 输入图片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> valueRects 框的位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 画了框的图片</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Bitmap <span class="title function_">drawRectangles</span><span class="params">(Bitmap imageBitmap, Rect valueRects)</span> &#123;</span><br><span class="line">    <span class="type">Bitmap</span> <span class="variable">mutableBitmap</span> <span class="operator">=</span> imageBitmap.copy(Bitmap.Config.ARGB_8888, <span class="literal">true</span>);</span><br><span class="line">    <span class="type">Canvas</span> <span class="variable">canvas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Canvas</span>(mutableBitmap);</span><br><span class="line">    <span class="type">Paint</span> <span class="variable">paint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        paint.setColor(Color.RED);</span><br><span class="line">        paint.setStyle(Paint.Style.STROKE);<span class="comment">//不填充</span></span><br><span class="line">        paint.setStrokeWidth(<span class="number">10</span>);  <span class="comment">//线的宽度</span></span><br><span class="line">        canvas.drawRect(valueRects.left, valueRects.top, valueRects.right, valueRects.bottom, paint);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mutableBitmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及nms函数，和非极大抑制函数，计算IOU的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对原始输出进行处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> outputs 输出</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> imgScaleX 相对图片大小X</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> imgScaleY 相对图片大小Y</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ivScaleX 显示最小图片大小X</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ivScaleY 显示最小图片大小Y</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Result list</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;Result&gt; <span class="title function_">outputsToNMSPredictions</span><span class="params">(<span class="type">float</span>[] outputs, <span class="type">float</span> imgScaleX, <span class="type">float</span> imgScaleY, <span class="type">float</span> ivScaleX, <span class="type">float</span> ivScaleY)</span> &#123;</span><br><span class="line">    ArrayList&lt;Result&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span> <span class="variable">mOutputRow</span> <span class="operator">=</span> <span class="number">25200</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">mOutputColumn</span> <span class="operator">=</span> Classes.classes.length + <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mOutputRow; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (outputs[i * mOutputColumn + <span class="number">4</span>] &gt; mThreshold) &#123;</span><br><span class="line">                <span class="type">float</span> <span class="variable">x</span> <span class="operator">=</span> outputs[i * mOutputColumn];</span><br><span class="line">                <span class="type">float</span> <span class="variable">y</span> <span class="operator">=</span> outputs[i * mOutputColumn + <span class="number">1</span>];</span><br><span class="line">                <span class="type">float</span> <span class="variable">w</span> <span class="operator">=</span> outputs[i * mOutputColumn + <span class="number">2</span>];</span><br><span class="line">                <span class="type">float</span> <span class="variable">h</span> <span class="operator">=</span> outputs[i * mOutputColumn + <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">                <span class="type">float</span> <span class="variable">left</span> <span class="operator">=</span> imgScaleX * (x - w / <span class="number">2</span>);</span><br><span class="line">                <span class="type">float</span> <span class="variable">top</span> <span class="operator">=</span> imgScaleY * (y - h / <span class="number">2</span>);</span><br><span class="line">                <span class="type">float</span> <span class="variable">right</span> <span class="operator">=</span> imgScaleX * (x + w / <span class="number">2</span>);</span><br><span class="line">                <span class="type">float</span> <span class="variable">bottom</span> <span class="operator">=</span> imgScaleY * (y + h / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">float</span> <span class="variable">max</span> <span class="operator">=</span> outputs[i * mOutputColumn + <span class="number">5</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">cls</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; mOutputColumn - <span class="number">5</span>; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (outputs[i * mOutputColumn + <span class="number">5</span> + j] &gt; max) &#123;</span><br><span class="line">                        max = outputs[i * mOutputColumn + <span class="number">5</span> + j];</span><br><span class="line">                        cls = j;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">Rect</span> <span class="variable">rect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rect</span>((<span class="type">int</span>) ((<span class="type">float</span>) <span class="number">0</span> + ivScaleX * left), (<span class="type">int</span>) ((<span class="type">float</span>) <span class="number">0</span> + top * ivScaleY), (<span class="type">int</span>) ((<span class="type">float</span>) <span class="number">0</span> + ivScaleX * right), (<span class="type">int</span>) ((<span class="type">float</span>) <span class="number">0</span> + ivScaleY * bottom));</span><br><span class="line">                <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>(cls, outputs[i * mOutputColumn + <span class="number">4</span>], rect);</span><br><span class="line">                results.add(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nonMaxSuppression(results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 非极大抑制</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> boxes 结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 筛选后的结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;Result&gt; <span class="title function_">nonMaxSuppression</span><span class="params">(ArrayList&lt;Result&gt; boxes)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Collections.sort(boxes,</span><br><span class="line">            (o1, o2) -&gt; o1.score.compareTo(o2.score));</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;Result&gt; selected = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">boolean</span>[] active = <span class="keyword">new</span> <span class="title class_">boolean</span>[boxes.size()];</span><br><span class="line">    Arrays.fill(active, <span class="literal">true</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">numActive</span> <span class="operator">=</span> active.length;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">done</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; boxes.size() &amp;&amp; !done; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (active[i]) &#123;</span><br><span class="line">            <span class="type">Result</span> <span class="variable">boxA</span> <span class="operator">=</span> boxes.get(i);</span><br><span class="line">            selected.add(boxA);</span><br><span class="line">            <span class="keyword">if</span> (selected.size() &gt;= CnnApi.mNmsLimit) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + <span class="number">1</span>; j &lt; boxes.size(); j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (active[j]) &#123;</span><br><span class="line">                    <span class="type">Result</span> <span class="variable">boxB</span> <span class="operator">=</span> boxes.get(j);</span><br><span class="line">                    <span class="keyword">if</span> (IOU(boxA.rect, boxB.rect) &gt; CnnApi.mThreshold) &#123;</span><br><span class="line">                        active[j] = <span class="literal">false</span>;</span><br><span class="line">                        numActive -= <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">if</span> (numActive &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            done = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> selected;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">float</span> <span class="title function_">IOU</span><span class="params">(Rect a, Rect b)</span> &#123;</span><br><span class="line">    <span class="type">float</span> <span class="variable">areaA</span> <span class="operator">=</span> (a.right - a.left) * (a.bottom - a.top);</span><br><span class="line">    <span class="keyword">if</span> (areaA &lt;= <span class="number">0.0</span>) <span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="variable">areaB</span> <span class="operator">=</span> (b.right - b.left) * (b.bottom - b.top);</span><br><span class="line">    <span class="keyword">if</span> (areaB &lt;= <span class="number">0.0</span>) <span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionMinX</span> <span class="operator">=</span> Math.max(a.left, b.left);</span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionMinY</span> <span class="operator">=</span> Math.max(a.top, b.top);</span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionMaxX</span> <span class="operator">=</span> Math.min(a.right, b.right);</span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionMaxY</span> <span class="operator">=</span> Math.min(a.bottom, b.bottom);</span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionArea</span> <span class="operator">=</span> Math.max(intersectionMaxY - intersectionMinY, <span class="number">0</span>) *</span><br><span class="line">            Math.max(intersectionMaxX - intersectionMinX, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> intersectionArea / (areaA + areaB - intersectionArea);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Result</span> &#123;</span><br><span class="line">    <span class="type">int</span> classIndex;</span><br><span class="line">    Float score;</span><br><span class="line">    Rect rect;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Result</span><span class="params">(<span class="type">int</span> cls, Float output, Rect rect)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.classIndex = cls;</span><br><span class="line">        <span class="built_in">this</span>.score = output;</span><br><span class="line">        <span class="built_in">this</span>.rect = rect;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将这个离线识别方法封装成API。</p>
<p>采用NanoHTTPD对外提供接口。这样在无网络的环境下只需要把服务器的ip地址更改为127.0.0.1，即可请求到本地的YoloV5识别网络，并实现离线识别。</p>
<p>最后放几张图片</p>
<p><img src="https://i.imgtg.com/2023/03/20/91tNK.jpg" alt="91tNK.jpg"></p>
<p><img src="https://i.imgtg.com/2023/03/20/914Ea.jpg" alt="914Ea.jpg"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="xuanxu"
      src="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
  <p class="site-author-name" itemprop="name">xuanxu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xuanxu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
