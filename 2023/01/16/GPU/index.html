<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="在File-Engine中为了加速文件搜索的速度，加入了GPU加速的功能。通过显卡来进行并行运算，大幅提高搜索的速度。由于显卡可以进行大量的并行运算，而每一个文件都是独立的，进行字符串匹配并不会相互干扰，因此GPU非常适合用来加速搜索。 具体的实现方法如下。 定义GPU加速接口1234567891011121314151617181920212223242526272829303132333435">
<meta property="og:type" content="article">
<meta property="og:title" content="GPU搜索加速原理">
<meta property="og:url" content="http://example.com/2023/01/16/GPU/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="在File-Engine中为了加速文件搜索的速度，加入了GPU加速的功能。通过显卡来进行并行运算，大幅提高搜索的速度。由于显卡可以进行大量的并行运算，而每一个文件都是独立的，进行字符串匹配并不会相互干扰，因此GPU非常适合用来加速搜索。 具体的实现方法如下。 定义GPU加速接口1234567891011121314151617181920212223242526272829303132333435">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-01-16T00:18:38.000Z">
<meta property="article:modified_time" content="2023-03-17T04:48:45.000Z">
<meta property="article:author" content="xuanxu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2023/01/16/GPU/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>GPU搜索加速原理 | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/16/GPU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GPU搜索加速原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-16 08:18:38" itemprop="dateCreated datePublished" datetime="2023-01-16T08:18:38+08:00">2023-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-17 12:48:45" itemprop="dateModified" datetime="2023-03-17T12:48:45+08:00">2023-03-17</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在File-Engine中为了加速文件搜索的速度，加入了GPU加速的功能。通过显卡来进行并行运算，大幅提高搜索的速度。<br>由于显卡可以进行大量的并行运算，而每一个文件都是独立的，进行字符串匹配并不会相互干扰，因此GPU非常适合用来加速搜索。</p>
<p>具体的实现方法如下。</p>
<h2 id="定义GPU加速接口"><a href="#定义GPU加速接口" class="headerlink" title="定义GPU加速接口"></a>定义GPU加速接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> file.engine.dllInterface.gpu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.function.BiConsumer;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IGPUAccelerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重置搜索的标志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">resetAllResultStatus</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进行搜索，每当有一个结果匹配后调用resultCollector</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchCase：有D F Full Case四种，分别代表只搜索文件夹(Directory)，只搜索文件(File)，全字匹配(Full)，大小写敏感(Case Sensitive)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isIgnoreCase 是否忽略大小写，当searchCase中存在case时该字段为true</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchText 原始搜索关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keywords 搜索关键字，将searchText用&quot;;&quot;切割得到</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keywordsLowerCase 搜索关键字，全小写字母，内容与keywords相同，但字母为全小写</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isKeywordPath 保存keywords中的关键字是路径判断还是文件名判断</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxResultNumber 最大匹配结果数量限制</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultCollector 有一个结果匹配后的回调方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">match</span><span class="params">(String[] searchCase,</span></span><br><span class="line"><span class="params">               <span class="type">boolean</span> isIgnoreCase,</span></span><br><span class="line"><span class="params">               String searchText,</span></span><br><span class="line"><span class="params">               String[] keywords,</span></span><br><span class="line"><span class="params">               String[] keywordsLowerCase,</span></span><br><span class="line"><span class="params">               <span class="type">boolean</span>[] isKeywordPath,</span></span><br><span class="line"><span class="params">               <span class="type">int</span> maxResultNumber,</span></span><br><span class="line"><span class="params">               BiConsumer&lt;String, String&gt; resultCollector)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断GPU加速是否可用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果可以进行GPU加速</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isGPUAvailableOnSystem</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断某一个缓存是否搜索完成</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果全部完成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isMatchDone</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取某一个缓存搜索完成后匹配的结果数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 匹配的结果数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">matchedNumber</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止搜索</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">stopCollectResults</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断缓存是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果至少保存了一个缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">hasCache</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断某一个缓存是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果缓存名为key的缓存存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCacheExist</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加缓存到GPU显存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> recordSupplier 字符串supplier，由GPU加速dll通过jni进行调用，防止字符串过多导致OOM</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initCache</span><span class="params">(String key, Supplier&lt;String&gt; recordSupplier)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向某个缓存添加数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> records 待添加的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addRecordsToCache</span><span class="params">(String key, Object[] records)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除某一个缓存中的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> records 待删除的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeRecordsFromCache</span><span class="params">(String key, Object[] records)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除某一个缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">clearCache</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除所有缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">clearAllCache</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存是否有效</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 缓存key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果缓存仍然有效，当addRecordsToCache()失败，表示当前缓存的空位已经不足，出现了数据丢失，缓存被标记为无效。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #addRecordsToCache(String, Object[]) </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCacheValid</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取系统显存占用，用于在用户使用过多显存时释放缓存。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 内存占用百分比，数值从0-100</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getGPUMemUsage</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放所有资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取GPU设备名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> GPU设备名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] getDevices();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置使用的GPU设备，deviceNum为getDevices()返回的数组的下标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> deviceNum GPU设备id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true如果成功使用设备并初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">setDevice</span><span class="params">(<span class="type">int</span> deviceNum)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该接口定义了GPU加速的基本方法，以后如果有新的GPU计算框架可以用于加速，只需要重新实现这个接口即可。<br>目前，该接口有两个实现，分别使用CUDA和OpenCL来进行加速。然后采用一个统一的包装类GPUAccelerator进行管理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> file.engine.dllInterface.gpu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> file.engine.configs.AllConfigs;</span><br><span class="line"><span class="keyword">import</span> file.engine.event.handler.EventManagement;</span><br><span class="line"><span class="keyword">import</span> file.engine.event.handler.impl.stop.RestartEvent;</span><br><span class="line"><span class="keyword">import</span> file.engine.utils.RegexUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.function.BiConsumer;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">GPUAccelerator</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IGPUAccelerator gpuAccelerator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">CudaAccelerator</span> <span class="variable">cudaAccelerator</span> <span class="operator">=</span> CudaAccelerator.INSTANCE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">OpenclAccelerator</span> <span class="variable">openclAccelerator</span> <span class="operator">=</span> OpenclAccelerator.INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 之所以采用双重检验锁机制，是由于要实现懒加载，并且不能在加载类的时候进行加载</span></span><br><span class="line"><span class="comment">     * 由于在事务管理器扫描<span class="doctag">@EventRegister</span>和<span class="doctag">@EventListener</span>的阶段将会尝试加载所有类，此时配置中心还不可用</span></span><br><span class="line"><span class="comment">     * 因此采用getInstance()方法来实现懒加载，在BootSystem事件发出后再进行初始化。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isEnableGpuAccelerate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">record</span> <span class="title class_">IsEnabledWrapper</span><span class="params">(<span class="type">boolean</span> isEnableGpuAccelerate)</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> IsEnabledWrapper instance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> IsEnabledWrapper <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (IsEnabledWrapper.class) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                        instance = <span class="keyword">new</span> <span class="title class_">IsEnabledWrapper</span>(AllConfigs.getInstance().getConfigEntity().isEnableGpuAccelerate());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Category</span> &#123;</span><br><span class="line">        CUDA(<span class="string">&quot;cuda&quot;</span>), OPENCL(<span class="string">&quot;opencl&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> String category;</span><br><span class="line"></span><br><span class="line">        Category(String category) &#123;</span><br><span class="line">            <span class="built_in">this</span>.category = category;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.category;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> Category <span class="title function_">categoryFromString</span><span class="params">(String c)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;cuda&quot;</span> -&gt; CUDA;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;opencl&quot;</span> -&gt; OPENCL;</span><br><span class="line">                <span class="keyword">default</span> -&gt; <span class="literal">null</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...... GPU加速方法调用</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key: 设备名</span></span><br><span class="line"><span class="comment">     * value: [设备种类(cuda, opencl)];[设备id]</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getDevices</span><span class="params">()</span> &#123;</span><br><span class="line">        LinkedHashMap&lt;String, String&gt; deviceMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        getDeviceToMap(cudaAccelerator, deviceMap, Category.CUDA);</span><br><span class="line">        getDeviceToMap(openclAccelerator, deviceMap, Category.OPENCL);</span><br><span class="line">        <span class="keyword">return</span> deviceMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getDeviceToMap</span><span class="params">(IGPUAccelerator igpuAccelerator, HashMap&lt;String, String&gt; deviceMap, Category category)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (igpuAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">devices</span> <span class="operator">=</span> igpuAccelerator.getDevices();</span><br><span class="line">            <span class="keyword">if</span> (devices == <span class="literal">null</span> || devices.length == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; devices.length; ++i) &#123;</span><br><span class="line">                <span class="type">var</span> <span class="variable">deviceName</span> <span class="operator">=</span> devices[i];</span><br><span class="line">                <span class="keyword">if</span> (deviceName.isBlank()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!deviceMap.containsKey(deviceName)) &#123;</span><br><span class="line">                        deviceMap.put(deviceName, category + <span class="string">&quot;;&quot;</span> + i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setDevice</span><span class="params">(String deviceCategoryAndId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (gpuAccelerator != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 切换GPU设备重启生效，运行中不允许切换</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!IsEnabledWrapper.getInstance().isEnableGpuAccelerate()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (deviceCategoryAndId.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cudaAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">                cudaAccelerator.initialize();</span><br><span class="line">                <span class="keyword">if</span> (cudaAccelerator.setDevice(<span class="number">0</span>)) &#123;</span><br><span class="line">                    gpuAccelerator = cudaAccelerator;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (openclAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">                openclAccelerator.initialize();</span><br><span class="line">                <span class="keyword">if</span> (openclAccelerator.setDevice(<span class="number">0</span>)) &#123;</span><br><span class="line">                    gpuAccelerator = openclAccelerator;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] info = RegexUtil.semicolon.split(deviceCategoryAndId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">deviceCategory</span> <span class="operator">=</span> info[<span class="number">0</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> Integer.parseInt(info[<span class="number">1</span>]);</span><br><span class="line">        <span class="type">var</span> <span class="variable">category</span> <span class="operator">=</span> Category.categoryFromString(deviceCategory);</span><br><span class="line">        <span class="keyword">if</span> (category != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (category) &#123;</span><br><span class="line">                <span class="keyword">case</span> CUDA:</span><br><span class="line">                    <span class="keyword">if</span> (cudaAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">                        cudaAccelerator.initialize();</span><br><span class="line">                        <span class="keyword">if</span> (cudaAccelerator.setDevice(id)) &#123;</span><br><span class="line">                            gpuAccelerator = cudaAccelerator;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> OPENCL:</span><br><span class="line">                    <span class="keyword">if</span> (openclAccelerator.isGPUAvailableOnSystem()) &#123;</span><br><span class="line">                        openclAccelerator.initialize();</span><br><span class="line">                        <span class="keyword">if</span> (openclAccelerator.setDevice(id)) &#123;</span><br><span class="line">                            gpuAccelerator = openclAccelerator;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendRestartOnError0</span><span class="params">()</span> &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;GPU缓存出错，自动重启&quot;</span>);</span><br><span class="line">        EventManagement.getInstance().putEvent(<span class="keyword">new</span> <span class="title class_">RestartEvent</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="下面介绍CUDA加速。"><a href="#下面介绍CUDA加速。" class="headerlink" title="下面介绍CUDA加速。"></a>下面介绍CUDA加速。</h3><p>CUDA加速首先会加载cudaAccelerator.dll，如果加载成功，将会设置isCudaLoaded为true。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">CudaAccelerator</span> <span class="keyword">implements</span> <span class="title class_">IGPUAccelerator</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> isCudaLoaded;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.load(Path.of(<span class="string">&quot;user/cudaAccelerator.dll&quot;</span>).toAbsolutePath().toString());</span><br><span class="line">            isCudaLoaded = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsatisfiedLinkError | Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            isCudaLoaded = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="初始化过程"><a href="#初始化过程" class="headerlink" title="初始化过程"></a>初始化过程</h4><p>加载完成后，将会调用setDevice(int deviceId)来选择GPU并进行初始化。<br>首先会调用initialize()方法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     file_engine_dllInterface_gpu_CudaAccelerator</span></span><br><span class="line"><span class="comment"> * Method:    initialize</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_file_engine_dllInterface_gpu_CudaAccelerator_initialize</span></span></span><br><span class="line"><span class="function"><span class="params">(JNIEnv* env, jobject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">init_stop_signal</span>();</span><br><span class="line">    <span class="built_in">init_cuda_search_memory</span>();</span><br><span class="line">    <span class="built_in">init_str_convert</span>();</span><br><span class="line">    <span class="comment">//默认使用第一个设备,current_using_device=0</span></span><br><span class="line">    <span class="built_in">set_using_device</span>(current_using_device);</span><br><span class="line">    <span class="keyword">if</span> (env-&gt;<span class="built_in">GetJavaVM</span>(&amp;jvm) != JNI_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        env-&gt;<span class="built_in">ThrowNew</span>(env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/Exception&quot;</span>), <span class="string">&quot;get JavaVM ptr failed.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">set_jvm_ptr_in_kernel</span>(jvm);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CreateDXGIFactory</span>(__uuidof(IDXGIFactory), <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;p_dxgi_factory)) != S_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        env-&gt;<span class="built_in">ThrowNew</span>(env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/Exception&quot;</span>), <span class="string">&quot;create dxgi factory failed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    IDXGIAdapter* p_adapter = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">for</span> (UINT i = <span class="number">0</span>;</span><br><span class="line">        p_dxgi_factory-&gt;<span class="built_in">EnumAdapters</span>(i, &amp;p_adapter) != DXGI_ERROR_NOT_FOUND;</span><br><span class="line">        ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        DXGI_ADAPTER_DESC adapter_desc;</span><br><span class="line">        p_adapter-&gt;<span class="built_in">GetDesc</span>(&amp;adapter_desc);</span><br><span class="line">        gpu_name_adapter_map.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(adapter_desc.Description, adapter_desc));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先初始化停止搜索信号，当结果数量达到maxResults限制，停止信号将会被设置为true，在resetAllResultStatus()方法将会把停止信号重置为false。</p>
<p>随后将会初始化cuda相关内存，如存储搜索关键字，存储搜索过滤条件等。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_cuda_search_memory</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_search_case), <span class="built_in">sizeof</span>(<span class="type">int</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_search_text), MAX_PATH_LENGTH * <span class="built_in">sizeof</span>(<span class="type">char</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_keywords_length), <span class="built_in">sizeof</span>(<span class="type">size_t</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_is_keyword_path), <span class="built_in">sizeof</span>(<span class="type">bool</span>) * MAX_KEYWORDS_NUMBER), <span class="literal">true</span>,</span><br><span class="line">        <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_is_ignore_case), <span class="built_in">sizeof</span>(<span class="type">bool</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(</span><br><span class="line">        <span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_keywords), <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(MAX_PATH_LENGTH * MAX_KEYWORDS_NUMBER)),</span><br><span class="line">        <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(</span><br><span class="line">        <span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;dev_keywords_lower_case), <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(MAX_PATH_LENGTH *</span><br><span class="line">            MAX_KEYWORDS_NUMBER)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后初始化字符串转换器，字符串转换器可以在CPU中实现字符串从UTF-8编码转换到GB2312编码，然后实现从中文字符串转换到拼音，实现拼音搜索。   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_str_convert</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">init_gbk2_utf16_2</span>();</span><br><span class="line">    <span class="built_in">init_gbk2_utf16_3</span>();</span><br><span class="line">    <span class="comment">// init_gbk2_utf16();</span></span><br><span class="line">    <span class="built_in">init_utf162_gbk</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化完成后将会获取jvm指针，用于在match方法开启cuda核函数后，使用多个线程收集处理结果，并将结果返回到Java虚拟机中。通过std::thread开启线程后用jvm指针使线程绑定到Java虚拟机从而调用Java方法。</p>
<p>最后初始化gpu_name_adapter，这是Windows中的directX API，在该项目中主要用于实现显存的监控，因此在此暂时不讨论。</p>
<p>到此初始化完成。</p>
<h4 id="添加缓存步骤"><a href="#添加缓存步骤" class="headerlink" title="添加缓存步骤"></a>添加缓存步骤</h4><p>接下来谈一下initCache方法初始化缓存。</p>
<p>首先看一下缓存的结构</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief 存储数据结构</span></span><br><span class="line"><span class="comment"> * remain_blank_num：当前dev_cache_str有多少空闲空间</span></span><br><span class="line"><span class="comment"> * record_num：当前有多少个record</span></span><br><span class="line"><span class="comment"> * record_hash：每个record的hash，用于判断重复</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> cache_data = <span class="keyword">struct</span> cache_data</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>* dev_strs = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">size_t</span>* dev_str_addr = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">size_t</span>* str_length = <span class="literal">nullptr</span>;</span><br><span class="line">    std::<span class="type">atomic_uint64_t</span> remain_blank_num;</span><br><span class="line">    std::<span class="type">atomic_uint64_t</span> record_num;</span><br><span class="line">    std::mutex lock;</span><br><span class="line">    concurrency::concurrent_unordered_set&lt;<span class="type">size_t</span>&gt; record_hash;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief 缓存struct</span></span><br><span class="line"><span class="comment"> * str_data：数据struct</span></span><br><span class="line"><span class="comment"> * dev_output：字符串匹配后输出位置，下标与cache_data中一一对应，dev_output中数据为1代表匹配成功</span></span><br><span class="line"><span class="comment"> * is_cache_valid：数据是否有效</span></span><br><span class="line"><span class="comment"> * is_match_done：是否匹配全部完成 </span></span><br><span class="line"><span class="comment"> * is_output_done：是否已经存入容器 0 代表没有开始  1 代表正在收集  2代表完成</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> list_cache = <span class="keyword">struct</span> cache_struct</span><br><span class="line">&#123;</span><br><span class="line">    cache_data str_data;</span><br><span class="line">    <span class="type">char</span>* dev_output = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">size_t</span> dev_output_bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> is_cache_valid = <span class="literal">false</span>;</span><br><span class="line">    std::atomic_bool is_match_done;</span><br><span class="line">    std::atomic_int is_output_done;</span><br><span class="line">    <span class="type">unsigned</span> matched_number = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>缓存的添加首先会调用record_supplier方法，获取每一个记录，将他们全部读入std::vector中，然后将缓存保存进入显存。</p>
<p>CUDA和OpenCL保存的实现方式略有不同，由于OpenCL中不允许使用size_t，因此无法实现在GPU核函数中对显存寻址。所以OpenCL中每一个字符串的都是定长，长度被定义在constant.h中的MAX_PATH_LENGTH宏中。</p>
<p>CUDA版本的保存方式会更加省显存空间。保存方式如下：<br>在将所有记录读出后，将会记录总共需要的字节数，然后分配三块内存（即cache_data中的dev_strs，dev_str_addr，str_length）<br>其中两块在显存中，一块为保存字符串的空间，另一块保存每一个字符串在第一块显存中的偏移量。第三块内存为主机内存，保存第一块显存中每个字符串的长度。</p>
<p>这样保存相比OpenCL的定长字符串省下了很多空间，但是由于需要在GPU核函数中进行两次寻址，因此效率相对比较低。<br>最后初始化标志位，缓存初始化完成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     file_engine_dllInterface_gpu_CudaAccelerator</span></span><br><span class="line"><span class="comment"> * Method:    initCache</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;Ljava/util/function/Supplier;)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_file_engine_dllInterface_gpu_CudaAccelerator_initCache</span></span></span><br><span class="line"><span class="function"><span class="params">(JNIEnv* env, jobject, jstring key_jstring, jobject record_supplier)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> jclass supplier_class = env-&gt;<span class="built_in">GetObjectClass</span>(record_supplier);</span><br><span class="line">    <span class="type">const</span> jmethodID get_function = env-&gt;<span class="built_in">GetMethodID</span>(supplier_class, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;()Ljava/lang/Object;&quot;</span>);</span><br><span class="line">    std::vector&lt;std::string&gt; records_vec;</span><br><span class="line">    <span class="type">unsigned</span> record_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> total_bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> jobject record_from_supplier = env-&gt;<span class="built_in">CallObjectMethod</span>(record_supplier, get_function);</span><br><span class="line">        <span class="keyword">if</span> (record_from_supplier == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> jstring_val = <span class="built_in">reinterpret_cast</span>&lt;jstring&gt;(record_from_supplier);</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> record = env-&gt;<span class="built_in">GetStringUTFChars</span>(jstring_val, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">const</span> <span class="keyword">auto</span> record_len = <span class="built_in">strlen</span>(record); record_len &lt; MAX_PATH_LENGTH)</span><br><span class="line">        &#123;</span><br><span class="line">            records_vec.<span class="built_in">emplace_back</span>(record);</span><br><span class="line">            total_bytes += record_len;</span><br><span class="line">            ++total_bytes; <span class="comment">// 每个字符串结尾 &#x27;\0&#x27;</span></span><br><span class="line">            ++record_count;</span><br><span class="line">        &#125;</span><br><span class="line">        env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(jstring_val, record);</span><br><span class="line">        env-&gt;<span class="built_in">DeleteLocalRef</span>(record_from_supplier);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> _key = env-&gt;<span class="built_in">GetStringUTFChars</span>(key_jstring, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="function">std::string <span class="title">key</span><span class="params">(_key)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> cache = <span class="keyword">new</span> list_cache;</span><br><span class="line">    cache-&gt;str_data.record_num = record_count;</span><br><span class="line">    cache-&gt;str_data.remain_blank_num = MAX_RECORD_ADD_COUNT;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> total_results_size = <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(record_count) + MAX_RECORD_ADD_COUNT;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> alloc_bytes = total_bytes + MAX_RECORD_ADD_COUNT * MAX_PATH_LENGTH;</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;cache-&gt;str_data.dev_strs), alloc_bytes), <span class="literal">true</span>,</span><br><span class="line">        <span class="built_in">get_cache_info</span>(key, cache).<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemset</span>(cache-&gt;str_data.dev_strs, <span class="number">0</span>, alloc_bytes), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;cache-&gt;str_data.dev_str_addr), total_results_size * <span class="built_in">sizeof</span>(<span class="type">size_t</span>)),</span><br><span class="line">        <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemset</span>(cache-&gt;str_data.dev_str_addr, <span class="number">0</span>, total_results_size * <span class="built_in">sizeof</span>(<span class="type">size_t</span>)), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    cache-&gt;str_data.str_length = <span class="keyword">new</span> <span class="type">size_t</span>[total_results_size];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMalloc</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;cache-&gt;dev_output), total_results_size), <span class="literal">true</span>,</span><br><span class="line">        <span class="built_in">get_cache_info</span>(key, cache).<span class="built_in">c_str</span>());</span><br><span class="line">    cache-&gt;dev_output_bytes = total_results_size;</span><br><span class="line">    cache-&gt;is_cache_valid = <span class="literal">true</span>;</span><br><span class="line">    cache-&gt;is_match_done = <span class="literal">false</span>;</span><br><span class="line">    cache-&gt;is_output_done = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cudaStream_t stream;</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaStreamCreate</span>(&amp;stream), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">auto</span> target_addr = cache-&gt;str_data.dev_strs;</span><br><span class="line">    <span class="keyword">auto</span> save_str_addr_ptr = cache-&gt;str_data.dev_str_addr;</span><br><span class="line">    <span class="type">unsigned</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> std::string&amp; record : records_vec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> record_length = record.<span class="built_in">length</span>();</span><br><span class="line">        <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemcpyAsync</span>(target_addr, record.<span class="built_in">c_str</span>(), record_length, cudaMemcpyHostToDevice, stream), <span class="literal">true</span>,</span><br><span class="line">            <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span> str_address = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">size_t</span>&gt;(target_addr);</span><br><span class="line">        <span class="comment">//保存字符串在显存上的地址</span></span><br><span class="line">        <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemcpyAsync</span>(save_str_addr_ptr, &amp;str_address, <span class="built_in">sizeof</span>(<span class="type">size_t</span>), cudaMemcpyHostToDevice, stream),</span><br><span class="line">            <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">        cache-&gt;str_data.str_length[i] = record_length;</span><br><span class="line">        target_addr += record_length;</span><br><span class="line">        ++target_addr;</span><br><span class="line">        ++save_str_addr_ptr;</span><br><span class="line">        ++i;</span><br><span class="line">        cache-&gt;str_data.record_hash.<span class="built_in">insert</span>(<span class="built_in">hasher</span>(record));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaStreamSynchronize</span>(stream), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaStreamDestroy</span>(stream), <span class="literal">true</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    cache_map.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(key, cache));</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(key_jstring, _key);</span><br><span class="line">    env-&gt;<span class="built_in">DeleteLocalRef</span>(supplier_class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="字符串匹配及收集"><a href="#字符串匹配及收集" class="headerlink" title="字符串匹配及收集"></a>字符串匹配及收集</h4><p>再来谈一下match方法，该方法实现对缓存中数据的字符串匹配，并将匹配后的结果保存进入Java容器中</p>
<p>首先等待清理缓存完成，防止在搜索时缓存被清除导致程序崩溃。然后生成搜索关键字和搜索过滤条件，随后打开多个线程收集GPU匹配结果，最后开启GPU核函数进行匹配，等待所有收集线程退出，即搜索完成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     file_engine_dllInterface_gpu_CudaAccelerator</span></span><br><span class="line"><span class="comment"> * Method:    match</span></span><br><span class="line"><span class="comment"> * Signature: ([Ljava/lang/String;ZLjava/lang/String;[Ljava/lang/String;[Ljava/lang/String;[ZILjava/util/function/BiConsumer;)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_file_engine_dllInterface_gpu_CudaAccelerator_match</span></span></span><br><span class="line"><span class="function"><span class="params">(JNIEnv* env, jobject, jobjectArray search_case, jboolean is_ignore_case, jstring search_text,</span></span></span><br><span class="line"><span class="params"><span class="function">    jobjectArray keywords, jobjectArray keywords_lower, jbooleanArray is_keyword_path, jint max_results,</span></span></span><br><span class="line"><span class="params"><span class="function">    jobject result_collector)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cache_map.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">wait_for_clear_cache</span>();</span><br><span class="line">    <span class="function">std::lock_guard <span class="title">lock_guard</span><span class="params">(modify_cache_lock)</span></span>;</span><br><span class="line">    <span class="comment">//生成搜索条件 search_case_vec</span></span><br><span class="line">    std::vector&lt;std::string&gt; search_case_vec;</span><br><span class="line">    <span class="keyword">if</span> (search_case != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">generate_search_case</span>(env, search_case_vec, search_case);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成搜索关键字 keywords_vec keywords_lower_vec is_keyword_path_ptr</span></span><br><span class="line">    std::vector&lt;std::string&gt; keywords_vec;</span><br><span class="line">    std::vector&lt;std::string&gt; keywords_lower_vec;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> keywords_length = env-&gt;<span class="built_in">GetArrayLength</span>(keywords);</span><br><span class="line">    <span class="keyword">if</span> (keywords_length &gt; MAX_KEYWORDS_NUMBER)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;too many keywords.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">bool</span> is_keyword_path_ptr[MAX_KEYWORDS_NUMBER]&#123; <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> is_keyword_path_ptr_bool_array = env-&gt;<span class="built_in">GetBooleanArrayElements</span>(is_keyword_path, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">for</span> (jsize i = <span class="number">0</span>; i &lt; keywords_length; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> tmp_keywords_str = <span class="built_in">reinterpret_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectArrayElement</span>(keywords, i));</span><br><span class="line">        <span class="keyword">auto</span> keywords_chars = env-&gt;<span class="built_in">GetStringUTFChars</span>(tmp_keywords_str, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG_OUTPUT</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;keywords: &quot;</span> &lt;&lt; keywords_chars &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        keywords_vec.<span class="built_in">emplace_back</span>(keywords_chars);</span><br><span class="line">        env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(tmp_keywords_str, keywords_chars);</span><br><span class="line">        env-&gt;<span class="built_in">DeleteLocalRef</span>(tmp_keywords_str);</span><br><span class="line"></span><br><span class="line">        tmp_keywords_str = <span class="built_in">reinterpret_cast</span>&lt;jstring&gt;(env-&gt;<span class="built_in">GetObjectArrayElement</span>(keywords_lower, i));</span><br><span class="line">        keywords_chars = env-&gt;<span class="built_in">GetStringUTFChars</span>(tmp_keywords_str, <span class="literal">nullptr</span>);</span><br><span class="line">        keywords_lower_vec.<span class="built_in">emplace_back</span>(keywords_chars);</span><br><span class="line">        env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(tmp_keywords_str, keywords_chars);</span><br><span class="line">        env-&gt;<span class="built_in">DeleteLocalRef</span>(tmp_keywords_str);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG_OUTPUT</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;is keyword path: &quot;</span> &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">bool</span>&gt;(is_keyword_path_ptr_bool_array[i]) &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        is_keyword_path_ptr[i] = is_keyword_path_ptr_bool_array[i];</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseBooleanArrayElements</span>(is_keyword_path, is_keyword_path_ptr_bool_array, JNI_ABORT);</span><br><span class="line">    <span class="comment">//复制全字匹配字符串 search_text</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> search_text_chars = env-&gt;<span class="built_in">GetStringUTFChars</span>(search_text, <span class="literal">nullptr</span>);</span><br><span class="line">    std::atomic_uint result_counter = <span class="number">0</span>;</span><br><span class="line">    std::vector&lt;std::thread&gt; collect_threads_vec;</span><br><span class="line">    collect_threads_vec.<span class="built_in">reserve</span>(COLLECT_RESULTS_THREADS);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; COLLECT_RESULTS_THREADS; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        collect_threads_vec.<span class="built_in">emplace_back</span>([&amp;]</span><br><span class="line">            &#123;</span><br><span class="line">                JNIEnv* thread_env = <span class="literal">nullptr</span>;</span><br><span class="line">                JavaVMAttachArgs args&#123; JNI_VERSION_10, <span class="literal">nullptr</span>, <span class="literal">nullptr</span> &#125;;</span><br><span class="line">                <span class="keyword">if</span> (jvm-&gt;<span class="built_in">AttachCurrentThread</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>**&gt;(&amp;thread_env), &amp;args) != JNI_OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;get thread JNIEnv ptr failed&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">collect_results</span>(thread_env, result_collector, result_counter, max_results, search_case_vec);</span><br><span class="line">                jvm-&gt;<span class="built_in">DetachCurrentThread</span>();</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//GPU并行计算</span></span><br><span class="line">    <span class="built_in">start_kernel</span>(cache_map, search_case_vec, is_ignore_case, search_text_chars,</span><br><span class="line">        keywords_vec, keywords_lower_vec, is_keyword_path_ptr);</span><br><span class="line">    <span class="built_in">collect_results</span>(env, result_collector, result_counter, max_results, search_case_vec);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; each_thread : collect_threads_vec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (each_thread.<span class="built_in">joinable</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            each_thread.<span class="built_in">join</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; [_, cache_val] : cache_map)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache_val-&gt;is_output_done.<span class="built_in">load</span>() != <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cache_val-&gt;is_output_done = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(search_text, search_text_chars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="GPU核函数"><a href="#GPU核函数" class="headerlink" title="GPU核函数"></a>GPU核函数</h4><p>首先通过核函数线程id获取对应的字符串，然后对字符串进行匹配，如果匹配完成将output设置为1（即缓存结构体中的dev_output），如果匹配失败则设置为0。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 核函数并未对参数做检查，所以如果数据库中包含不是文件路径的记录将会导致崩溃。</span></span><br><span class="line"><span class="comment"> * 如   D:    C:    这样的记录将会导致核函数失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">check</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span>* str_address_records,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">size_t</span>* total_num,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span>* search_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span>* is_ignore_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* search_text,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* keywords,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* keywords_lower_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">size_t</span>* keywords_length,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span>* is_keyword_path,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* output,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span>* is_stop_collect_var)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> thread_id = <span class="built_in">GET_TID</span>();</span><br><span class="line">    <span class="keyword">if</span> (thread_id &gt;= *total_num)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*is_stop_collect_var)</span><br><span class="line">    &#123;</span><br><span class="line">        output[thread_id] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> path = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(str_address_records[thread_id]);</span><br><span class="line">    <span class="keyword">if</span> (path == <span class="literal">nullptr</span> || !path[<span class="number">0</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        output[thread_id] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">not_matched</span>(path, *is_ignore_case, keywords, keywords_lower_case, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(*keywords_length),</span><br><span class="line">        is_keyword_path))</span><br><span class="line">    &#123;</span><br><span class="line">        output[thread_id] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*search_case == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        output[thread_id] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*search_case &amp; <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 全字匹配</span></span><br><span class="line">        <span class="built_in">strlwr_cuda</span>(search_text);</span><br><span class="line">        <span class="type">char</span> file_name[MAX_PATH_LENGTH]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">get_file_name</span>(path, file_name);</span><br><span class="line">        <span class="built_in">strlwr_cuda</span>(file_name);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp_cuda</span>(search_text, file_name) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            output[thread_id] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    output[thread_id] = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在not_matched()方法中，将会对字符串进行匹配，并尝试进行拼音匹配</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__device__ <span class="type">bool</span> <span class="title">not_matched</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span> is_ignore_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* keywords,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">char</span>* keywords_lower_case,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">int</span> keywords_length,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">bool</span>* is_keyword_path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; keywords_length; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">bool</span> is_keyword_path_val = is_keyword_path[i];</span><br><span class="line">        <span class="type">char</span> match_str[MAX_PATH_LENGTH]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> (is_keyword_path_val)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">get_parent_path</span>(path, match_str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">get_file_name</span>(path, match_str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span>* each_keyword;</span><br><span class="line">        <span class="keyword">if</span> (is_ignore_case)</span><br><span class="line">        &#123;</span><br><span class="line">            each_keyword = keywords_lower_case + i * <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>&gt;(MAX_PATH_LENGTH);</span><br><span class="line">            <span class="built_in">strlwr_cuda</span>(match_str);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            each_keyword = keywords + i * <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>&gt;(MAX_PATH_LENGTH);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!each_keyword[<span class="number">0</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr_cuda</span>(match_str, each_keyword) == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_keyword_path_val || !<span class="built_in">is_str_contains_chinese</span>(match_str))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">char</span> gbk_buffer[MAX_PATH_LENGTH * <span class="number">2</span>]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="type">char</span>* gbk_buffer_ptr = gbk_buffer;</span><br><span class="line">            <span class="comment">// utf-8编码转换gbk</span></span><br><span class="line">            <span class="built_in">utf8_to_gbk</span>(match_str, <span class="built_in">static_cast</span>&lt;<span class="type">unsigned</span>&gt;(<span class="built_in">strlen_cuda</span>(match_str)), &amp;gbk_buffer_ptr, <span class="literal">nullptr</span>);</span><br><span class="line">            <span class="type">char</span> converted_pinyin[MAX_PATH_LENGTH * <span class="number">6</span>]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="type">char</span> converted_pinyin_initials[MAX_PATH_LENGTH]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="built_in">convert_to_pinyin</span>(gbk_buffer, converted_pinyin, converted_pinyin_initials);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr_cuda</span>(converted_pinyin, each_keyword) == <span class="literal">nullptr</span> &amp;&amp; </span><br><span class="line">                <span class="built_in">strstr_cuda</span>(converted_pinyin_initials, each_keyword) == <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="结果收集"><a href="#结果收集" class="headerlink" title="结果收集"></a>结果收集</h4><p>每个缓存中拥有一个is_output_done字段，初始为0，每个线程将会通过cas尝试将缓存的is_output_done设置为1，表示正在收集，当收集完成is_output_done会被设置为2表示收集完成。</p>
<p>当线程抢到某个缓存的收集权后将会开始进行收集。<br>GPU核函数匹配成功后将会把dev_output中对应的标志设置为1，通过dev_output可以拿到对应的字符串地址，然后取出字符串。</p>
<p>由于GPU核函数无法访问操作系统函数，因此在这里还需要过滤是否为文件夹，或是否为文件，过滤完成后将会调用_collect_func()调用match()方法的回调方法，将结果存入Java容器中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">collect_results</span><span class="params">(JNIEnv* thread_env, jobject result_collector, std::atomic_uint&amp; result_counter,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">unsigned</span> max_results, <span class="type">const</span> std::vector&lt;std::string&gt;&amp; search_case_vec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> jclass biconsumer_class = thread_env-&gt;<span class="built_in">GetObjectClass</span>(result_collector);</span><br><span class="line">    <span class="type">const</span> jmethodID collector = thread_env-&gt;<span class="built_in">GetMethodID</span>(biconsumer_class, <span class="string">&quot;accept&quot;</span>,</span><br><span class="line">        <span class="string">&quot;(Ljava/lang/Object;Ljava/lang/Object;)V&quot;</span>);</span><br><span class="line">    <span class="type">bool</span> all_complete;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> stop_func = [&amp;]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">is_stop</span>() || result_counter.<span class="built_in">load</span>() &gt;= max_results;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">auto</span> _collect_func = [&amp;](<span class="type">const</span> std::string&amp; _key, <span class="type">char</span> _matched_record_str[MAX_PATH_LENGTH],</span><br><span class="line">        <span class="type">unsigned</span>* matched_number)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (++result_counter &gt;= max_results)</span><br><span class="line">        &#123;</span><br><span class="line">            is_results_number_exceed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">auto</span> record_jstring = thread_env-&gt;<span class="built_in">NewStringUTF</span>(_matched_record_str);</span><br><span class="line">        <span class="keyword">auto</span> key_jstring = thread_env-&gt;<span class="built_in">NewStringUTF</span>(_key.<span class="built_in">c_str</span>());</span><br><span class="line">        thread_env-&gt;<span class="built_in">CallVoidMethod</span>(result_collector, collector, key_jstring, record_jstring);</span><br><span class="line">        thread_env-&gt;<span class="built_in">DeleteLocalRef</span>(record_jstring);</span><br><span class="line">        thread_env-&gt;<span class="built_in">DeleteLocalRef</span>(key_jstring);</span><br><span class="line">        ++* matched_number;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//尝试退出</span></span><br><span class="line">        all_complete = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; [key, val] : cache_map)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">stop_func</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!val-&gt;is_cache_valid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!val-&gt;is_match_done.<span class="built_in">load</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//发现仍然有结果未计算完，设置退出标志为false，跳到下一个计算结果</span></span><br><span class="line">                all_complete = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="type">int</span> expected = <span class="number">0</span>; !val-&gt;is_output_done.<span class="built_in">compare_exchange_strong</span>(expected, <span class="number">1</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">unsigned</span> matched_number = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//复制结果数组到host，dev_output下标对应dev_cache中的下标，若dev_output[i]中的值为1，则对应dev_cache[i]字符串匹配成功</span></span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> output_ptr = <span class="keyword">new</span> <span class="type">char</span>[val-&gt;dev_output_bytes];</span><br><span class="line">            <span class="comment">//将dev_output拷贝到output_ptr</span></span><br><span class="line">            <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemcpy</span>(output_ptr, val-&gt;dev_output, val-&gt;str_data.record_num, cudaMemcpyDeviceToHost), <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;collect results failed&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; val-&gt;str_data.record_num.<span class="built_in">load</span>(); ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">stop_func</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//dev_cache[i]字符串匹配成功</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">static_cast</span>&lt;<span class="type">bool</span>&gt;(output_ptr[i]))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">char</span> matched_record_str[MAX_PATH_LENGTH]&#123; <span class="number">0</span> &#125;;</span><br><span class="line">                    <span class="type">char</span>* str_address;</span><br><span class="line">                    <span class="built_in">gpuErrchk</span>(</span><br><span class="line">                        <span class="built_in">cudaMemcpy</span>(&amp;str_address, val-&gt;str_data.dev_str_addr + i, <span class="built_in">sizeof</span>(<span class="type">size_t</span>), cudaMemcpyDeviceToHost</span><br><span class="line">                        ), <span class="literal">false</span>, <span class="literal">nullptr</span>);</span><br><span class="line">                    <span class="comment">//拷贝GPU中的字符串到host</span></span><br><span class="line">                    <span class="built_in">gpuErrchk</span>(<span class="built_in">cudaMemcpy</span>(matched_record_str, str_address, val-&gt;str_data.str_length[i],</span><br><span class="line">                        cudaMemcpyDeviceToHost), <span class="literal">false</span>, <span class="string">&quot;collect results failed&quot;</span>);</span><br><span class="line">                    <span class="comment">// 判断文件和文件夹</span></span><br><span class="line">                    <span class="keyword">if</span> (search_case_vec.<span class="built_in">empty</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">is_file_exist</span>(matched_record_str))</span><br><span class="line">                        &#123;</span><br><span class="line">                            _collect_func(key, matched_record_str, &amp;matched_number);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (std::<span class="built_in">find</span>(search_case_vec.<span class="built_in">begin</span>(), search_case_vec.<span class="built_in">end</span>(), <span class="string">&quot;f&quot;</span>) != search_case_vec.<span class="built_in">end</span>())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">is_dir_or_file</span>(matched_record_str) == <span class="number">1</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                _collect_func(key, matched_record_str, &amp;matched_number);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (std::<span class="built_in">find</span>(search_case_vec.<span class="built_in">begin</span>(), search_case_vec.<span class="built_in">end</span>(), <span class="string">&quot;d&quot;</span>) != search_case_vec.</span><br><span class="line">                            <span class="built_in">end</span>())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">is_dir_or_file</span>(matched_record_str) == <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                _collect_func(key, matched_record_str, &amp;matched_number);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">is_file_exist</span>(matched_record_str))</span><br><span class="line">                            &#123;</span><br><span class="line">                                _collect_func(key, matched_record_str, &amp;matched_number);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            val-&gt;matched_number = matched_number;</span><br><span class="line">            val-&gt;is_output_done = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">delete</span>[] output_ptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!all_complete &amp;&amp; !<span class="built_in">stop_func</span>());</span><br><span class="line">    thread_env-&gt;<span class="built_in">DeleteLocalRef</span>(biconsumer_class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，GPU加速的核心方法基本介绍完成。OpenCL的版本除了字符串存储方式不同，其他方法几乎相同，只是使用了不同的框架进行实现，因此不再赘述。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/08/16/Everything/" rel="prev" title="Everything高速搜索文件原理及实现">
      <i class="fa fa-chevron-left"></i> Everything高速搜索文件原理及实现
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/03/18/GPU-Memory/" rel="next" title="对显存占用的监控（Windows系统）">
      对显存占用的监控（Windows系统） <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89GPU%E5%8A%A0%E9%80%9F%E6%8E%A5%E5%8F%A3"><span class="nav-number">1.</span> <span class="nav-text">定义GPU加速接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E9%9D%A2%E4%BB%8B%E7%BB%8DCUDA%E5%8A%A0%E9%80%9F%E3%80%82"><span class="nav-number">1.1.</span> <span class="nav-text">下面介绍CUDA加速。</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-number">1.1.1.</span> <span class="nav-text">初始化过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E7%BC%93%E5%AD%98%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.1.2.</span> <span class="nav-text">添加缓存步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D%E5%8F%8A%E6%94%B6%E9%9B%86"><span class="nav-number">1.1.3.</span> <span class="nav-text">字符串匹配及收集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GPU%E6%A0%B8%E5%87%BD%E6%95%B0"><span class="nav-number">1.1.4.</span> <span class="nav-text">GPU核函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%E6%94%B6%E9%9B%86"><span class="nav-number">1.1.5.</span> <span class="nav-text">结果收集</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="xuanxu"
      src="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
  <p class="site-author-name" itemprop="name">xuanxu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xuanxu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
