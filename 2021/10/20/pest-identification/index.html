<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="软件杯经过了几个月的竞赛和答辩过后，总算是获得了一个相对比较满意的成绩。 我们组的名字叫P5天下第一，回过头看这个名字实在是有种说不出的感觉（索尼罪大恶极），我的P5都还在PS4里吃灰，结果后面直接上了XGP，还是P5R，只能说《Only On PlayStation For A While》。 回到正题。首先还是来讲讲数据库和后端的方案吧。 下面是整体的架构图设计  Pest-Identific">
<meta property="og:type" content="article">
<meta property="og:title" content="第十届中国“软件杯” A4林业有害生物智能识别国家二等奖总结">
<meta property="og:url" content="http://example.com/2021/10/20/pest-identification/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="软件杯经过了几个月的竞赛和答辩过后，总算是获得了一个相对比较满意的成绩。 我们组的名字叫P5天下第一，回过头看这个名字实在是有种说不出的感觉（索尼罪大恶极），我的P5都还在PS4里吃灰，结果后面直接上了XGP，还是P5R，只能说《Only On PlayStation For A While》。 回到正题。首先还是来讲讲数据库和后端的方案吧。 下面是整体的架构图设计  Pest-Identific">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/911cG.png">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/91NO1.png">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/9iZGD.jpg">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/9nwxC.png">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/91pvg.jpg">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/91e7I.jpg">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/91rLD.jpg">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/91y9b.png">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/91vPP.png">
<meta property="og:image" content="https://i.328888.xyz/2023/04/03/iOyPCc.png">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/91tNK.jpg">
<meta property="og:image" content="https://i.imgtg.com/2023/03/20/914Ea.jpg">
<meta property="article:published_time" content="2021-10-19T23:11:26.000Z">
<meta property="article:modified_time" content="2023-04-03T03:04:32.000Z">
<meta property="article:author" content="xuanxu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgtg.com/2023/03/20/911cG.png">

<link rel="canonical" href="http://example.com/2021/10/20/pest-identification/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>第十届中国“软件杯” A4林业有害生物智能识别国家二等奖总结 | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/20/pest-identification/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
      <meta itemprop="name" content="xuanxu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          第十届中国“软件杯” A4林业有害生物智能识别国家二等奖总结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-20 07:11:26" itemprop="dateCreated datePublished" datetime="2021-10-20T07:11:26+08:00">2021-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-04-03 11:04:32" itemprop="dateModified" datetime="2023-04-03T11:04:32+08:00">2023-04-03</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>软件杯经过了几个月的竞赛和答辩过后，总算是获得了一个相对比较满意的成绩。</p>
<p>我们组的名字叫P5天下第一，回过头看这个名字实在是有种说不出的感觉（索尼罪大恶极），我的P5都还在PS4里吃灰，结果后面直接上了XGP，还是P5R，只能说《Only On PlayStation For A While》。</p>
<p>回到正题。首先还是来讲讲数据库和后端的方案吧。</p>
<p>下面是整体的架构图设计</p>
<p><img src="https://i.imgtg.com/2023/03/20/911cG.png" alt="911cG.png"></p>
<h2 id="Pest-Identification-Provider"><a href="#Pest-Identification-Provider" class="headerlink" title="Pest-Identification-Provider"></a>Pest-Identification-Provider</h2><p>数据库其实很简单，就是一个用户表，还有害虫的目科属种的信息表，以及关联表。</p>
<p><img src="https://i.imgtg.com/2023/03/20/91NO1.png" alt="91NO1.png"></p>
<p>后端采用spring cloud + nacos的方案。分为provider和consumer，然后通过spring gateway网关进行负载均衡。</p>
<p><img src="https://i.imgtg.com/2023/03/20/9iZGD.jpg" alt="9iZGD.jpg"></p>
<p>YoloV4图像识别模块也通过gunicorn实现了负载均衡。</p>
<p>用户登录后台采用的是jwtToken + Spring security实现权限校验。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.configs;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-09 18:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomUserDetainsService userDetainsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CsrfProperties csrfProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomCorsFilter customCorsFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtils jwtTokenUtils;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;userServiceImpl&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.cors().and()</span><br><span class="line">                <span class="comment">//添加cors响应头</span></span><br><span class="line">                .addFilterAfter(customCorsFilter, HeaderWriterFilter.class)</span><br><span class="line">                <span class="comment">//添加token登录过滤器</span></span><br><span class="line">                .addFilterBefore(<span class="keyword">new</span> <span class="title class_">TokenLoginFilter</span>(authenticationManager(), jwtTokenUtils), UsernamePasswordAuthenticationFilter.class)</span><br><span class="line">                <span class="comment">//添加token认证过滤器</span></span><br><span class="line">                .addFilterBefore(<span class="keyword">new</span> <span class="title class_">TokenAuthenticationFilter</span>(authenticationManager(), jwtTokenUtils, userService), BasicAuthenticationFilter.class).httpBasic()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">//关闭session</span></span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(HttpMethod.OPTIONS).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(HttpMethod.GET, <span class="string">&quot;/species/*&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/imgFake&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().hasRole(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (csrfProperties.getCsrfDisabled()) &#123;</span><br><span class="line">            http.csrf().disable();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetainsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        web.ignoring()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/v2/api-docs&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/swagger-resources/configuration/ui&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/swagger-resources&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/swagger-resources/configuration/security&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/swagger-ui.html&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/webjars/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BCryptPasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在spring security中添加了两个过滤器，一个Token登录过滤器，一个Token认证过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.filters;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-15 19:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenLoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTokenUtils jwtTokenUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenLoginFilter</span><span class="params">(AuthenticationManager authenticationManager, JwtTokenUtils jwtTokenUtils)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">        <span class="built_in">this</span>.jwtTokenUtils = jwtTokenUtils;</span><br><span class="line">        <span class="built_in">this</span>.setPostOnly(<span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.setRequiresAuthenticationRequestMatcher(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;POST&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        Map&lt;String, String[]&gt; map = req.getParameterMap();</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> map.get(<span class="string">&quot;username&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> map.get(<span class="string">&quot;password&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(username, password, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        <span class="keyword">return</span> authenticationManager.authenticate(<span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user.getUsername(), user.getPassword(), <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication auth)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) auth.getPrincipal();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> jwtTokenUtils.generateToken(user.getUsername());</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">        map.put(<span class="string">&quot;username&quot;</span>, user.getUsername());</span><br><span class="line">        ResponseUtils.out(response, ResBody.success(map));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">unsuccessfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException failed)</span> &#123;</span><br><span class="line">        ResponseUtils.out(response, ResBody.error(<span class="keyword">new</span> <span class="title class_">BizException</span>(ExceptionsEnum.LOGIN_FAILED)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TokenLoginFilter中有一个JwtTokenUtils，当尝试登录时，将会先调用attemptAuthentication函数，对比账号和密码后将会调用successfulAuthentication函数根据用户名生成一个token，然后返回到前端。</p>
<p>密码采用默认的BCryptPasswordEncoder进行加密。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> BCryptPasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据库采用的是MySQL + mybatis plus。</p>
<p>整体就是采用MVC架构，在controller中定义接口，然后在service中进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.controller;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-08 13:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/family&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FamilyController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Qualifier(&quot;familyServiceImpl&quot;)</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FamilyService familyService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;familyGenusVoServiceImpl&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> FamilyGenusVoService familyGenusVoService;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过id查询科</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据id查询科&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectFamiliesById</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResBody.success(familyVoService.selectFamiliesById(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有科</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageNum  当前查询起始页</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageSize 需要的页数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;all&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;查询所有科&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectAllFamilies</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> pageNum, <span class="meta">@RequestParam</span> <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResBody.success(familyVoService.selectAllFamilies(pageNum, pageSize));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;name&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据名称查询&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectFamiliesByName</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> pageNum, <span class="meta">@RequestParam</span> <span class="type">int</span> pageSize, <span class="meta">@RequestParam</span> String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResBody.success(familyVoService.selectFamiliesByName(pageNum, pageSize, name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p>在这里定义了一个统一的返回值ResBody，这样在前端处理会更方便，并且不需要处理null值的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.exceptions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-09 10:42</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResBody</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Object&gt; RESULT_HOLDER = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        RESULT_HOLDER.put(<span class="string">&quot;pages&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        RESULT_HOLDER.put(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> resBody</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResBody&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> success(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> resBody</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResBody&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        ResBody&lt;T&gt; rb = <span class="keyword">new</span> <span class="title class_">ResBody</span>&lt;&gt;();</span><br><span class="line">        rb.setCode(ExceptionsEnum.SUCCESS.getResCode());</span><br><span class="line">        rb.setMessage(ExceptionsEnum.SUCCESS.getResMsg());</span><br><span class="line">        rb.setResult(data);</span><br><span class="line">        <span class="keyword">return</span> rb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResBody&lt;T&gt; <span class="title function_">error</span><span class="params">(BizException errorInfo)</span> &#123;</span><br><span class="line">        ResBody&lt;T&gt; rb = <span class="keyword">new</span> <span class="title class_">ResBody</span>&lt;&gt;();</span><br><span class="line">        rb.setCode(errorInfo.getExp().getResCode());</span><br><span class="line">        rb.setMessage(errorInfo.getExp().getResMsg());</span><br><span class="line">        rb.setResult(RESULT_HOLDER);</span><br><span class="line">        <span class="keyword">return</span> rb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ResBody&lt;T&gt; <span class="title function_">error</span><span class="params">(<span class="type">int</span> errorCode, String errorInfo)</span> &#123;</span><br><span class="line">        ResBody&lt;T&gt; rb = <span class="keyword">new</span> <span class="title class_">ResBody</span>&lt;&gt;();</span><br><span class="line">        rb.setCode(errorCode);</span><br><span class="line">        rb.setMessage(errorInfo);</span><br><span class="line">        rb.setResult(RESULT_HOLDER);</span><br><span class="line">        <span class="keyword">return</span> rb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ResBody&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;code=&quot;</span> + code +</span><br><span class="line">                <span class="string">&quot;, message=&#x27;&quot;</span> + message + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, result=&quot;</span> + result +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目中还使用了全局异常处理中心来对不同的异常进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rjgc.exceptions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DuplicateKeyException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoyunjie</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-04-09 10:38</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 全局异常处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = BizException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;BizException&gt; <span class="title function_">bizExceptionHandler</span><span class="params">(HttpServletRequest req, BizException e)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Message: &quot;</span> + e.getMessage());</span><br><span class="line">        log.debug(<span class="string">&quot;Cause: &quot;</span> + e.getCause());</span><br><span class="line">        <span class="keyword">return</span> ResBody.error(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = NullPointerException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;NullPointerException&gt; <span class="title function_">nullPointerExceptionHandler</span><span class="params">(HttpServletRequest req, NullPointerException e)</span> &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.debug(<span class="string">&quot;Message: &quot;</span> + e.getMessage());</span><br><span class="line">        log.debug(<span class="string">&quot;Cause: &quot;</span> + e.getCause());</span><br><span class="line">        <span class="keyword">return</span> ResBody.error(<span class="number">50001</span>, <span class="string">&quot;空指针异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = DuplicateKeyException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;DuplicateKeyException&gt; <span class="title function_">duplicateKeyExceptionHandler</span><span class="params">(HttpServletRequest req, DuplicateKeyException e)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Message: &quot;</span> + e.getMessage());</span><br><span class="line">        log.debug(<span class="string">&quot;Cause: &quot;</span> + e.getCause());</span><br><span class="line">        <span class="keyword">return</span> ResBody.error(<span class="keyword">new</span> <span class="title class_">BizException</span>(ExceptionsEnum.INVALID_ID));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResBody&lt;Exception&gt; <span class="title function_">exceptionHandler</span><span class="params">(HttpServletRequest req, Exception e)</span> &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;Message: &quot;</span> + e.getMessage());</span><br><span class="line">        log.error(<span class="string">&quot;Cause: &quot;</span> + e.getCause());</span><br><span class="line">        <span class="keyword">return</span> ResBody.error(<span class="keyword">new</span> <span class="title class_">BizException</span>(ExceptionsEnum.DATABASE_FAILED));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上基本上是provider的设计方案。</p>
<h2 id="Pest-Identification-Consumer"><a href="#Pest-Identification-Consumer" class="headerlink" title="Pest-Identification-Consumer"></a>Pest-Identification-Consumer</h2><p>接下来在consumer端，其实就是对provider的进一步封装。通过OpenFegin来进行远程调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;pest-identification-provider&quot;, configuration = FeignConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FamilyClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/family&quot;)</span></span><br><span class="line">    ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectFamiliesById</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/family/all&quot;)</span></span><br><span class="line">    ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectAllFamilies</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> pageNum, <span class="meta">@RequestParam</span> <span class="type">int</span> pageSize)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/family/name&quot;)</span></span><br><span class="line">    ResBody&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">selectFamiliesByName</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> pageNum, <span class="meta">@RequestParam</span> <span class="type">int</span> pageSize, <span class="meta">@RequestParam</span> String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/family/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    ResBody&lt;Integer&gt; <span class="title function_">insertFamily</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> orderId, <span class="meta">@RequestBody</span> Family family)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/family&quot;)</span></span><br><span class="line">    ResBody&lt;Integer&gt; <span class="title function_">updateFamily</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> orderId, <span class="meta">@RequestBody</span> Family newFamily)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/family&quot;)</span></span><br><span class="line">    ResBody&lt;Integer&gt; <span class="title function_">deleteFamilyById</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Pest-Identification-Gateway"><a href="#Pest-Identification-Gateway" class="headerlink" title="Pest-Identification-Gateway"></a>Pest-Identification-Gateway</h2><p>网关这里其实Spring已经给出了很方便的解决方案。只需要在配置文件中配好负载均衡，在nacos就可以实现。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pest-identification-gateway</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">consumer</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pest-identification-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/**</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">connect-timeout:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">response-timeout:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>

<h2 id="YoloV4网络"><a href="#YoloV4网络" class="headerlink" title="YoloV4网络"></a>YoloV4网络</h2><p>这次竞赛有一个很大的难题，也就是图像识别的问题。这里我采用的是YoloV4框架来进行目标检测。由于这次竞赛还需要实现离线识别，因此在安卓客户端使用了YoloV5框架来实现断网情况下的识别。</p>
<p>首先说说YoloV4框架，在这次竞赛中，我使用了flask框架来对外提供识别api。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/startPredict&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_predict</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    开始对img/$&#123;ip&#125;中的图片进行预测，返回预测结果</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ret = &#123;&#125;</span><br><span class="line">    each_statistics: <span class="built_in">dict</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> pictures:</span><br><span class="line">        <span class="keyword">return</span> resp_utils.error(<span class="string">&#x27;还未上传文件&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> pictures:</span><br><span class="line">        info = load_index(each)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> info:</span><br><span class="line">            each_statistics, base64_str = predict.predict_img(each)</span><br><span class="line">            ret[os.path.basename(each)] = &#123;<span class="string">&#x27;statistics&#x27;</span>: each_statistics, <span class="string">&#x27;img&#x27;</span>: base64_str&#125;</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;error&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> each_statistics:</span><br><span class="line">                save_index(each, base64_str, each_statistics)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            each_statistics = info[<span class="string">&#x27;statistics&#x27;</span>]</span><br><span class="line">            base64_str = info[<span class="string">&#x27;img&#x27;</span>]</span><br><span class="line">            ret[os.path.basename(each)] = &#123;<span class="string">&#x27;statistics&#x27;</span>: each_statistics, <span class="string">&#x27;img&#x27;</span>: base64_str&#125;</span><br><span class="line">    pictures.clear()</span><br><span class="line">    <span class="keyword">return</span> resp_utils.success(ret)</span><br></pre></td></tr></table></figure>

<p>YoloV4框架采用pytorch实现。这里先贴一张YoloV4的架构图。图片来自 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44791964/article/details/106533581">睿智的目标检测32——TF2搭建YoloV4目标检测平台（tensorflow2）_Bubbliiiing的博客-CSDN博客</a></p>
<p>这位Bubbliiiing真的让我学到了很多，他在B站也有关于YoloV4的教程，看了他的视频，我觉得受益匪浅。<a target="_blank" rel="noopener" href="https://space.bilibili.com/472467171">Bubbliiiing的个人空间_哔哩哔哩_bilibili</a></p>
<p><img src="https://i.imgtg.com/2023/03/20/9nwxC.png" alt="9nwxC.png"></p>
<p>具体的介绍可以参考这里</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/372402239">YOLOV4 pytorch实现流程 - 知乎 (zhihu.com)</a></p>
<p>首先是实现CSPdarknet，定义MISH激活函数，以及实现基本的卷积操作，最后再实现一个完整的CSPdarknet。</p>
<p><strong>这里不得不说pytorch实在是太方便了，只要继承nn.Module，然后写forward就可以了。之前TensorFlow折腾了好久，不同的backend，不同的版本居然都不兼容，坑太多了。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># MISH激活函数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mish</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Mish, self).__init__()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> x * torch.tanh(F.softplus(x))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conv2d + BatchNormalization + Mish</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BasicConv</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels, kernel_size, stride=<span class="number">1</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(BasicConv, self).__init__()</span><br><span class="line"></span><br><span class="line">        self.conv = nn.Conv2d(in_channels, out_channels, kernel_size, stride, kernel_size // <span class="number">2</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn = nn.BatchNorm2d(out_channels)</span><br><span class="line">        self.activation = Mish()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv(x)</span><br><span class="line">        x = self.bn(x)</span><br><span class="line">        x = self.activation(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># CSPdarknet</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Resblock</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, channels, hidden_channels=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Resblock, self).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hidden_channels <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            hidden_channels = channels</span><br><span class="line"></span><br><span class="line">        self.block = nn.Sequential(</span><br><span class="line">            BasicConv(channels, hidden_channels, <span class="number">1</span>),</span><br><span class="line">            BasicConv(hidden_channels, channels, <span class="number">3</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> x + self.block(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># CSPdarknet的结构块</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Resblock_body</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels, num_blocks, first</span>):</span><br><span class="line">        <span class="built_in">super</span>(Resblock_body, self).__init__()</span><br><span class="line">        <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   利用一个步长为2x2的卷积块进行高和宽的压缩</span></span><br><span class="line">        <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">        self.downsample_conv = BasicConv(in_channels, out_channels, <span class="number">3</span>, stride=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> first:</span><br><span class="line">            <span class="comment"># --------------------------------------------------------------------------#</span></span><br><span class="line">            <span class="comment">#   然后建立一个大的残差边self.split_conv0、这个大残差边绕过了很多的残差结构</span></span><br><span class="line">            <span class="comment"># --------------------------------------------------------------------------#</span></span><br><span class="line">            self.split_conv0 = BasicConv(out_channels, out_channels, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">            <span class="comment">#   主干部分会对num_blocks进行循环，循环内部是残差结构。</span></span><br><span class="line">            <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">            self.split_conv1 = BasicConv(out_channels, out_channels, <span class="number">1</span>)</span><br><span class="line">            self.blocks_conv = nn.Sequential(</span><br><span class="line">                Resblock(channels=out_channels, hidden_channels=out_channels // <span class="number">2</span>),</span><br><span class="line">                BasicConv(out_channels, out_channels, <span class="number">1</span>)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            self.concat_conv = BasicConv(out_channels * <span class="number">2</span>, out_channels, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># --------------------------------------------------------------------------#</span></span><br><span class="line">            <span class="comment">#   然后建立一个大的残差边self.split_conv0、这个大残差边绕过了很多的残差结构</span></span><br><span class="line">            <span class="comment"># --------------------------------------------------------------------------#</span></span><br><span class="line">            self.split_conv0 = BasicConv(out_channels, out_channels // <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">            <span class="comment">#   主干部分会对num_blocks进行循环，循环内部是残差结构。</span></span><br><span class="line">            <span class="comment"># ----------------------------------------------------------------#</span></span><br><span class="line">            self.split_conv1 = BasicConv(out_channels, out_channels // <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">            self.blocks_conv = nn.Sequential(</span><br><span class="line">                *[Resblock(out_channels // <span class="number">2</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_blocks)],</span><br><span class="line">                BasicConv(out_channels // <span class="number">2</span>, out_channels // <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            self.concat_conv = BasicConv(out_channels, out_channels, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.downsample_conv(x)</span><br><span class="line"></span><br><span class="line">        x0 = self.split_conv0(x)</span><br><span class="line"></span><br><span class="line">        x1 = self.split_conv1(x)</span><br><span class="line">        x1 = self.blocks_conv(x1)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ------------------------------------#</span></span><br><span class="line">        <span class="comment">#   将大残差边再堆叠回来</span></span><br><span class="line">        <span class="comment"># ------------------------------------#</span></span><br><span class="line">        x = torch.cat([x1, x0], dim=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># ------------------------------------#</span></span><br><span class="line">        <span class="comment">#   最后对通道数进行整合</span></span><br><span class="line">        <span class="comment"># ------------------------------------#</span></span><br><span class="line">        x = self.concat_conv(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># CSPdarknet53</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CSPDarkNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, layers</span>):</span><br><span class="line">        <span class="built_in">super</span>(CSPDarkNet, self).__init__()</span><br><span class="line">        self.inplanes = <span class="number">32</span></span><br><span class="line">        <span class="comment"># 416,416,3 -&gt; 416,416,32</span></span><br><span class="line">        self.conv1 = BasicConv(<span class="number">3</span>, self.inplanes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>)</span><br><span class="line">        self.feature_channels = [<span class="number">64</span>, <span class="number">128</span>, <span class="number">256</span>, <span class="number">512</span>, <span class="number">1024</span>]</span><br><span class="line"></span><br><span class="line">        self.stages = nn.ModuleList([</span><br><span class="line">            <span class="comment"># 416,416,32 -&gt; 208,208,64</span></span><br><span class="line">            Resblock_body(self.inplanes, self.feature_channels[<span class="number">0</span>], layers[<span class="number">0</span>], first=<span class="literal">True</span>),</span><br><span class="line">            <span class="comment"># 208,208,64 -&gt; 104,104,128</span></span><br><span class="line">            Resblock_body(self.feature_channels[<span class="number">0</span>], self.feature_channels[<span class="number">1</span>], layers[<span class="number">1</span>], first=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># 104,104,128 -&gt; 52,52,256</span></span><br><span class="line">            Resblock_body(self.feature_channels[<span class="number">1</span>], self.feature_channels[<span class="number">2</span>], layers[<span class="number">2</span>], first=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># 52,52,256 -&gt; 26,26,512</span></span><br><span class="line">            Resblock_body(self.feature_channels[<span class="number">2</span>], self.feature_channels[<span class="number">3</span>], layers[<span class="number">3</span>], first=<span class="literal">False</span>),</span><br><span class="line">            <span class="comment"># 26,26,512 -&gt; 13,13,1024</span></span><br><span class="line">            Resblock_body(self.feature_channels[<span class="number">3</span>], self.feature_channels[<span class="number">4</span>], layers[<span class="number">4</span>], first=<span class="literal">False</span>)</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        self.num_features = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                n = m.kernel_size[<span class="number">0</span>] * m.kernel_size[<span class="number">1</span>] * m.out_channels</span><br><span class="line">                m.weight.data.normal_(<span class="number">0</span>, math.sqrt(<span class="number">2.</span> / n))</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.BatchNorm2d):</span><br><span class="line">                m.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv1(x)</span><br><span class="line"></span><br><span class="line">        x = self.stages[<span class="number">0</span>](x)</span><br><span class="line">        x = self.stages[<span class="number">1</span>](x)</span><br><span class="line">        out3 = self.stages[<span class="number">2</span>](x)</span><br><span class="line">        out4 = self.stages[<span class="number">3</span>](out3)</span><br><span class="line">        out5 = self.stages[<span class="number">4</span>](out4)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out3, out4, out5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">darknet53</span>(<span class="params">pretrained</span>):</span><br><span class="line">    model = CSPDarkNet([<span class="number">1</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">4</span>])</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(pretrained, <span class="built_in">str</span>):</span><br><span class="line">            model.load_state_dict(torch.load(pretrained))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;darknet request a pretrained path. got [&#123;&#125;]&quot;</span>.<span class="built_in">format</span>(pretrained))</span><br><span class="line">    <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>

<p>然后再实现yolov4的框架，包括上图中的SPP和PANet，最后输出三个特征层Yolo head。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> nets.CSPdarknet <span class="keyword">import</span> darknet53</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv2d</span>(<span class="params">filter_in, filter_out, kernel_size, stride=<span class="number">1</span></span>):</span><br><span class="line">    pad = (kernel_size - <span class="number">1</span>) // <span class="number">2</span> <span class="keyword">if</span> kernel_size <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(OrderedDict([</span><br><span class="line">        (<span class="string">&quot;conv&quot;</span>, nn.Conv2d(filter_in, filter_out, kernel_size=kernel_size, stride=stride, padding=pad, bias=<span class="literal">False</span>)),</span><br><span class="line">        (<span class="string">&quot;bn&quot;</span>, nn.BatchNorm2d(filter_out)),</span><br><span class="line">        (<span class="string">&quot;relu&quot;</span>, nn.LeakyReLU(<span class="number">0.1</span>)),</span><br><span class="line">    ]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPP结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpatialPyramidPooling</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, pool_sizes=[<span class="number">5</span>, <span class="number">9</span>, <span class="number">13</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>(SpatialPyramidPooling, self).__init__()</span><br><span class="line"></span><br><span class="line">        self.maxpools = nn.ModuleList([nn.MaxPool2d(pool_size, <span class="number">1</span>, pool_size // <span class="number">2</span>) <span class="keyword">for</span> pool_size <span class="keyword">in</span> pool_sizes])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        features = [maxpool(x) <span class="keyword">for</span> maxpool <span class="keyword">in</span> self.maxpools[::-<span class="number">1</span>]]</span><br><span class="line">        features = torch.cat(features + [x], dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卷积 + 上采样</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Upsample</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels, out_channels</span>):</span><br><span class="line">        <span class="built_in">super</span>(Upsample, self).__init__()</span><br><span class="line"></span><br><span class="line">        self.upsample = nn.Sequential(</span><br><span class="line">            conv2d(in_channels, out_channels, <span class="number">1</span>),</span><br><span class="line">            nn.Upsample(scale_factor=<span class="number">2</span>, mode=<span class="string">&#x27;nearest&#x27;</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, </span>):</span><br><span class="line">        x = self.upsample(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 三次卷积块</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_three_conv</span>(<span class="params">filters_list, in_filters</span>):</span><br><span class="line">    m = nn.Sequential(</span><br><span class="line">        conv2d(in_filters, filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">0</span>], filters_list[<span class="number">1</span>], <span class="number">3</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">1</span>], filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 五次卷积块</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_five_conv</span>(<span class="params">filters_list, in_filters</span>):</span><br><span class="line">    m = nn.Sequential(</span><br><span class="line">        conv2d(in_filters, filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">0</span>], filters_list[<span class="number">1</span>], <span class="number">3</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">1</span>], filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">0</span>], filters_list[<span class="number">1</span>], <span class="number">3</span>),</span><br><span class="line">        conv2d(filters_list[<span class="number">1</span>], filters_list[<span class="number">0</span>], <span class="number">1</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># yolov4的输出</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">yolo_head</span>(<span class="params">filters_list, in_filters</span>):</span><br><span class="line">    m = nn.Sequential(</span><br><span class="line">        conv2d(in_filters, filters_list[<span class="number">0</span>], <span class="number">3</span>),</span><br><span class="line">        nn.Conv2d(filters_list[<span class="number">0</span>], filters_list[<span class="number">1</span>], <span class="number">1</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># yolo_body</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">YoloBody</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_anchors, num_classes</span>):</span><br><span class="line">        <span class="built_in">super</span>(YoloBody, self).__init__()</span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   生成CSPdarknet53的主干模型</span></span><br><span class="line">        <span class="comment">#   获得三个有效特征层，他们的shape分别是：</span></span><br><span class="line">        <span class="comment">#   52,52,256</span></span><br><span class="line">        <span class="comment">#   26,26,512</span></span><br><span class="line">        <span class="comment">#   13,13,1024</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        self.backbone = darknet53(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        self.conv1 = make_three_conv([<span class="number">512</span>, <span class="number">1024</span>], <span class="number">1024</span>)</span><br><span class="line">        self.SPP = SpatialPyramidPooling()</span><br><span class="line">        self.conv2 = make_three_conv([<span class="number">512</span>, <span class="number">1024</span>], <span class="number">2048</span>)</span><br><span class="line"></span><br><span class="line">        self.upsample1 = Upsample(<span class="number">512</span>, <span class="number">256</span>)</span><br><span class="line">        self.conv_for_P4 = conv2d(<span class="number">512</span>, <span class="number">256</span>, <span class="number">1</span>)</span><br><span class="line">        self.make_five_conv1 = make_five_conv([<span class="number">256</span>, <span class="number">512</span>], <span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">        self.upsample2 = Upsample(<span class="number">256</span>, <span class="number">128</span>)</span><br><span class="line">        self.conv_for_P3 = conv2d(<span class="number">256</span>, <span class="number">128</span>, <span class="number">1</span>)</span><br><span class="line">        self.make_five_conv2 = make_five_conv([<span class="number">128</span>, <span class="number">256</span>], <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3*(5+num_classes) = 3*(5+20) = 3*(4+1+20)=75</span></span><br><span class="line">        final_out_filter2 = num_anchors * (<span class="number">5</span> + num_classes)</span><br><span class="line">        self.yolo_head3 = yolo_head([<span class="number">256</span>, final_out_filter2], <span class="number">128</span>)</span><br><span class="line"></span><br><span class="line">        self.down_sample1 = conv2d(<span class="number">128</span>, <span class="number">256</span>, <span class="number">3</span>, stride=<span class="number">2</span>)</span><br><span class="line">        self.make_five_conv3 = make_five_conv([<span class="number">256</span>, <span class="number">512</span>], <span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3*(5+num_classes) = 3*(5+20) = 3*(4+1+20)=75</span></span><br><span class="line">        final_out_filter1 = num_anchors * (<span class="number">5</span> + num_classes)</span><br><span class="line">        self.yolo_head2 = yolo_head([<span class="number">512</span>, final_out_filter1], <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">        self.down_sample2 = conv2d(<span class="number">256</span>, <span class="number">512</span>, <span class="number">3</span>, stride=<span class="number">2</span>)</span><br><span class="line">        self.make_five_conv4 = make_five_conv([<span class="number">512</span>, <span class="number">1024</span>], <span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3*(5+num_classes)=3*(5+20)=3*(4+1+20)=75</span></span><br><span class="line">        final_out_filter0 = num_anchors * (<span class="number">5</span> + num_classes)</span><br><span class="line">        self.yolo_head1 = yolo_head([<span class="number">1024</span>, final_out_filter0], <span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment">#  backbone</span></span><br><span class="line">        x2, x1, x0 = self.backbone(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 13,13,1024 -&gt; 13,13,512 -&gt; 13,13,1024 -&gt; 13,13,512 -&gt; 13,13,2048 </span></span><br><span class="line">        P5 = self.conv1(x0)</span><br><span class="line">        P5 = self.SPP(P5)</span><br><span class="line">        <span class="comment"># 13,13,2048 -&gt; 13,13,512 -&gt; 13,13,1024 -&gt; 13,13,512</span></span><br><span class="line">        P5 = self.conv2(P5)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 13,13,512 -&gt; 13,13,256 -&gt; 26,26,256</span></span><br><span class="line">        P5_upsample = self.upsample1(P5)</span><br><span class="line">        <span class="comment"># 26,26,512 -&gt; 26,26,256</span></span><br><span class="line">        P4 = self.conv_for_P4(x1)</span><br><span class="line">        <span class="comment"># 26,26,256 + 26,26,256 -&gt; 26,26,512</span></span><br><span class="line">        P4 = torch.cat([P4, P5_upsample], axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 26,26,512 -&gt; 26,26,256 -&gt; 26,26,512 -&gt; 26,26,256 -&gt; 26,26,512 -&gt; 26,26,256</span></span><br><span class="line">        P4 = self.make_five_conv1(P4)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 26,26,256 -&gt; 26,26,128 -&gt; 52,52,128</span></span><br><span class="line">        P4_upsample = self.upsample2(P4)</span><br><span class="line">        <span class="comment"># 52,52,256 -&gt; 52,52,128</span></span><br><span class="line">        P3 = self.conv_for_P3(x2)</span><br><span class="line">        <span class="comment"># 52,52,128 + 52,52,128 -&gt; 52,52,256</span></span><br><span class="line">        P3 = torch.cat([P3, P4_upsample], axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 52,52,256 -&gt; 52,52,128 -&gt; 52,52,256 -&gt; 52,52,128 -&gt; 52,52,256 -&gt; 52,52,128</span></span><br><span class="line">        P3 = self.make_five_conv2(P3)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 52,52,128 -&gt; 26,26,256</span></span><br><span class="line">        P3_downsample = self.down_sample1(P3)</span><br><span class="line">        <span class="comment"># 26,26,256 + 26,26,256 -&gt; 26,26,512</span></span><br><span class="line">        P4 = torch.cat([P3_downsample, P4], axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 26,26,512 -&gt; 26,26,256 -&gt; 26,26,512 -&gt; 26,26,256 -&gt; 26,26,512 -&gt; 26,26,256</span></span><br><span class="line">        P4 = self.make_five_conv3(P4)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 26,26,256 -&gt; 13,13,512</span></span><br><span class="line">        P4_downsample = self.down_sample2(P4)</span><br><span class="line">        <span class="comment"># 13,13,512 + 13,13,512 -&gt; 13,13,1024</span></span><br><span class="line">        P5 = torch.cat([P4_downsample, P5], axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 13,13,1024 -&gt; 13,13,512 -&gt; 13,13,1024 -&gt; 13,13,512 -&gt; 13,13,1024 -&gt; 13,13,512</span></span><br><span class="line">        P5 = self.make_five_conv4(P5)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   第三个特征层</span></span><br><span class="line">        <span class="comment">#   y3=(batch_size,75,52,52)</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        out2 = self.yolo_head3(P3)</span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   第二个特征层</span></span><br><span class="line">        <span class="comment">#   y2=(batch_size,75,26,26)</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        out1 = self.yolo_head2(P4)</span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        <span class="comment">#   第一个特征层</span></span><br><span class="line">        <span class="comment">#   y1=(batch_size,75,13,13)</span></span><br><span class="line">        <span class="comment"># ---------------------------------------------------#</span></span><br><span class="line">        out0 = self.yolo_head1(P5)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out0, out1, out2</span><br></pre></td></tr></table></figure>

<p>搭建完成之后就是训练了。</p>
<p>训练采用的是实验室的TITAN RTX，这里我们小组总共找了将近1900张图片，然后手动打标签，不得不说那一周看虫子都快看吐了。</p>
<p><img src="https://i.imgtg.com/2023/03/20/91pvg.jpg" alt="91pvg.jpg"></p>
<p><img src="https://i.imgtg.com/2023/03/20/91e7I.jpg" alt="91e7I.jpg"></p>
<p>最后通过脚本扫描所有的图片，将对应的xml标记文件对应。</p>
<p><img src="https://i.imgtg.com/2023/03/20/91rLD.jpg" alt="91rLD.jpg"></p>
<p>然后开始训练</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">start_train</span>(<span class="params">queue=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">global</span> model, __iterationCount</span><br><span class="line">    __iterationCount = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># classes和anchor的路径</span></span><br><span class="line">    anchors_path = <span class="string">&#x27;model_data/yolo_anchors.txt&#x27;</span></span><br><span class="line">    classes_path = <span class="string">&#x27;model_data/all_classes.txt&#x27;</span></span><br><span class="line">    <span class="comment"># 获取classes和anchor</span></span><br><span class="line">    class_names = get_classes(classes_path)</span><br><span class="line">    anchors = get_anchors(anchors_path)</span><br><span class="line">    num_classes = <span class="built_in">len</span>(class_names)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建yolo模型</span></span><br><span class="line">    model = YoloBody(<span class="built_in">len</span>(anchors[<span class="number">0</span>]), num_classes)</span><br><span class="line"></span><br><span class="line">    model_path = <span class="string">&quot;model_data/yolo4_weights.pth&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Loading weights into state dict...&#x27;</span>)</span><br><span class="line">    device = torch.device(<span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(model_path):</span><br><span class="line">        model_dict = model.state_dict()</span><br><span class="line">        pretrained_dict = torch.load(model_path, map_location=device)</span><br><span class="line">        pretrained_dict = &#123;k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> pretrained_dict.items() <span class="keyword">if</span> np.shape(model_dict[k]) == np.shape(v)&#125;</span><br><span class="line">        model_dict.update(pretrained_dict)</span><br><span class="line">        model.load_state_dict(model_dict)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Finished!&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;error no pretrained model&quot;</span>)</span><br><span class="line"></span><br><span class="line">    net = model.train()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Cuda:</span><br><span class="line">        net = torch.nn.DataParallel(model)</span><br><span class="line">        cudnn.benchmark = <span class="literal">True</span></span><br><span class="line">        net = net.cuda()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 建立loss函数</span></span><br><span class="line">    yolo_losses = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        yolo_losses.append(YOLOLoss(np.reshape(anchors, [-<span class="number">1</span>, <span class="number">2</span>]), num_classes,</span><br><span class="line">                                    (input_shape[<span class="number">1</span>], input_shape[<span class="number">0</span>]), smooth_label, Cuda, normalize))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获得图片路径和标签</span></span><br><span class="line">    annotation_path = <span class="string">&#x27;2007_train.txt&#x27;</span></span><br><span class="line">    val_split = <span class="number">0.1</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(annotation_path, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">    np.random.seed(<span class="number">10101</span>)</span><br><span class="line">    np.random.shuffle(lines)</span><br><span class="line">    np.random.seed(<span class="literal">None</span>)</span><br><span class="line">    num_val = <span class="built_in">int</span>(<span class="built_in">len</span>(lines) * val_split)</span><br><span class="line">    num_train = <span class="built_in">len</span>(lines) - num_val</span><br><span class="line"></span><br><span class="line">    Init_Epoch = <span class="number">0</span></span><br><span class="line">    Freeze_Epoch = <span class="number">200</span></span><br><span class="line">    Unfreeze_Epoch = <span class="number">300</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 冻结训练部分</span></span><br><span class="line">    lr = <span class="number">1e-3</span></span><br><span class="line">    Batch_size = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> optimizer</span><br><span class="line">    optimizer = optim.Adam(net.parameters(), lr)</span><br><span class="line">    <span class="keyword">if</span> Cosine_lr:</span><br><span class="line">        lr_scheduler = optim.lr_scheduler.CosineAnnealingLR(optimizer, T_max=<span class="number">5</span>, eta_min=<span class="number">1e-5</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lr_scheduler = optim.lr_scheduler.StepLR(optimizer, step_size=<span class="number">1</span>, gamma=<span class="number">0.92</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Use_Data_Loader:</span><br><span class="line">        train_dataset = YoloDataset(lines[:num_train], (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>]), mosaic=mosaic,</span><br><span class="line">                                    is_train=<span class="literal">True</span>)</span><br><span class="line">        val_dataset = YoloDataset(lines[num_train:], (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>]), mosaic=<span class="literal">False</span>, is_train=<span class="literal">False</span>)</span><br><span class="line">        gen = DataLoader(train_dataset, shuffle=<span class="literal">True</span>, batch_size=Batch_size, num_workers=<span class="number">4</span>, pin_memory=<span class="literal">True</span>,</span><br><span class="line">                         drop_last=<span class="literal">True</span>, collate_fn=yolo_dataset_collate)</span><br><span class="line">        gen_val = DataLoader(val_dataset, shuffle=<span class="literal">True</span>, batch_size=Batch_size, num_workers=<span class="number">4</span>, pin_memory=<span class="literal">True</span>,</span><br><span class="line">                             drop_last=<span class="literal">True</span>, collate_fn=yolo_dataset_collate)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gen = Generator(Batch_size, lines[:num_train],</span><br><span class="line">                        (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>])).generate(train=<span class="literal">True</span>, mosaic=mosaic)</span><br><span class="line">        gen_val = Generator(Batch_size, lines[num_train:],</span><br><span class="line">                            (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>])).generate(train=<span class="literal">False</span>, mosaic=mosaic)</span><br><span class="line"></span><br><span class="line">    epoch_size = <span class="built_in">max</span>(<span class="number">1</span>, num_train // Batch_size)</span><br><span class="line">    epoch_size_val = num_val // Batch_size</span><br><span class="line">    <span class="comment"># 冻结训练</span></span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> model.backbone.parameters():</span><br><span class="line">        param.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(Init_Epoch, Freeze_Epoch):</span><br><span class="line">        fit_one_epoch(net, yolo_losses, epoch, epoch_size, epoch_size_val, gen, gen_val, Freeze_Epoch, Cuda,</span><br><span class="line">                      queue=queue)</span><br><span class="line">        lr_scheduler.step()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解冻训练</span></span><br><span class="line">    lr = <span class="number">1e-4</span></span><br><span class="line">    Batch_size = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    optimizer = optim.Adam(net.parameters(), lr)</span><br><span class="line">    <span class="keyword">if</span> Cosine_lr:</span><br><span class="line">        lr_scheduler = optim.lr_scheduler.CosineAnnealingLR(optimizer, T_max=<span class="number">5</span>, eta_min=<span class="number">1e-5</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lr_scheduler = optim.lr_scheduler.StepLR(optimizer, step_size=<span class="number">1</span>, gamma=<span class="number">0.92</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Use_Data_Loader:</span><br><span class="line">        train_dataset = YoloDataset(lines[:num_train], (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>]), mosaic=mosaic,</span><br><span class="line">                                    is_train=<span class="literal">True</span>)</span><br><span class="line">        val_dataset = YoloDataset(lines[num_train:], (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>]), mosaic=<span class="literal">False</span>, is_train=<span class="literal">False</span>)</span><br><span class="line">        gen = DataLoader(train_dataset, shuffle=<span class="literal">True</span>, batch_size=Batch_size, num_workers=<span class="number">4</span>, pin_memory=<span class="literal">True</span>,</span><br><span class="line">                         drop_last=<span class="literal">True</span>, collate_fn=yolo_dataset_collate)</span><br><span class="line">        gen_val = DataLoader(val_dataset, shuffle=<span class="literal">True</span>, batch_size=Batch_size, num_workers=<span class="number">4</span>, pin_memory=<span class="literal">True</span>,</span><br><span class="line">                             drop_last=<span class="literal">True</span>, collate_fn=yolo_dataset_collate)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gen = Generator(Batch_size, lines[:num_train],</span><br><span class="line">                        (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>])).generate(train=<span class="literal">True</span>, mosaic=mosaic)</span><br><span class="line">        gen_val = Generator(Batch_size, lines[num_train:],</span><br><span class="line">                            (input_shape[<span class="number">0</span>], input_shape[<span class="number">1</span>])).generate(train=<span class="literal">False</span>, mosaic=mosaic)</span><br><span class="line"></span><br><span class="line">    epoch_size = <span class="built_in">max</span>(<span class="number">1</span>, num_train // Batch_size)</span><br><span class="line">    epoch_size_val = num_val // Batch_size</span><br><span class="line">    <span class="comment"># 解冻后训练</span></span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> model.backbone.parameters():</span><br><span class="line">        param.requires_grad = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(Freeze_Epoch, Unfreeze_Epoch):</span><br><span class="line">        fit_one_epoch(net, yolo_losses, epoch, epoch_size, epoch_size_val, gen, gen_val, Unfreeze_Epoch, Cuda,</span><br><span class="line">                      queue=queue)</span><br><span class="line">        lr_scheduler.step()</span><br></pre></td></tr></table></figure>

<p>最后训练出来的效果还是很不错的。</p>
<p><img src="https://i.imgtg.com/2023/03/20/91y9b.png" alt="91y9b.png"></p>
<p><img src="https://i.imgtg.com/2023/03/20/91vPP.png" alt="91vPP.png"></p>
<h2 id="YoloV5网络"><a href="#YoloV5网络" class="headerlink" title="YoloV5网络"></a>YoloV5网络</h2><p> 前面说到了由于YoloV4过于庞大，无法放到安卓app中，于是我们小组还开发了YoloV5的版本。</p>
<p><img src="https://i.328888.xyz/2023/04/03/iOyPCc.png" alt="iOyPCc.png"></p>
<p>模型也是使用pytorch实现。这里就不再赘述。</p>
<p>训练过程基本和上面差不多，使用相同的训练集，训练完成后获取模型即可。</p>
<p>比较值得记录的是如何放到安卓app上。</p>
<h2 id="Android-APP"><a href="#Android-APP" class="headerlink" title="Android APP"></a>Android APP</h2><p>安卓客户端基础功能采用vue-cli开发，制作为h5小程序，由于pytorch在安卓端必须采用Android studio引入，所以不能直接使用vue打包成apk。</p>
<p>因此我们小组采用capacitorJS将vue app项目转换成原生代码项目，再使用pytorch原生库加载离线识别模型文件，使用NanoHTTPD实现在本地模拟在线api，采用sqlite和okhttpClient定期同步远程数据库。</p>
<p>在安卓客户端拍图片之后，将会先被编码为base64，然后再上传至YoloV4网络，获取结果之后再显示。</p>
<p>在build.gradle中引入pytorch</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dependencies <span class="punctuation">&#123;</span></span><br><span class="line">    implementation fileTree(include<span class="punctuation">:</span> <span class="punctuation">[</span>&#x27;*.jar&#x27;<span class="punctuation">]</span><span class="punctuation">,</span> dir<span class="punctuation">:</span> &#x27;libs&#x27;)</span><br><span class="line">    implementation <span class="string">&quot;androidx.appcompat:appcompat:$androidxAppCompatVersion&quot;</span></span><br><span class="line">    implementation project(&#x27;<span class="punctuation">:</span>capacitor-android&#x27;)</span><br><span class="line">    testImplementation <span class="string">&quot;junit:junit:$junitVersion&quot;</span></span><br><span class="line">    androidTestImplementation <span class="string">&quot;androidx.test.ext:junit:$androidxJunitVersion&quot;</span></span><br><span class="line">    androidTestImplementation <span class="string">&quot;androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion&quot;</span></span><br><span class="line">    implementation project(&#x27;<span class="punctuation">:</span>capacitor-cordova-android-plugins&#x27;)</span><br><span class="line">    implementation&#x27;org.nanohttpd<span class="punctuation">:</span>nanohttpd<span class="punctuation">:</span><span class="number">2.3</span><span class="number">.1</span>&#x27;</span><br><span class="line">    implementation&#x27;com.alibaba<span class="punctuation">:</span>fastjson<span class="punctuation">:</span><span class="number">1.1</span><span class="number">.72</span>.android&#x27;</span><br><span class="line">    implementation&#x27;com.squareup.okhttp3<span class="punctuation">:</span>okhttp<span class="punctuation">:</span><span class="number">3.10</span><span class="number">.0</span>&#x27;</span><br><span class="line">    implementation &#x27;org.pytorch<span class="punctuation">:</span>pytorch_android<span class="punctuation">:</span><span class="number">1.8</span><span class="number">.0</span>&#x27;</span><br><span class="line">    implementation &#x27;org.pytorch<span class="punctuation">:</span>pytorch_android_torchvision<span class="punctuation">:</span><span class="number">1.8</span><span class="number">.0</span>&#x27;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后把训练好的YoloV5模型放入assets文件夹中，在app打开后进行加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载网络模型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> assetManager assets读取工具</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> moduleName Torchscript文件名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(AssetManager assetManager, String moduleName)</span> &#123;</span><br><span class="line">    <span class="keyword">module</span> = PyTorchAndroid.loadModuleFromAsset(assetManager, moduleName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后实现predict函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输入图片，输出预测信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bitmap 输入图片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> processedImg 处理后的图片,Object[1] 需要放到数组中，否则局部变量无法获取</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 预测信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Integer&gt; <span class="title function_">predict</span><span class="params">(Bitmap bitmap, Object[] processedImg)</span> &#123;</span><br><span class="line">    HashMap&lt;String, Integer&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// preparing input tensor</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Tensor</span> <span class="variable">inputTensor</span> <span class="operator">=</span> TensorImageUtils.bitmapToFloat32Tensor(bitmap,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">float</span>[]&#123;<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>&#125;, <span class="keyword">new</span> <span class="title class_">float</span>[]&#123;<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// running the model</span></span><br><span class="line">    <span class="type">IValue</span> <span class="variable">value</span> <span class="operator">=</span> IValue.from(inputTensor);</span><br><span class="line">    <span class="keyword">final</span> IValue[] output = <span class="keyword">module</span>.forward(value).toTuple();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Tensor</span> <span class="variable">outputTensor</span> <span class="operator">=</span> output[<span class="number">0</span>].toTensor();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">float</span>[] outputs = outputTensor.getDataAsFloatArray();</span><br><span class="line">    <span class="type">float</span> <span class="variable">mImgScaleX</span> <span class="operator">=</span> bitmap.getWidth() / imageSize;</span><br><span class="line">    <span class="type">float</span> <span class="variable">mImgScaleY</span> <span class="operator">=</span> bitmap.getHeight() / imageSize;</span><br><span class="line">    <span class="type">float</span> <span class="variable">mIvScaleX</span> <span class="operator">=</span> (bitmap.getWidth() &gt; bitmap.getHeight() ? imageSize / bitmap.getWidth() : imageSize / bitmap.getHeight());</span><br><span class="line">    <span class="type">float</span> <span class="variable">mIvScaleY</span> <span class="operator">=</span> (bitmap.getHeight() &gt; bitmap.getWidth() ? imageSize / bitmap.getHeight() : imageSize / bitmap.getWidth());</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;Result&gt; results = outputsToNMSPredictions(outputs, mImgScaleX, mImgScaleY, mIvScaleX, mIvScaleY);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasRect</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (Result each : results) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Classes.classes[each.classIndex];</span><br><span class="line">        <span class="keyword">if</span> (resultMap.containsKey(code)) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> resultMap.get(code);</span><br><span class="line">            num += <span class="number">1</span>;</span><br><span class="line">            resultMap.put(code, num);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resultMap.put(code, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (each.rect.top != each.rect.bottom &amp;&amp; each.rect.left != each.rect.right) &#123;</span><br><span class="line">            bitmap = drawRectangles(bitmap, each.rect);</span><br><span class="line">            processedImg[<span class="number">0</span>] = bitmap;</span><br><span class="line">            hasRect = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!hasRect) &#123;</span><br><span class="line">            processedImg[<span class="number">0</span>] = bitmap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resultMap.isEmpty()) &#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;error&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(resultMap);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及在识别后的图片上画框的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在bitmap上画框</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> imageBitmap 输入图片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> valueRects 框的位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 画了框的图片</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Bitmap <span class="title function_">drawRectangles</span><span class="params">(Bitmap imageBitmap, Rect valueRects)</span> &#123;</span><br><span class="line">    <span class="type">Bitmap</span> <span class="variable">mutableBitmap</span> <span class="operator">=</span> imageBitmap.copy(Bitmap.Config.ARGB_8888, <span class="literal">true</span>);</span><br><span class="line">    <span class="type">Canvas</span> <span class="variable">canvas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Canvas</span>(mutableBitmap);</span><br><span class="line">    <span class="type">Paint</span> <span class="variable">paint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        paint.setColor(Color.RED);</span><br><span class="line">        paint.setStyle(Paint.Style.STROKE);<span class="comment">//不填充</span></span><br><span class="line">        paint.setStrokeWidth(<span class="number">10</span>);  <span class="comment">//线的宽度</span></span><br><span class="line">        canvas.drawRect(valueRects.left, valueRects.top, valueRects.right, valueRects.bottom, paint);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mutableBitmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及nms函数，和非极大抑制函数，计算IOU的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对原始输出进行处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> outputs 输出</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> imgScaleX 相对图片大小X</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> imgScaleY 相对图片大小Y</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ivScaleX 显示最小图片大小X</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ivScaleY 显示最小图片大小Y</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Result list</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;Result&gt; <span class="title function_">outputsToNMSPredictions</span><span class="params">(<span class="type">float</span>[] outputs, <span class="type">float</span> imgScaleX, <span class="type">float</span> imgScaleY, <span class="type">float</span> ivScaleX, <span class="type">float</span> ivScaleY)</span> &#123;</span><br><span class="line">    ArrayList&lt;Result&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span> <span class="variable">mOutputRow</span> <span class="operator">=</span> <span class="number">25200</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">mOutputColumn</span> <span class="operator">=</span> Classes.classes.length + <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mOutputRow; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (outputs[i * mOutputColumn + <span class="number">4</span>] &gt; mThreshold) &#123;</span><br><span class="line">                <span class="type">float</span> <span class="variable">x</span> <span class="operator">=</span> outputs[i * mOutputColumn];</span><br><span class="line">                <span class="type">float</span> <span class="variable">y</span> <span class="operator">=</span> outputs[i * mOutputColumn + <span class="number">1</span>];</span><br><span class="line">                <span class="type">float</span> <span class="variable">w</span> <span class="operator">=</span> outputs[i * mOutputColumn + <span class="number">2</span>];</span><br><span class="line">                <span class="type">float</span> <span class="variable">h</span> <span class="operator">=</span> outputs[i * mOutputColumn + <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">                <span class="type">float</span> <span class="variable">left</span> <span class="operator">=</span> imgScaleX * (x - w / <span class="number">2</span>);</span><br><span class="line">                <span class="type">float</span> <span class="variable">top</span> <span class="operator">=</span> imgScaleY * (y - h / <span class="number">2</span>);</span><br><span class="line">                <span class="type">float</span> <span class="variable">right</span> <span class="operator">=</span> imgScaleX * (x + w / <span class="number">2</span>);</span><br><span class="line">                <span class="type">float</span> <span class="variable">bottom</span> <span class="operator">=</span> imgScaleY * (y + h / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">float</span> <span class="variable">max</span> <span class="operator">=</span> outputs[i * mOutputColumn + <span class="number">5</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">cls</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; mOutputColumn - <span class="number">5</span>; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (outputs[i * mOutputColumn + <span class="number">5</span> + j] &gt; max) &#123;</span><br><span class="line">                        max = outputs[i * mOutputColumn + <span class="number">5</span> + j];</span><br><span class="line">                        cls = j;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">Rect</span> <span class="variable">rect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rect</span>((<span class="type">int</span>) ((<span class="type">float</span>) <span class="number">0</span> + ivScaleX * left), (<span class="type">int</span>) ((<span class="type">float</span>) <span class="number">0</span> + top * ivScaleY), (<span class="type">int</span>) ((<span class="type">float</span>) <span class="number">0</span> + ivScaleX * right), (<span class="type">int</span>) ((<span class="type">float</span>) <span class="number">0</span> + ivScaleY * bottom));</span><br><span class="line">                <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>(cls, outputs[i * mOutputColumn + <span class="number">4</span>], rect);</span><br><span class="line">                results.add(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nonMaxSuppression(results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 非极大抑制</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> boxes 结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 筛选后的结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;Result&gt; <span class="title function_">nonMaxSuppression</span><span class="params">(ArrayList&lt;Result&gt; boxes)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Collections.sort(boxes,</span><br><span class="line">            (o1, o2) -&gt; o1.score.compareTo(o2.score));</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;Result&gt; selected = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">boolean</span>[] active = <span class="keyword">new</span> <span class="title class_">boolean</span>[boxes.size()];</span><br><span class="line">    Arrays.fill(active, <span class="literal">true</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">numActive</span> <span class="operator">=</span> active.length;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">done</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; boxes.size() &amp;&amp; !done; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (active[i]) &#123;</span><br><span class="line">            <span class="type">Result</span> <span class="variable">boxA</span> <span class="operator">=</span> boxes.get(i);</span><br><span class="line">            selected.add(boxA);</span><br><span class="line">            <span class="keyword">if</span> (selected.size() &gt;= CnnApi.mNmsLimit) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + <span class="number">1</span>; j &lt; boxes.size(); j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (active[j]) &#123;</span><br><span class="line">                    <span class="type">Result</span> <span class="variable">boxB</span> <span class="operator">=</span> boxes.get(j);</span><br><span class="line">                    <span class="keyword">if</span> (IOU(boxA.rect, boxB.rect) &gt; CnnApi.mThreshold) &#123;</span><br><span class="line">                        active[j] = <span class="literal">false</span>;</span><br><span class="line">                        numActive -= <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">if</span> (numActive &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            done = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> selected;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">float</span> <span class="title function_">IOU</span><span class="params">(Rect a, Rect b)</span> &#123;</span><br><span class="line">    <span class="type">float</span> <span class="variable">areaA</span> <span class="operator">=</span> (a.right - a.left) * (a.bottom - a.top);</span><br><span class="line">    <span class="keyword">if</span> (areaA &lt;= <span class="number">0.0</span>) <span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="variable">areaB</span> <span class="operator">=</span> (b.right - b.left) * (b.bottom - b.top);</span><br><span class="line">    <span class="keyword">if</span> (areaB &lt;= <span class="number">0.0</span>) <span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionMinX</span> <span class="operator">=</span> Math.max(a.left, b.left);</span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionMinY</span> <span class="operator">=</span> Math.max(a.top, b.top);</span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionMaxX</span> <span class="operator">=</span> Math.min(a.right, b.right);</span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionMaxY</span> <span class="operator">=</span> Math.min(a.bottom, b.bottom);</span><br><span class="line">    <span class="type">float</span> <span class="variable">intersectionArea</span> <span class="operator">=</span> Math.max(intersectionMaxY - intersectionMinY, <span class="number">0</span>) *</span><br><span class="line">            Math.max(intersectionMaxX - intersectionMinX, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> intersectionArea / (areaA + areaB - intersectionArea);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Result</span> &#123;</span><br><span class="line">    <span class="type">int</span> classIndex;</span><br><span class="line">    Float score;</span><br><span class="line">    Rect rect;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Result</span><span class="params">(<span class="type">int</span> cls, Float output, Rect rect)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.classIndex = cls;</span><br><span class="line">        <span class="built_in">this</span>.score = output;</span><br><span class="line">        <span class="built_in">this</span>.rect = rect;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将这个离线识别方法封装成API。</p>
<p>采用NanoHTTPD对外提供接口。这样在无网络的环境下只需要把服务器的ip地址更改为127.0.0.1，即可请求到本地的YoloV5识别网络，并实现离线识别。</p>
<p>最后放几张图片</p>
<p><img src="https://i.imgtg.com/2023/03/20/91tNK.jpg" alt="91tNK.jpg"></p>
<p><img src="https://i.imgtg.com/2023/03/20/914Ea.jpg" alt="914Ea.jpg"></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2022/03/22/java-aqs/" rel="next" title="Java AQS原理以及应用">
      Java AQS原理以及应用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pest-Identification-Provider"><span class="nav-number">1.</span> <span class="nav-text">Pest-Identification-Provider</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pest-Identification-Consumer"><span class="nav-number">2.</span> <span class="nav-text">Pest-Identification-Consumer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pest-Identification-Gateway"><span class="nav-number">3.</span> <span class="nav-text">Pest-Identification-Gateway</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YoloV4%E7%BD%91%E7%BB%9C"><span class="nav-number">4.</span> <span class="nav-text">YoloV4网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YoloV5%E7%BD%91%E7%BB%9C"><span class="nav-number">5.</span> <span class="nav-text">YoloV5网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-APP"><span class="nav-number">6.</span> <span class="nav-text">Android APP</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="xuanxu"
      src="https://i.imgtg.com/2023/03/22/9GMCK.jpg">
  <p class="site-author-name" itemprop="name">xuanxu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xuanxu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
